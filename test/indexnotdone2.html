<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdVault Earnings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src='//libtl.com/sdk.js' data-zone='9661177' data-sdk='show_9661177'></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
<style>
    :root {
      --color-primary: #1A5237;
      --color-secondary: #3B7A57;
      --color-accent: #FFD700;
      --color-success: #28a745;
      --color-logo-blue: #2A64B2;
      --color-logo-green: #4CAF50;
      --color-logo-gold: #FFD700;
      --color-logo-orange: #FFA500;
      --color-logo-light-green: #8BC34A;
      --color-danger: #ef4444;
      --color-warning: #f59e0b;
      --color-light: #f8fafc;
      --color-dark: #1e293b;
      --color-gray: #64748b;
      --color-light-gray: #e2e8f0;
      
      --gradient-primary: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      --radius-full: 9999px;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;   /* Locks the main window */
      overscroll-behavior: none; 
      background-color: #f8fafc;
    }

    .app-container {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    /* ================= HIDE SCROLLBAR COMPLETELY ================= */

/* 1. Universal Hide for Webkit (Chrome/Safari/Edge) */
::-webkit-scrollbar {
    width: 0px;
    height: 0px;
    background: transparent;
    display: none;
}

/* 2. Universal Hide for Firefox & IE */
html, body, * {
    scrollbar-width: none !important; /* Firefox */
    -ms-overflow-style: none !important; /* IE 10+ */
}

/* 3. Ensure content is still scrollable */
body {
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
}
   /* ================= LEGAL MODAL STYLES ================= */

    .legal-overlay {
      position: fixed;
      inset: 0;
      z-index: 12000; /* Higher than everything else */
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .legal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Card Animation & Layout */
    .legal-card {
      background: white;
      width: 100%;
      max-width: 500px;
      height: 85vh;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }

    /* Mobile Adjustment: Slide from bottom */
    @media (max-width: 640px) {
      .legal-overlay {
        align-items: flex-end;
      }
      .legal-card {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        height: 90vh;
        transform: translateY(100%);
      }
    }

    .legal-overlay.show .legal-card {
      transform: translateY(0);
    }

    /* Modal Header */
    .legal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      z-index: 10;
    }
    
    .legal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .close-legal-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f8fafc;
      color: #64748b;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .close-legal-btn:hover { background: #e2e8f0; }

    /* Modal Body */
    .legal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: #ffffff;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
    }
    
    .legal-text h3 {
      font-size: 0.95rem; font-weight: 700; color: #0f172a;
      margin-top: 1.5rem; margin-bottom: 0.5rem;
    }
    .legal-text h3:first-child { margin-top: 0; }
    
    .legal-text p {
      font-size: 0.85rem; color: #475569; line-height: 1.6; margin-bottom: 1rem;
    }
    .legal-text ul {
      list-style-type: disc; padding-left: 1.25rem; margin-bottom: 1rem;
    }
    .legal-text li {
      font-size: 0.85rem; color: #475569; margin-bottom: 0.5rem;
    }

    /* Modal Footer */
    .legal-footer {
      padding: 1.25rem;
      border-top: 1px solid #f1f5f9;
      background: white;
      z-index: 10;
    }
    
    .accept-btn {
      width: 100%;
      background: #0f172a;
      color: white;
      padding: 1rem;
      border-radius: 1rem;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .accept-btn:active { transform: scale(0.98); }
    /* ================= NEW AD OVERLAY STYLES ================= */

    #adOverlay {
        position: fixed;
        inset: 0;
        background: #0f172a; /* Deep Slate */
        z-index: 9999;
        display: none; /* Hidden by default */
        flex-direction: column;
        font-family: 'Inter', sans-serif;
    }

    /* 1. Header */
    .ad-header {
        height: 64px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1.25rem;
        flex-shrink: 0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 50;
    }

    /* Timer Pill */
    .timer-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255,255,255,0.1);
        padding: 0.4rem 1rem;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .timer-spinner {
        width: 16px; height: 16px;
        border: 2px solid rgba(255,255,255,0.2);
        border-top-color: #3b82f6; 
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .timer-text {
        font-size: 0.85rem; font-weight: 600;
        font-variant-numeric: tabular-nums; color: #e2e8f0;
    }
    .timer-text.complete { color: #4ade80; }

    /* Close Button (Locked State) */
    .close-btn-modern {
        width: 36px; height: 36px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.4);
        border: 1px solid rgba(255,255,255,0.1);
        cursor: not-allowed; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative; overflow: hidden;
    }

    /* Close Button (Active State) */
    .close-btn-modern.active {
        background: #10b981; color: white; border-color: #10b981;
        cursor: pointer; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        transform: scale(1.1);
    }
    .close-btn-modern.active:active { transform: scale(0.95); }

    /* 2. Content Area */
    .ad-content-wrapper {
        flex: 1; position: relative; background: #000;
        display: flex; align-items: center; justify-content: center;
        overflow: hidden;
    }

    .ad-iframe { width: 100%; height: 100%; border: none; background: white; }

    /* Smartlink Visuals */
    .verification-overlay {
        position: absolute; inset: 0; background: #f8fafc;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; padding: 2rem; text-align: center; z-index: 10;
    }
    
    .radar-pulse {
        width: 80px; height: 80px; background: #dbeafe;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        color: #2563eb; font-size: 2rem; margin-bottom: 1.5rem; position: relative;
    }
    .radar-pulse::before, .radar-pulse::after {
        content: ''; position: absolute; inset: -20px;
        border: 2px solid #3b82f6; border-radius: 50%; opacity: 0;
        animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    }
    .radar-pulse::after { animation-delay: 1s; }
    
    @keyframes pulse-ring {
        0% { transform: scale(0.5); opacity: 0; }
        50% { opacity: 0.5; }
        100% { transform: scale(1.5); opacity: 0; }
    }

    /* 3. Footer */
    .ad-footer {
        background: #0f172a;
        padding: 1rem 1.25rem 1.5rem 1.25rem;
        border-top: 1px solid rgba(255,255,255,0.1);
        display: flex; flex-direction: column; gap: 0.75rem;
    }

    .status-message {
        text-align: center; font-size: 0.85rem; color: #94a3b8;
        font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }

    .progress-container {
        height: 6px; background: rgba(255,255,255,0.1);
        border-radius: 999px; overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%; width: 0%;
        background: linear-gradient(90deg, #3b82f6, #60a5fa);
        border-radius: 999px; transition: width 1s linear; position: relative;
    }
    .progress-bar-fill::after {
        content: ''; position: absolute; top: 0; right: 0; bottom: 0;
        width: 10px; background: white; opacity: 0.5; filter: blur(4px);
    }
/* ================= EARNING HISTORY STYLES ================= */
    .summary-card-history {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-radius: 1.25rem;
      padding: 1.5rem;
      color: white;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
    }
    .summary-card-history::after {
      content: ''; position: absolute; bottom: -20px; right: -20px;
      width: 100px; height: 100px; border-radius: 50%;
      background: rgba(255,255,255,0.1);
    }
    
    .tab-row { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 5px; }
    .tab-pill {
      padding: 0.5rem 1rem; border-radius: 99px;
      font-size: 0.8rem; font-weight: 600;
      background: white; border: 1px solid #e2e8f0; color: #64748b;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .tab-pill.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }

    .date-header {
      font-size: 0.75rem; font-weight: 700; color: #94a3b8;
      text-transform: uppercase; margin-bottom: 0.75rem; margin-top: 1.5rem;
      display: flex; justify-content: space-between;
    }

    .history-item {
      background: white; border-radius: 1rem; padding: 1rem;
      margin-bottom: 0.75rem; border: 1px solid #f1f5f9;
      display: flex; align-items: center; justify-content: space-between;
      animation: fadeIn 0.3s ease;
    }
    
    .item-icon {
      width: 42px; height: 42px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; margin-right: 1rem; flex-shrink: 0;
    }
    .icon-ad { background: #eff6ff; color: #3b82f6; } 
    .icon-task { background: #fdf4ff; color: #d946ef; }

    .item-meta { flex: 1; }
    .item-title { font-size: 0.9rem; font-weight: 600; color: #1e293b; }
    .item-time { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }

    .item-amount { text-align: right; }
    .amt-val { font-size: 0.95rem; font-weight: 700; color: #10b981; }
    .amt-status { font-size: 0.65rem; font-weight: 600; color: #cbd5e1; text-transform: uppercase; }
    
/* Additional Styles for Compact Stats Grid */
.stats-grid-compact .stat-item {
  transition: all 0.2s ease;
}

.stats-grid-compact .stat-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Ensure consistent icon sizing */
.stats-grid-compact .stat-icon {
  min-width: 40px;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.withdraw-btn {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
/* ================= PAYMENT METHODS SECTION STYLES ================= */

    /* 1. Wallet Header */
    .wallet-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 2rem; padding: 0 0.5rem;
    }
    .wallet-page-title {
      font-size: 1.5rem; font-weight: 800; color: #0f172a; letter-spacing: -0.025em;
    }

    /* 2. Cards Grid */
    .cards-grid {
      display: grid; grid-template-columns: 1fr; gap: 1rem;
      margin-bottom: 2.5rem;
    }

    /* Base Card Style */
    .wallet-card {
      border-radius: 1.25rem; padding: 1.5rem; color: white;
      position: relative; overflow: hidden; min-height: 140px;
      display: flex; flex-direction: column; justify-content: space-between;
      box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer; border: 2px solid transparent;
    }
    .wallet-card:active { transform: scale(0.98); }
    
    /* Selection State */
    .wallet-card.selected {
      border-color: #0f172a; transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    /* Decoration Circle */
    .wallet-card::before {
      content: ''; position: absolute; top: -30px; right: -30px;
      width: 120px; height: 120px; border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
      pointer-events: none;
    }

    /* Dynamic Card Colors (Fallback) */
    .card-default { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
    /* Specific Brands */
    .card-bkash { background: linear-gradient(135deg, #E2136E 0%, #be125d 100%); box-shadow: 0 10px 25px -5px rgba(226, 19, 110, 0.3); }
    .card-nagad { background: linear-gradient(135deg, #F8A01C 0%, #ea580c 100%); box-shadow: 0 10px 25px -5px rgba(248, 160, 28, 0.3); }
    .card-rocket { background: linear-gradient(135deg, #8C34FF 0%, #7c3aed 100%); box-shadow: 0 10px 25px -5px rgba(124, 58, 237, 0.3); }
    .card-paypal { background: linear-gradient(135deg, #003087 0%, #001C64 100%); box-shadow: 0 10px 25px -5px rgba(0, 48, 135, 0.3); }

    /* Card Content */
    .card-logo-area { display: flex; justify-content: space-between; align-items: start; }
    .card-icon {
      font-size: 1.5rem; background: rgba(255,255,255,0.2);
      width: 44px; height: 44px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    
    .card-badge {
      background: rgba(0,0,0,0.2); font-size: 0.7rem;
      padding: 4px 10px; border-radius: 20px; font-weight: 500;
      backdrop-filter: blur(4px); display: flex; align-items: center; gap: 4px;
    }

    .card-details { margin-top: 1rem; }
    .card-label { font-size: 0.75rem; opacity: 0.9; margin-bottom: 2px; font-weight: 500; }
    .card-number { font-size: 1.1rem; font-weight: 700; font-family: monospace; letter-spacing: 1px; }

    /* 3. Editor Sheet */
    .edit-sheet {
      background: white; border-radius: 1.5rem; padding: 1.5rem;
      border: 1px solid #e2e8f0; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
      position: sticky; bottom: 1rem;
      display: none; /* Hidden until selected */
      animation: slideUp 0.3s ease-out;
    }
    .edit-sheet.active { display: block; }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modern-input {
      width: 100%; background: #f8fafc; border: 1px solid #e2e8f0;
      padding: 1rem; border-radius: 1rem; font-size: 1rem;
      color: #1e293b; font-weight: 600; transition: all 0.2s;
    }
    .modern-input:focus {
      background: white; border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); outline: none;
    }

    .save-btn-primary {
      width: 100%; padding: 1rem; background: #0f172a; color: white;
      border-radius: 1rem; font-weight: 600; border: none; cursor: pointer;
      display: flex; justify-content: center; align-items: center; gap: 0.5rem;
      transition: opacity 0.2s; margin-top: 1rem;
    }
    .save-btn-primary:active { opacity: 0.9; }
    
    .delete-btn-text {
        color: #ef4444; font-size: 0.75rem; font-weight: 600; 
        background: #fef2f2; padding: 0.4rem 0.8rem; border-radius: 8px;
        cursor: pointer; border: 1px solid #fee2e2;
    }
/* ================= NEW PROFILE STYLES ================= */

    /* 1. Profile Header */
    .profile-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-top: 2rem; /* Added space since top bar is hidden */
    }

    .avatar-ring {
      width: 90px; height: 90px;
      border-radius: 50%;
      padding: 3px;
      /* Premium Gradient Ring */
      background: linear-gradient(135deg, #3b82f6, #10b981); 
      margin: 0 auto 1rem auto;
      position: relative;
    }

    .avatar-inner {
      width: 100%; height: 100%;
      background: white;
      border-radius: 50%;
      border: 3px solid white;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Edit Pen Icon */
    .edit-avatar-btn {
        position: absolute; bottom: 0; right: 0;
        background: white; color: #2563eb;
        border-radius: 50%; width: 32px; height: 32px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        border: 1px solid #f1f5f9; font-size: 0.75rem;
        cursor: pointer; z-index: 10;
    }

    /* ID Badge */
    .id-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: #f1f5f9; color: #64748b;
      padding: 4px 12px; border-radius: 999px;
      font-size: 0.7rem; font-weight: 600;
      margin-top: 0.5rem; border: 1px solid #e2e8f0;
    }

    /* 2. Premium Balance Card */
    .balance-card-glass {
      background: linear-gradient(120deg, #1e293b 0%, #0f172a 100%);
      border-radius: 1.5rem;
      padding: 1.5rem;
      color: white;
      box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.3);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    /* Decor shape */
    .balance-card-glass::after {
      content: ''; position: absolute; top: -60px; right: -60px;
      width: 180px; height: 180px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%; pointer-events: none;
    }

    .balance-btn-row {
      display: flex; gap: 0.75rem; margin-top: 1.5rem;
    }

    .balance-btn {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      padding: 0.75rem;
      border-radius: 0.75rem;
      font-size: 0.85rem; font-weight: 600;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      transition: background 0.2s;
    }
    .balance-btn:active {
      transform: scale(0.98); background: rgba(255,255,255,0.2);
    }

    /* 3. Stats Grid */
    .stats-grid-profile {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 0.75rem; margin-bottom: 1.5rem;
    }

    .stat-box {
      background: white; padding: 1rem;
      border-radius: 1rem; border: 1px solid #f1f5f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      display: flex; flex-direction: column;
      transition: transform 0.2s;
    }
    .stat-box:active { transform: scale(0.98); }

    /* 4. Menu List */
   /* Optimized Menu Spacing */
.menu-section {
  margin-bottom: 1.25rem !important; /* Reduced from 2rem to keep blocks closer */
  display: block !important;
  width: 100% !important;
}

.menu-label {
  font-size: 0.7rem; 
  font-weight: 800; 
  color: #94a3b8;
  margin-bottom: 0.5rem; 
  padding-left: 0.25rem;
  text-transform: uppercase; 
  letter-spacing: 0.05em;
}

.menu-group {
  background: white;
  border-radius: 1.25rem;
  overflow: hidden;
  border: 1px solid #f1f5f9;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
}
.menu-icon {
  width: 38px;             /* Standardized width */
  height: 38px;            /* Standardized height */
  border-radius: 10px;
  display: flex; 
  align-items: center; 
  justify-content: center;
  margin-right: 12px;      /* Fixed the gap here */
  font-size: 1rem;
  flex-shrink: 0;          /* Prevents icon from squishing */
}
.menu-item {
  display: flex; 
  align-items: center;     /* Vertically centers icon with text */
  padding: 0.75rem 1rem; 
  cursor: pointer; 
  border-bottom: 1px solid #f8fafc;
  transition: all 0.2s ease;
}

.menu-item .flex-1 {
  display: flex;
  flex-direction: column;
  justify-content: center; /* Centers text lines vertically */
}

.menu-item:last-child { border-bottom: none; }
.menu-item:active { background: #f8fafc; transform: scale(0.99); }
/* ================= NEW EARN SECTION STYLES ================= */

    /* 1. Daily Progress Card */
    .goal-card {
      background: white;
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      border: 1px solid #f1f5f9;
    }

    .progress-track {
      background: #f1f5f9;
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      margin: 1rem 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      border-radius: 999px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      width: 0%; /* Default to 0, JS updates this */
    }

    /* 2. Task Action Card */
    .task-card {
      background: white;
      border-radius: 1.25rem;
      padding: 1.25rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .task-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }

    .task-icon-circle {
      width: 60px; height: 60px;
      background: #eff6ff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #2563eb;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1);
    }

    /* 3. Primary Button Styling */
    .earn-btn {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white;
      width: 100%;
      padding: 1rem;
      border-radius: 1rem;
      font-weight: 600;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.2);
      transition: transform 0.2s;
      border: none;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .earn-btn:active { transform: scale(0.98); }
    .earn-btn:hover { background: linear-gradient(135deg, #334155 0%, #1e293b 100%); }

    /* 4. Penalty Card Modern */
    .penalty-card-modern {
      background: #fef2f2;
      border: 1px solid #fee2e2;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
      text-align: left;
      width: 100%;
      display: none; /* Hidden by default */
    }
    
    .penalty-list {
      list-style: none; padding: 0; margin: 0.5rem 0;
    }
    .penalty-list li {
      font-size: 0.8rem; color: #991b1b; margin-bottom: 0.25rem;
      display: flex; align-items: center; gap: 0.5rem;
    }

    /* 5. Invite Banner */
    .invite-banner {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      border-radius: 1.25rem;
      padding: 1.5rem;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(217, 119, 6, 0.3);
    }
    
    .invite-deco {
      position: absolute; right: -20px; bottom: -20px;
      font-size: 5rem; opacity: 0.2; transform: rotate(-15deg);
    }
    
    .btn-white {
      background: white; color: #d97706;
      width: 100%; padding: 0.75rem; border-radius: 0.75rem;
      font-weight: 700; font-size: 0.875rem; border: none; cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.2s;
    }
    .btn-white:hover { background-color: #fff7ed; }

    /* 6. Extra Task Card */
    .extra-earn-card {
        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
        border: 2px solid #fff;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
        border-radius: 1.25rem;
        padding: 1.25rem;
        box-shadow: 0 8px 15px rgba(255, 107, 107, 0.25);
        color: white;
        text-align: center;
    }
    
    .extra-gift-icon {
        position: absolute; top: -10px; left: -10px;
        font-size: 4rem; color: rgba(255, 255, 255, 0.2); transform: rotate(-25deg);
    }
    
    .extra-btn {
        background: white; color: #FF6B6B;
        font-weight: 800; text-transform: uppercase; font-size: 0.8rem;
        padding: 0.6rem; width: 100%; border-radius: 0.5rem;
        margin-top: 0.75rem; border: none; cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
/* ================= NEW HEADER STYLES ================= */
    
    /* 1. Hide the old header */
    

    /* 2. New Header Container */
    .watermark-header {
      position: fixed;
      top: 0; 
      left: 0; 
      right: 0;
      height: 5rem; /* Increased slightly for better spacing */
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      z-index: 1050; /* Higher than content, lower than modals */
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.25rem;
      overflow: hidden;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
body.header-hidden .section, 
    body.header-hidden .section-fullscreen {
        padding-top: 0 !important; /* Let the section handle its own top */
    }
    /* Logic to hide header on specific pages (Profile/Withdraw) */
    body.header-hidden .watermark-header {
      transform: translateY(-100%);
    }

    /* Watermark Background */
    .brand-watermark {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
    }
    
    .watermark-text {
      font-size: 2.5rem;
      font-weight: 900;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      opacity: 0.06; 
      transform: scale(1.1) skewX(-10deg);
      white-space: nowrap;
    }

    .header-content {
      position: relative;
      z-index: 10;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Avatar Styling */
    .user-pill {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar-circle {
      width: 44px;  /* Slightly larger to fit the ring */
      height: 44px;
      position: relative;
      
      /* THE THICK OUTLINE (Gradient) */
      background: linear-gradient(135deg, #3b82f6, #10b981); 
      border-radius: 50%;
      padding: 2px; /* Control the 'Thinking'/Thickness here */
      
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .avatar-img-wrapper {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid white; /* Clean separation */
      overflow: hidden; 
      background: #f1f5f9;
      position: relative;
      z-index: 10;
    }
    
    .avatar-img-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .status-dot {
      position: absolute;
      bottom: 0px; 
      right: 0px; 
      width: 12px;
      height: 12px;
      background: #10b981; /* Green Dot */
      border: 2px solid white;
      border-radius: 50%;
      z-index: 20;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      animation: pulse-green 2s infinite;
    }
    
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
      100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }
    /* Right Side items */
    .action-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .flag-pill {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 99px;
      padding: 0.35rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: #475569;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    .notif-btn {
      width: 40px; 
      height: 40px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: #64748b;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }
    
    .red-dot {
      position: absolute;
      top: 9px; right: 9px;
      width: 8px; height: 8px;
      background: #ef4444;
      border: 2px solid white;
      border-radius: 50%;
    }
    /* ================= NEW NOTIFICATION STYLES ================= */

    /* 1. Backdrop Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(4px);
      z-index: 10050; /* High z-index to sit on top of everything */
      display: flex;
      align-items: flex-end; /* Bottom sheet on mobile */
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* 2. Modal Container */
    .modal-container {
      background: white;
      width: 100%;
      max-width: 480px;
      height: 85vh; /* Tall sheet on mobile */
      border-radius: 1.5rem 1.5rem 0 0; /* Top corners rounded */
      display: flex;
      flex-direction: column;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Desktop Adjustment */
    @media (min-width: 640px) {
      .modal-overlay { align-items: center; }
      .modal-container {
        height: auto;
        max-height: 80vh;
        border-radius: 1.5rem; /* All corners rounded */
        transform: translateY(20px);
      }
    }

    .modal-overlay.active .modal-container {
      transform: translateY(0);
    }

    /* 3. Header */
    .modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .modal-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
    
    .clear-btn {
      font-size: 0.8rem; font-weight: 600; color: #64748b;
      background: none; border: none; cursor: pointer;
    }
    .clear-btn:hover { color: #ef4444; }

    /* 4. Scrollable Body */
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* 5. Notification Items */
    .notif-item {
      display: flex; gap: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 1rem;
      transition: all 0.2s;
    }
    .notif-item:hover {
      background: #f8fafc;
      transform: translateX(4px);
      border-color: #e2e8f0;
    }

    .notif-icon-box {
      width: 44px; height: 44px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; flex-shrink: 0;
    }
    
    /* Icon Color Types */
    .type-gift { background: #fff7ed; color: #ea580c; }   /* Orange for Bonuses */
    .type-alert { background: #fef2f2; color: #ef4444; }  /* Red for Warnings */
    .type-info { background: #eff6ff; color: #3b82f6; }   /* Blue for General */

    .notif-content { flex: 1; }
    .notif-title { font-size: 0.9rem; font-weight: 700; color: #1e293b; margin: 0 0 0.25rem 0; }
    .notif-desc { font-size: 0.8rem; color: #64748b; margin: 0; line-height: 1.4; }
    .notif-time { font-size: 0.7rem; color: #94a3b8; margin-top: 0.5rem; font-weight: 500; }

    /* 6. Footer */
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #f1f5f9;
      background: #f8fafc;
      border-radius: 0 0 1.5rem 1.5rem;
      flex-shrink: 0;
    }

    .close-modal-btn {
      width: 100%;
      padding: 0.875rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      color: #334155;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .close-modal-btn:hover { background: #e2e8f0; }
    /* ================= NEW FINTECH HOME STYLES ================= */

    /* 1. Remove Old Home Header (We built a custom one inside the body) */
    /* The main watermark header is good for Profile/Withdraw, but 
       this design has its own header. */
    
    /* 2. Announcement Ticker */
    .ticker-pill {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 999px;
      padding: 0.5rem 1rem;
      margin-bottom: 1.5rem;
      display: flex; align-items: center; gap: 0.75rem;
      box-shadow: 0 4px 6px -2px rgba(251, 191, 36, 0.1);
      cursor: pointer;
    }

    /* 3. Main Wallet Card */
    .wallet-hero {
      background: linear-gradient(120deg, #1e293b 0%, #0f172a 100%);
      border-radius: 1.5rem;
      padding: 1.5rem;
      color: white;
      box-shadow: 0 20px 25px -5px rgba(15, 23, 42, 0.25);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    
    /* Background Decor */
    .wallet-hero::before {
      content: ''; position: absolute; top: -50px; right: -50px;
      width: 180px; height: 180px; border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
    }

    /* 4. Action Grid */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-bottom: 2rem;
    }
    
    .action-btn {
      display: flex; flex-direction: column; align-items: center;
      gap: 0.5rem; background: none; border: none; cursor: pointer;
      transition: transform 0.2s;
    }
    .action-btn:active { transform: scale(0.95); }
    
    .icon-sq {
      width: 52px; height: 52px;
      border-radius: 1rem;
      background: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem;
      box-shadow: 0 4px 10px -2px rgba(0,0,0,0.05);
      border: 1px solid #f1f5f9;
    }

    /* 5. Live Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 5rem; /* Space for bottom nav */
    }
    
    .stat-card {
      background: white;
      padding: 1rem;
      border-radius: 1.25rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      position: relative;
      overflow: hidden;
    }
    
    .progress-line-bg {
      width: 100%; height: 4px;
      background: #f1f5f9;
      border-radius: 99px;
      margin-top: 0.75rem;
    }
    .progress-line-fill {
      height: 100%;
      border-radius: 99px;
      background: #3b82f6;
      width: 0%; 
      transition: width 0.5s ease;
    }
/* ================= NEW FINTECH NAVIGATION STYLES ================= */
    /* Overriding old nav styles */
    .fixed-bottom-nav { display: none !important; } 

    .fixed-bottom-nav, .fintech-bottom-nav {
      position: fixed !important; 
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 1000;      /* Ensure it sits ON TOP of the scrolling content */
      background: white;  /* Solid background so content doesn't show through */
      border-top: 1px solid #f1f5f9;
      padding-bottom: env(safe-area-inset-bottom); /* iOS Safe Area */
    }

    .nav-list {
      display: flex;
      justify-content: space-around;
      align-items: center;
      list-style: none;
      padding: 0;
      margin: 0;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Custom Nav Item Styling (Replaces Tailwind classes) */
    .custom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: #94a3b8; /* Inactive color */
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      width: 64px;
      -webkit-tap-highlight-color: transparent;
    }

    .nav-icon-box {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 1.25rem;
      font-size: 1.25rem;
      transition: all 0.3s ease;
      position: relative;
    }

    /* Active State Logic matching your JS */
    .custom-nav-item.active {
      color: #0f172a;
      transform: translateY(-8px);
    }

    .custom-nav-item.active .nav-icon-box {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      color: white;
      box-shadow: 0 8px 15px -3px rgba(37, 99, 235, 0.4);
      border-radius: 1rem;
    }

    .custom-nav-item span {
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .custom-nav-item.active span {
      opacity: 1;
      font-weight: 600;
    }
    /* ===================== UPDATED TOP BAR ANIMATIONS ===================== */
   

    /* Hide top bar for profile, withdraw, and history sections */
    body.header-hidden .fixed-top-header {
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
    }

   

    /* Adjust main content when header is hidden */
    main {
        position: static !important;
        width: 100%;
        height: 100%;
        padding: 0 !important;
        margin: 0 !important;
        overflow: hidden !important;
        z-index: 1; 
    }

    body.header-hidden main {
        top: 0 !important; 
        height: 100% !important;
        padding-top: 1rem !important; /* Breathing room at top */
        padding-bottom: 6rem !important; /* Extra space at bottom for nav */
    }

    .sections-container {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }


    
/* ================= SMOOTH SECTION ANIMATION ================= */
    
    /* 1. Define the Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(15px) scale(0.98); /* Start slightly down and smaller */
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1); /* End in normal position */
      }
    }

    /* 2. Apply it to Active Sections */
    .section.active, .section-fullscreen.active {
      display: block;
      /* Premium Ease-Out Animation */
      animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      
      /* Ensure it sits on top during animation */
      z-index: 10;
    }
    /* 5. Fix for Profile/Withdraw specific styling */
.section, .section-fullscreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        
        /* Top: 5.25rem (Header 5rem + 0.25rem tiny gap)
           Bottom: 75px (Nav + buffer) + Safe Area
        */
        padding: 5.25rem 16px calc(75px + env(safe-area-inset-bottom)) 16px !important;
        
        box-sizing: border-box;
        overflow-y: auto;
        overflow-x: hidden;
        display: none;
        z-index: 10;
        /* Smooth Scrolling */
        -webkit-overflow-scrolling: touch; 
        scroll-behavior: smooth;
    }
    /* Adjust section-fullscreen when header is visible */
    body:not(.header-hidden) .section-fullscreen {
        top: -6rem !important;
        height: calc(100% + 6rem);
    }

    .nav-item {
      transition: all 0.3s ease-in-out;
      color: #64748b;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .nav-item.active {
      color: var(--color-logo-green);
      font-weight: 600;
      transform: translateY(-4px);
    }

    .content-card {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .section-content {
      min-height: calc(100% - 2rem);
      display: flex;
      flex-direction: column;
    }

    #marqueeContainer {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      background-color: #FFFACD;
      padding: 1rem;
      border-radius: 1rem 1rem 0 0;
    }
    #marqueeText {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
      color: #B8860B;
      font-weight: 600;
      font-size: 0.875rem;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    #androidTopNotification {
      position: fixed;
      top: 7rem;
      left: 50%;
      transform: translateY(-100%) translateX(-50%);
      width: 90%;
      max-width: 28rem;
      background: #1f2937;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      text-align: center;
      z-index: 9999;
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    #androidTopNotification.show {
      transform: translateY(0) translateX(-50%);
      opacity: 1;
    }

    #editModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1003;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    #editModal.show {
      display: flex;
      opacity: 1;
    }
    #editModal .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 28rem;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    #editModal.show .modal-content {
      transform: translateY(0);
    }

    #successPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 82, 55, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1002;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    #successPopup.show {
      opacity: 1;
      pointer-events: auto;
    }

   .checkmark-wrapper {
      width: 100px;
      height: 100px;
      margin: 0 auto 1.5rem;
    }

    .checkmark {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: block;
      stroke-width: 5;
      stroke: var(--color-success);
      stroke-miterlimit: 10;
      box-shadow: inset 0 0 0 var(--color-success);
      animation:
        fill 0.4s ease-in-out 0.4s forwards,
        scale 0.3s ease-in-out 0.9s both;
    }

    .checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 5;
      stroke-miterlimit: 10;
      stroke: var(--color-success);
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    @keyframes fill {
      100% {
        box-shadow: inset 0 0 0 100px rgba(16, 185, 129, 0.1);
      }
    }

    .btn-primary {
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green)) !important;
      color: white !important;
      border-radius: 9999px !important;
      padding: 0.75rem 2rem !important;
      border: none !important;
      font-weight: 600 !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: pointer !important;
      transition: transform 0.2s !important;
      width: 100% !important;
    }
    .btn-primary:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    }
    #inviteFriendsBtn {
      background-color: var(--color-logo-gold) !important;
      color: #334155 !important;
    }
    .edit-payment-btn {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background-color: var(--color-logo-green);
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }
    .edit-payment-btn:hover {
      background-color: var(--color-logo-light-green);
      transform: translateY(-2px);
    }
    .edit-payment-btn i {
      margin-right: 0.25rem;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .banner-img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 0 0 1rem 1rem;
      background: linear-gradient(45deg, var(--color-logo-blue), var(--color-logo-green));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.5rem;
    }

    .telegram-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #0088cc;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .telegram-connected {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      background: #0088cc;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 1000;
      display: none;
    }

    .profile-image {
      width: 128px;
      height: 128px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--color-logo-light-green);
      background-color: #E6FFE6;
    }

    .profile-placeholder {
      width: 128px;
      height: 128px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 4px solid var(--color-logo-light-green);
      background-color: #E6FFE6;
      font-size: 4rem;
      color: var(--color-logo-green);
    }

    .profile-header-image {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      border: 2px solid #C1E1C1;
    }

    .profile-header-placeholder {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #E6FFE6;
      color: var(--color-logo-green);
      font-size: 1.5rem;
      margin-right: 12px;
      border: 2px solid #C1E1C1;
    }

    .validation-error {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .country-flag {
      margin-left: 8px;
      font-size: 1.5rem;
      vertical-align: middle;
    }

    .firebase-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .firebase-loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--color-logo-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .profile-id {
      font-family: monospace;
      background-color: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .withdrawal-history-container {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .withdrawal-history-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .withdrawal-history-table th,
    .withdrawal-history-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .withdrawal-history-table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #475569;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .withdrawal-history-table tbody tr:last-child td {
      border-bottom: none;
    }

    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-approved {
      background-color: #d1fae5;
      color: #065f46;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-rejected {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .history-btn {
      background-color: var(--color-logo-green);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
    }
    .history-btn:hover {
      background-color: var(--color-logo-light-green);
      transform: translateY(-2px);
    }
    .history-btn i {
      margin-right: 0.25rem;
    }

    .withdraw-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .content-card.bg-gradient-to-br.from-purple-600.to-indigo-700 {
        background: linear-gradient(to bottom right, var(--color-logo-blue), var(--color-logo-green));
    }

    .content-card.bg-gradient-to-br.from-gray-800.to-gray-900 {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange));
    }
    .content-card.bg-gradient-to-br.from-gray-800.to-gray-900 .bg-white.p-3.rounded-full.text-gray-800 {
        color: var(--color-logo-gold);
    }

    .content-card.bg-gradient-to-br.from-blue-500.to-cyan-500 {
        background: linear-gradient(to bottom right, var(--color-logo-blue), var(--color-logo-green));
    }

    .content-card.bg-gradient-to-br.from-red-500.to-orange-500 {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange));
    }

    #earn-progress-bar {
        background-color: var(--color-logo-green) !important;
    }

    .balance-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green));
      color: white;
      border-radius: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .balance-text {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .balance-amount {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .withdraw-btn {
      background-color: var(--color-logo-gold);
      color: #334155;
      border: none;
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .withdraw-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .back-button {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      color: var(--color-logo-blue);
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
    }

    #maintenancePopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }
    .maintenance-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 28rem;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .maintenance-icon {
      font-size: 3rem;
      color: #f59e0b;
      margin-bottom: 1rem;
    }
    .maintenance-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    .maintenance-message {
      font-size: 1rem;
      color: #4b5563;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .maintenance-time {
      font-size: 0.9rem;
      color: #6b7280;
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    .maintenance-btn {
      padding: 0.75rem 2rem;
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green));
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .maintenance-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* ================= NEW TELEGRAM WARNING STYLES ================= */

    #telegramWarningPopup {
      position: fixed;
      inset: 0;
      z-index: 12000; /* Highest layer */
      display: flex; /* Hidden by inline style initially */
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
    }

    /* Background Pattern */
    .security-pattern {
        position: absolute;
        inset: 0;
        opacity: 0.05;
        background-image: radial-gradient(#64748b 1px, transparent 1px);
        background-size: 24px 24px;
        z-index: 0;
    }

    .warning-card {
        background: white;
        width: 100%;
        max-width: 360px;
        border-radius: 1.5rem;
        padding: 2rem;
        text-align: center;
        position: relative;
        z-index: 1;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* Icon Area */
    .icon-wrapper {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem auto;
    }
    
    .icon-bg {
        position: absolute; inset: 0;
        background: #e0f2fe;
        border-radius: 50%;
        animation: pulse-soft 2s infinite;
    }
    
    @keyframes pulse-soft {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    .telegram-icon {
        position: relative;
        z-index: 2;
        font-size: 2.5rem;
        color: #0ea5e9;
        line-height: 80px;
    }

    .lock-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 28px;
        height: 28px;
        background: #ef4444;
        border-radius: 50%;
        border: 3px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        z-index: 3;
    }

    /* Text */
    .warning-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 0.75rem;
        letter-spacing: -0.025em;
    }
    
    .warning-desc {
        color: #64748b;
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 2rem;
    }

    /* Button */
    .open-bot-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        width: 100%;
        background: linear-gradient(135deg, #229ED9 0%, #1e88e5 100%);
        color: white;
        font-weight: 700;
        padding: 1rem;
        border-radius: 1rem;
        text-decoration: none;
        box-shadow: 0 10px 15px -3px rgba(34, 158, 217, 0.3);
        transition: transform 0.2s;
        border: none;
        cursor: pointer;
    }
    .open-bot-btn:hover { transform: translateY(-2px); }
    .open-bot-btn:active { transform: scale(0.98); }

    .manual-link {
        margin-top: 1.5rem;
        font-size: 0.75rem;
        color: #94a3b8;
    }
    .manual-link a {
        color: #64748b;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }
    .manual-link a:hover { color: #229ED9; }
    .penalty-warning {
      color: #ef4444;
      font-weight: 600;
      text-align: center;
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #fee2e2;
      border-radius: 0.5rem;
      display: none;
    }

    .penalty-timer {
      color: #ef4444;
      font-weight: 600;
    }

    .penalty-warning-card {
      border: 2px solid #ef4444;
      background-color: #fef2f2;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
      display: none;
    }
    .penalty-warning-title {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    .penalty-warning-title i {
      margin-right: 0.5rem;
    }
    .penalty-warning-list {
      list-style-type: none;
      padding: 0;
      margin: 0.5rem 0;
    }
    .penalty-warning-list li {
      padding: 0.25rem 0;
      color: #7f1d1d;
      font-size: 0.875rem;
      display: flex;
      align-items: flex-start;
    }
    .penalty-warning-list li i {
      margin-right: 0.5rem;
      color: #ef4444;
      margin-top: 0.25rem;
    }
    .details-link {
      color: #3b82f6;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: inline-block;
    }

    #instructionsPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      
      display: none;
      align-items: center;
      justify-content: center;
     z-index: 16000 !important; /* Forces it above headers and other modals */
    background: rgba(0, 0, 0, 0.85); /* Slightly darker for better focus */
    backdrop-filter: blur(5px); /* Adds blur effect to background */

      padding: 1rem;
    }
    #instructionsPopup.show {
      display: flex;
    }
    .instructions-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 32rem;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .close-instructions {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
    }
    .instructions-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
      text-align: center;
    }
    .instructions-list {
      margin-bottom: 1.5rem;
    }
    .instructions-item {
      margin-bottom: 1rem;
      padding-left: 1.5rem;
      position: relative;
    }
    .instructions-item-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    .instructions-item-desc {
      color: #4b5563;
      font-size: 0.9375rem;
    }
    .instructions-item::before {
      content: "";
      position: absolute;
      left: 0;
      color: var(--color-logo-green);
      font-weight: bold;
    }
    .instructions-close-btn {
      background-color: var(--color-logo-blue);
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s;
    }
    .instructions-close-btn:hover {
      background-color: #1e40af;
    }

    .app-info-card {
      border-top: 1px solid #e5e7eb;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    .app-info-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.75rem;
      text-align: center;
    }
    .app-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    .app-info-label {
      color: #6b7280;
    }
    .app-info-value {
      color: #374151;
      font-weight: 500;
    }
    .app-info-link {
      color: #3b82f6;
      text-decoration: none;
    }
    .app-info-link:hover {
      text-decoration: underline;
    }

    .btn-penalty {
      background: linear-gradient(to right, #ef4444, #dc2626) !important;
      color: white !important;
      cursor: not-allowed !important;
    }
    .btn-penalty:hover {
      transform: none !important;
    }
    
    /* ========== ADDED FEATURES ========== */
    
    .extra-earn-card {
        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
        border: 3px solid #FFD700;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
        border-radius: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
    }
    .extra-earn-card::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
        animation: rotate 10s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .gift-icon {
        position: absolute;
        top: -10px;
        left: -10px;
        font-size: 4.5rem;
        color: rgba(255, 255, 255, 0.25);
        transform: rotate(-25deg);
        z-index: 1;
    }
    .extra-content { position: relative; z-index: 2; text-align: center; color: white; }
    .extra-earn-btn {
        background: white !important;
        color: #FF6B6B !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 2px solid #fff !important;
        margin-top: 10px;
    }

    #adOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        display: none;
        flex-direction: column;
    }
    .ad-header {
        height: 60px;
        background: #1a1a1a;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #333;
    }
    .ad-timer-text {
        font-size: 0.9rem;
        color: #fbbf24;
        font-weight: bold;
    }
    .close-ad-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid #555;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0.5;
        pointer-events: none;
        transition: 0.3s;
    }
    .close-ad-btn.active {
        background: #ef4444;
        border-color: #ef4444;
        opacity: 1;
        pointer-events: auto;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }
    .ad-content-area {
        flex: 1;
        background: #ffffff;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .ad-footer {
        height: 50px;
        background: rgba(0,0,0,0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 20px;
    }
    .ad-message {
        text-align: center;
        color: white;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .ad-progress-bg {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 3px;
        overflow: hidden;
    }
    .ad-progress-bar {
        height: 100%;
        width: 0%;
        background: #10b981;
        transition: width 1s linear;
    }
    
    .ad-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .payment-field-group { margin-bottom: 1rem; }
    .payment-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
    .payment-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; }
    .validation-error { color: #ef4444; font-size: 0.75rem; display: none; }
    
    #dynamicPaymentEditModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1003;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #dynamicPaymentEditModal.show {
        display: flex;
        opacity: 1;
    }
    #dynamicPaymentEditModal .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        width: 90%;
        max-width: 28rem;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }
    #dynamicPaymentEditModal.show .modal-content {
        transform: translateY(0);
    }
    
    /* Payment Details Display */
    #dynamicPaymentDetailsDisplay p {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 0.5rem;
    }

    /* Extra Tasks Container */
    #extraTasksContainer {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    #noAdsMsg {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 2rem 0;
        display: none;
    }

    /* ========== NEW PROFILE STYLES ========== */
    .profile-page {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        padding: 1rem;
        background: linear-gradient(135deg, #e0e0e0 0%, #f8f9fa 100%);
    }

    /* Payment method grid for more than 2 methods */
    .payment-methods-grid {
        display: grid;
        gap: 1rem;
    }
    
    .payment-methods-grid.single-column {
        grid-template-columns: 1fr;
    }
    
    .payment-methods-grid.two-column {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .payment-methods-grid.multi-column {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    /* Custom animations for new profile */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease forwards;
    }

    /* Custom scrollbar for new profile */
    .profile-page::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .profile-page::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .profile-page::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .profile-page::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Page transition */
    .page-transition {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* Color classes for new profile */
    .bg-logo-blue { background-color: var(--color-logo-blue) !important; }
    .text-logo-blue { color: var(--color-logo-blue) !important; }
    .border-logo-blue { border-color: var(--color-logo-blue) !important; }

    .bg-logo-green { background-color: var(--color-logo-green) !important; }
    .text-logo-green { color: var(--color-logo-green) !important; }
    .border-logo-green { border-color: var(--color-logo-green) !important; }

    .bg-logo-gold { background-color: var(--color-logo-gold) !important; }
    .text-logo-gold { color: var(--color-logo-gold) !important; }
    .border-logo-gold { border-color: var(--color-logo-gold) !important; }

    .bg-logo-orange { background-color: var(--color-logo-orange) !important; }
    .text-logo-orange { color: var(--color-logo-orange) !important; }

    .bg-gradient-logo {
        background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green)) !important;
    }
    
    .bg-gradient-logo-secondary {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange)) !important;
    }

    /* ========== NEW WITHDRAW STYLES ========== */
    .balance-summary {
      background: var(--gradient-primary);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      box-shadow: var(--shadow-lg);
    }
    .balance-amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .withdrawal-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 5rem; /* Spacing for bottom nav */
      box-shadow: var(--shadow-md);
    }
    .new-payment-methods-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .new-payment-method-card {
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-lg);
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .new-payment-method-card:hover {
      border-color: var(--color-logo-blue);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .new-payment-method-card.selected {
      border-color: var(--color-logo-blue);
      background: rgba(42, 100, 178, 0.05);
    }
    .new-payment-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: var(--color-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.75rem;
      font-size: 1.5rem;
      color: var(--color-logo-blue);
    }
    .new-amount-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    .new-amount-option {
      padding: 0.375rem 0.75rem;
      background: var(--color-light);
      border: 1px solid var(--color-light-gray);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .new-amount-option:hover {
      background: var(--color-logo-blue);
      color: white;
      border-color: var(--color-logo-blue);
    }

    /* Modal Overlay (Generic) */
    .new-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }
    .new-modal-overlay.active { opacity: 1; visibility: visible; }
    .new-modal-content {
      background: white;
      border-radius: 1.25rem;
      padding: 2rem;
      width: 90%;
      max-width: 28rem;
      transform: translateY(20px);
      transition: transform 0.3s ease;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .new-modal-overlay.active .new-modal-content { transform: translateY(0); }

    /* Other Utility Classes */
    .checkmark-wrapper { width: 80px; height: 80px; margin: 0 auto 1.5rem; }
    .checkmark { width: 100%; height: 100%; border-radius: 50%; display: block; stroke-width: 5; stroke: var(--color-success); stroke-miterlimit: 10; box-shadow: inset 0 0 0 var(--color-success); animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both; }
    .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 5; stroke-miterlimit: 10; stroke: var(--color-success); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
    .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill { 100% { box-shadow: inset 0 0 0 100px rgba(16, 185, 129, 0.1); } }

    /* Specific Ad/Notification Styles (Kept from original) */
    #androidTopNotification { position: fixed; top: 7rem; left: 50%; transform: translateY(-100%) translateX(-50%); width: 90%; max-width: 28rem; background: #1f2937; color: white; padding: 0.75rem 1rem; border-radius: 1rem; text-align: center; z-index: 9999; opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    #androidTopNotification.show { transform: translateY(0) translateX(-50%); opacity: 1; }
    
    .ad-header { height: 60px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #333; }
    .close-ad-btn { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
    .close-ad-btn.active { background: #ef4444; border-color: #ef4444; opacity: 1; pointer-events: auto; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
    
    /* ================= NEW WITHDRAWAL STYLES ================= */

    /* 1. Balance Summary Card */
    .withdraw-balance-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 1.5rem;
      padding: 1.5rem;
      color: white;
      box-shadow: 0 10px 20px -5px rgba(5, 150, 105, 0.3);
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
    }

    .withdraw-balance-card::after {
      content: ''; position: absolute; bottom: -40px; right: -40px;
      width: 140px; height: 140px;
      background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
      border-radius: 50%; pointer-events: none;
    }

    /* 2. Payment Method Grid */
    .section-label {
      font-size: 0.875rem; font-weight: 600; color: #334155;
      margin-bottom: 0.75rem; display: block;
    }

    .payment-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .method-card {
      background: white; border: 2px solid #e2e8f0; border-radius: 1rem;
      padding: 1rem; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; position: relative;
    }

    /* Selected State */
    .method-card.selected {
      border-color: #10b981; background-color: #ecfdf5;
      box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1);
    }
    .method-card.selected .method-icon { color: #059669; }
    
    .check-badge {
      position: absolute; top: 8px; right: 8px; font-size: 0.75rem;
      color: #10b981; display: none;
    }
    .method-card.selected .check-badge { display: block; }

    .method-icon {
      font-size: 1.75rem; margin-bottom: 0.5rem; color: #64748b;
    }
    .method-name {
      font-size: 0.75rem; font-weight: 600; color: #475569;
    }

    /* 3. Account Info Box */
    .account-info-box {
        background: #eff6ff; border: 1px solid #bfdbfe;
        border-radius: 0.75rem; padding: 0.75rem;
        margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;
    }

    /* 4. Amount Input */
    .amount-container {
      background: white; border-radius: 1.25rem; padding: 0.5rem;
      border: 2px solid #e2e8f0; display: flex; align-items: center;
      margin-bottom: 0.75rem; transition: border-color 0.2s;
    }
    .amount-container:focus-within {
      border-color: #10b981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }

    .currency-symbol {
      padding: 0 1rem; font-weight: 700; color: #94a3b8;
      font-size: 1.1rem; border-right: 1px solid #e2e8f0;
    }

    .amount-input {
      flex: 1; border: none; padding: 0.75rem 1rem;
      font-size: 1.25rem; font-weight: 700; color: #1e293b;
      outline: none; background: transparent; width: 100%;
    }

    .quick-amounts {
      display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
      overflow-x: auto; padding-bottom: 5px;
    }
    
    .pill-btn {
      padding: 0.4rem 1rem; background: white;
      border: 1px solid #e2e8f0; border-radius: 999px;
      font-size: 0.75rem; font-weight: 600; color: #64748b;
      cursor: pointer; white-space: nowrap; transition: all 0.2s;
    }
    .pill-btn:hover { background: #f8fafc; border-color: #cbd5e1; }
    .pill-btn.active {
      background: #10b981; color: white; border-color: #10b981;
    }

    /* 5. Summary Box */
    .summary-box {
      background: #f8fafc; border: 1px solid #e2e8f0;
      border-radius: 1rem; padding: 1rem; margin-bottom: 2rem;
    }
    .summary-row {
      display: flex; justify-content: space-between;
      margin-bottom: 0.5rem; font-size: 0.875rem; color: #64748b;
    }
    .summary-row.total {
      margin-top: 0.75rem; padding-top: 0.75rem;
      border-top: 1px dashed #cbd5e1; font-weight: 700;
      color: #1e293b; font-size: 1rem; margin-bottom: 0;
    }

    /* 6. Withdraw Button */
    .withdraw-btn {
      width: 100%;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: white; padding: 1rem; border-radius: 1rem;
      font-weight: 600; font-size: 1rem; border: none; cursor: pointer;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.2);
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      transition: transform 0.1s;
    }
    .withdraw-btn:active { transform: scale(0.98); }
   /* ================= TRANSACTION HISTORY STYLES ================= */

    .history-container {
      padding: 1.5rem 1rem;
      padding-bottom: 6rem;
    }

    /* Date Labels */
    .date-label {
      font-size: 0.75rem;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
      margin-top: 0.5rem;
      padding-left: 0.5rem;
    }

    /* Transaction Card */
    .txn-card {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #f1f5f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      transition: transform 0.2s;
    }
    .txn-card:active {
      transform: scale(0.98);
      background-color: #f8fafc;
    }

    /* Left Side: Icon + Text */
    .txn-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .txn-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    /* Icon Variants */
    .icon-bkash { background: #fce7f3; color: #db2777; }
    .icon-nagad { background: #ffedd5; color: #ea580c; }
    .icon-rocket { background: #f3e8ff; color: #7c3aed; }
    .icon-paypal { background: #dbeafe; color: #2563eb; }
    .icon-default { background: #f1f5f9; color: #64748b; }

    .txn-details {
      display: flex;
      flex-direction: column;
    }
    .txn-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 2px;
    }
    .txn-meta {
      font-size: 0.75rem;
      color: #94a3b8;
      font-weight: 500;
    }

    /* Right Side: Amount + Status */
    .txn-right {
      text-align: right;
    }

    .txn-amount {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .amount-neg { color: #1e293b; } /* Dark for withdrawal */
    
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-pending { background: #fef3c7; color: #d97706; }
    .status-success { background: #d1fae5; color: #059669; }
    .status-failed { background: #fee2e2; color: #dc2626; } 
    /* ================= ABOUT MODAL STYLES ================= */

    #aboutModal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.6); /* Dark Blue overlay */
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #aboutModal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .about-card {
      background: white;
      width: 90%;
      max-width: 340px;
      border-radius: 2rem;
      padding: 2rem;
      text-align: center;
      position: relative;
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    #aboutModal.show .about-card {
      transform: scale(1);
    }

    /* Close Button */
    .close-icon-btn {
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f1f5f9;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    .close-icon-btn:hover { background: #e2e8f0; }

    /* Logo Area */
    .app-logo-wrapper {
      width: 80px; height: 80px;
      margin: 0.5rem auto 1.5rem auto;
      border-radius: 1.25rem;
      background: white;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center;
      border: 1px solid #f1f5f9;
      overflow: hidden; 
    }

    /* Info List */
    .info-list {
        margin-top: 1.5rem;
        border: 1px solid #f1f5f9;
        border-radius: 1rem;
        overflow: hidden;
    }
    
    .info-row {
        display: flex; justify-content: space-between;
        padding: 0.875rem 1rem;
        font-size: 0.875rem;
        border-bottom: 1px solid #f1f5f9;
    }
    .info-row:last-child { border-bottom: none; }
    
    .info-label { color: #64748b; font-weight: 500; }
    .info-val { color: #1e293b; font-weight: 700; }

    /* Action Button */
    .telegram-full-btn {
        margin-top: 1.5rem;
        width: 100%;
        display: flex; align-items: center; justify-content: center;
        gap: 0.5rem;
        background: #229ED9;
        color: white;
        padding: 0.875rem;
        border-radius: 1rem;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(34, 158, 217, 0.25);
    }
    .telegram-full-btn:active { transform: scale(0.98); }
    /* ================= MAINTENANCE POPUP STYLES ================= */

    #maintenancePopup {
      position: fixed;
      inset: 0;
      z-index: 13000; /* Highest priority */
      display: flex; /* Toggle 'none' via JS */
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      background: rgba(15, 23, 42, 0.96); /* Deep dark overlay */
      backdrop-filter: blur(8px);
    }

    /* Technical Grid Pattern Background */
    .tech-grid-bg {
        position: absolute;
        inset: 0;
        opacity: 0.1;
        background-image: 
            linear-gradient(rgba(59, 130, 246, 0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(59, 130, 246, 0.5) 1px, transparent 1px);
        background-size: 40px 40px;
        animation: grid-scroll 20s linear infinite;
        pointer-events: none;
    }

    @keyframes grid-scroll {
        0% { transform: translateY(0); }
        100% { transform: translateY(40px); }
    }

    /* Card Style */
    .maintenance-card {
        background: white;
        width: 100%;
        max-width: 380px;
        border-radius: 1.5rem;
        padding: 2.5rem 2rem;
        text-align: center;
        position: relative;
        box-shadow: 0 0 50px rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
    }

    /* Animated Icon Area */
    .icon-container {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto 1.5rem auto;
    }

    .gear-main {
        font-size: 4rem;
        color: #3b82f6;
        animation: spin-slow 8s linear infinite;
        position: absolute;
        top: 10px;
        left: 10px;
    }

    .gear-small {
        font-size: 2.5rem;
        color: #64748b;
        animation: spin-reverse 5s linear infinite;
        position: absolute;
        bottom: 10px;
        right: 10px;
    }

    .sparkle {
        position: absolute;
        top: 0;
        right: 0;
        color: #f59e0b;
        font-size: 1.5rem;
        animation: bounce-fade 2s infinite;
    }

    @keyframes spin-slow { 100% { transform: rotate(360deg); } }
    @keyframes spin-reverse { 100% { transform: rotate(-360deg); } }
    @keyframes bounce-fade {
        0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
        50% { transform: translateY(-10px) scale(1.2); opacity: 0.5; }
    }

    /* Typography */
    .maint-title {
        font-size: 1.75rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 0.75rem;
        letter-spacing: -0.025em;
    }

    .maint-desc {
        color: #64748b;
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 2rem;
    }

    /* Status Pill */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #eff6ff;
        padding: 0.5rem 1rem;
        border-radius: 99px;
        margin-bottom: 2rem;
        border: 1px solid #dbeafe;
    }
    
    .status-dot {
        width: 8px; height: 8px;
        background: #3b82f6;
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        animation: pulse-dot 1.5s infinite;
    }
    
    @keyframes pulse-dot {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }

    /* Buttons */
    .telegram-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        background: linear-gradient(135deg, #229ED9 0%, #1e88e5 100%);
        color: white;
        padding: 1rem;
        border-radius: 1rem;
        font-weight: 700;
        text-decoration: none;
        box-shadow: 0 8px 20px -5px rgba(34, 158, 217, 0.4);
        transition: transform 0.2s;
        border: none;
        margin-bottom: 1rem;
    }
    .telegram-btn:active { transform: scale(0.98); }

    .refresh-btn {
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        transition: color 0.2s;
    }
    .refresh-btn:hover { color: #64748b; }
    
   /* ================= SUCCESS POPUP STYLES (MATCHED) ================= */

    #successPopup {
      position: fixed;
      inset: 0;
      z-index: 14000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #successPopup.show {
      opacity: 1;
      pointer-events: auto;
    }

    .success-card {
      background: white;
      width: 90%;
      max-width: 320px;
      padding: 2.5rem 2rem;
      border-radius: 2rem;
      text-align: center;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    #successPopup.show .success-card {
      transform: scale(1);
    }

    /* Icon Area */
    .icon-wrapper {
      position: relative;
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-circle {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: #ecfdf5; /* Light green background */
      transform: scale(0);
      animation: expand-circle 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .svg-container {
        position: relative;
        z-index: 2;
        width: 40px;
        height: 40px;
    }

    .checkmark-svg {
      width: 100%;
      height: 100%;
      stroke: #10b981; /* Green check */
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: draw-check 0.5s 0.3s ease forwards;
    }

    /* Burst Particles */
    .burst-core {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .burst-core span {
      position: absolute;
      top: 50%; left: 50%;
      width: 6px; height: 6px;
      border-radius: 50%;
      opacity: 0;
      /* Note: Background colors are set via HTML classes (bg-green-400 etc) */
    }

    #successPopup.show .burst-core span:nth-child(1) { animation: burst-1 0.8s 0.2s ease forwards; }
    #successPopup.show .burst-core span:nth-child(2) { animation: burst-2 0.8s 0.2s ease forwards; }
    #successPopup.show .burst-core span:nth-child(3) { animation: burst-3 0.8s 0.2s ease forwards; }
    #successPopup.show .burst-core span:nth-child(4) { animation: burst-4 0.8s 0.2s ease forwards; }
    #successPopup.show .burst-core span:nth-child(5) { animation: burst-5 0.8s 0.2s ease forwards; }
    #successPopup.show .burst-core span:nth-child(6) { animation: burst-6 0.8s 0.2s ease forwards; }

    /* Keyframes */
    @keyframes expand-circle { to { transform: scale(1); } }
    @keyframes draw-check { to { stroke-dashoffset: 0; } }

    /* Particle Explosions (matched to your file) */
    @keyframes burst-1 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(-40px,-40px); opacity: 0; } }
    @keyframes burst-2 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(40px,-40px); opacity: 0; } }
    @keyframes burst-3 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(-50px,0px); opacity: 0; } }
    @keyframes burst-4 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(50px,0px); opacity: 0; } }
    @keyframes burst-5 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(-30px,40px); opacity: 0; } }
    @keyframes burst-6 { 0% { transform: translate(-50%,-50%); opacity: 1; } 100% { transform: translate(30px,40px); opacity: 0; } }

    /* Typography & Button */
    .success-title { font-size: 1.5rem; font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; }
    .success-desc { font-size: 0.9rem; color: #64748b; margin-bottom: 2rem; line-height: 1.5; }

    .success-btn {
      width: 100%;
      padding: 1rem;
      background: #0f172a;
      color: white;
      border-radius: 1rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.2);
    }
    .success-btn:active { transform: scale(0.98); }
    /* ================= CONFIRM & ERROR MODAL STYLES ================= */

    .alert-overlay {
      position: fixed;
      inset: 0;
      z-index: 15000; /* Highest priority, above Success/Maintenance */
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .alert-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Card Base */
    .alert-card {
      background: white;
      width: 90%;
      max-width: 340px;
      padding: 2rem;
      border-radius: 1.5rem;
      text-align: center;
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
    }

    .alert-overlay.show .alert-card {
      transform: scale(1);
      opacity: 1;
    }

    /* Error Shake Animation */
    @keyframes shake-hard {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px) rotate(-2deg); }
      75% { transform: translateX(6px) rotate(2deg); }
    }
    .alert-card.shake {
      animation: shake-hard 0.4s ease-in-out;
    }

    /* Icons */
    .alert-icon-box {
      width: 70px; height: 70px;
      margin: 0 auto 1.25rem auto;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem;
    }

    .error-icon { background: #fee2e2; color: #ef4444; }
    .confirm-icon { background: #f1f5f9; color: #64748b; }

    /* Typography */
    .alert-title { font-size: 1.25rem; font-weight: 800; color: #0f172a; margin-bottom: 0.5rem; }
    .alert-desc { font-size: 0.9rem; color: #64748b; margin-bottom: 1.5rem; line-height: 1.5; }

    /* Buttons */
    .alert-actions {
      display: flex; gap: 0.75rem;
    }

    .btn-full {
      flex: 1;
      padding: 0.875rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .btn-full:active { transform: scale(0.96); }

    .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
    .btn-red { background: #ef4444; color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
    .btn-slate { background: #0f172a; color: white; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }
    
    /* ================= LOADING SCREEN STYLES ================= */

    #splashScreen {
      position: fixed;
      inset: 0;
      z-index: 20000; /* Highest priority (above everything) */
      background: #0f172a; /* Premium Dark Background */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease-in-out, visibility 0.6s;
    }

    #splashScreen.fade-out-up {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* Logo Animation */
    .splash-logo {
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 2rem;
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5));
      animation: pulse-logo 2s infinite;
    }

    @keyframes pulse-logo {
      0% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.8)); }
      100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
    }

    /* Progress Bar Container */
    .loader-container {
      width: 200px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      margin-bottom: 1rem;
    }

    /* Moving Bar */
    .loader-bar {
      height: 100%;
      width: 0%; /* JS will animate this */
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
      transition: width 0.1s linear;
    }

    /* Text Status */
    .loading-text {
      font-family: 'Inter', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      color: #94a3b8;
      letter-spacing: 0.05em;
      min-height: 1.2em; /* Prevent layout shift */
    }
    #maintenancePopup[style*="none"] *,
    #successPopup:not(.show) *,
    #splashScreen[style*="none"] * {
        animation-play-state: paused !important;
    }
    .modal-container, .alert-card, .success-card, .maintenance-card {
        /* ... existing styles ... */
        
        /* ADD THESE TWO LINES: */
        will-change: transform, opacity; 
        backface-visibility: hidden;
    }
    
    /* ================= NEW NOTIFICATION PANEL STYLES ================= */

/* 1. Backdrop */
.notif-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.4); /* Light dark tint */
  backdrop-filter: blur(4px);
  z-index: 11000; /* High z-index to sit above header */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  display: flex; /* Critical for alignment */
}
.notif-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

/* 2. The Panel (Slide from Right on Desktop, Bottom on Mobile) */
.notif-panel {
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: -10px 0 40px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  width: 100%;
}

/* Mobile: Bottom Sheet */
@media (max-width: 639px) {
  .notif-panel {
    bottom: 0; left: 0; right: 0;
    height: 85vh;
    border-radius: 1.5rem 1.5rem 0 0;
    transform: translateY(100%);
  }
  .notif-overlay.active .notif-panel {
    transform: translateY(0);
  }
}

/* Desktop: Right Sidebar */
@media (min-width: 640px) {
  .notif-panel {
    top: 0; right: 0; bottom: 0;
    width: 400px;
    border-left: 1px solid rgba(255,255,255,0.5);
    transform: translateX(100%);
  }
  .notif-overlay.active .notif-panel {
    transform: translateX(0);
  }
}

/* 3. Notification Items */
.n-item {
  display: flex; gap: 1rem; padding: 1rem;
  border-radius: 1rem; background: white;
  border: 1px solid #f1f5f9; margin-bottom: 0.75rem;
  position: relative;
  opacity: 0; /* Hidden initially for animation */
  transform: translateY(20px);
  transition: all 0.2s;
}

/* Animation Class applied via JS */
.n-item.animate-in {
  animation: slideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

.n-item.unread::before {
  content: ''; position: absolute; left: 0; top: 1rem; bottom: 1rem;
  width: 4px; background: #3b82f6; border-radius: 0 4px 4px 0;
}

.icon-box {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 1.1rem;
}

/* Icon Colors */
.icon-success { background: #dcfce7; color: #16a34a; }
.icon-warn { background: #fee2e2; color: #ef4444; }
.icon-info { background: #eff6ff; color: #3b82f6; }
.icon-promo { background: #ffedd5; color: #f97316; }

@keyframes slideInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ================= ANDROID NOTIFICATION OVERLAY ================= */
#notification-container {
  position: fixed;
  top: 1rem;
  left: 1rem;
  right: 1rem;
  z-index: 20000; /* Above all modals */
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.droid-notify {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 1.5rem;
  padding: 1rem 1.25rem;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
  pointer-events: auto;
  opacity: 0;
  transform: translateY(-50px) scale(0.9);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
  touch-action: none; 
  user-select: none;
  font-family: 'Inter', sans-serif;
}
/* Add this to your existing CSS */
#notification-container {
    padding-top: env(safe-area-inset-top); /* Supports modern mobile notches */
}

.droid-notify {
    /* Prevents notifications from being too wide on tablets */
    max-width: 92vw; 
}

/* Add a slight scale-down for notifications further down the stack */
.droid-notify ~ .droid-notify {
    transform: scale(0.95) translateY(-10px);
    opacity: 0.8;
}
.droid-notify.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* Swipe Animation Classes */
.swipe-left { transform: translateX(-120%) !important; opacity: 0; transition: all 0.3s ease-in !important; }
.swipe-right { transform: translateX(120%) !important; opacity: 0; transition: all 0.3s ease-in !important; }
.swipe-up { transform: translateY(-150%) !important; opacity: 0; transition: all 0.3s ease-in !important; }

.notify-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
.header-left { display: flex; align-items: center; gap: 0.5rem; }
.app-icon-small { width: 20px; height: 20px; border-radius: 50%; overflow: hidden; }
.app-name { font-size: 0.7rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.notify-time { font-size: 0.7rem; color: #94a3b8; }

.notify-content { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
.notify-title { font-size: 0.95rem; font-weight: 800; color: #1e293b; line-height: 1.2; }
.notify-body { font-size: 0.85rem; color: #64748b; line-height: 1.4; }
.money-green { color: #10b981; font-weight: 800; }

.large-icon-box { 
  width: 42px; height: 42px; border-radius: 12px; 
  display: flex; align-items: center; justify-content: center; 
  font-size: 1.25rem; flex-shrink: 0; 
}
.icon-bg-earn { background: #ecfdf5; color: #10b981; }
.icon-bg-error { background: #fef2f2; color: #ef4444; }
.icon-bg-info { background: #eff6ff; color: #3b82f6; }
/* Ensure the history list is scrollable and visible */
#notif-history-section.active {
    display: block !important;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
    background: #f8fafc;
    overflow-y: auto;
    padding-bottom: 100px !important; /* Space for bottom nav */
}

/* Ensure the list container has some breathing room */
#notif-history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
/* ================= SCROLLBAR CONTROL ================= */

/* 1. GLOBAL: Hide Scrollbar (Chrome, Safari, Opera) */
::-webkit-scrollbar {
    display: none;
    width: 0px;
    background: transparent;
}

/* 1. GLOBAL: Hide Scrollbar (Firefox, IE, Edge) */
* {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* 2. EXCEPTION: Profile Section (Show & Style Scrollbar) */
#profile-section::-webkit-scrollbar {
    display: block; /* Force display */
    width: 5px;     /* Thin width */
}

#profile-section::-webkit-scrollbar-track {
    background: transparent; 
}

#profile-section::-webkit-scrollbar-thumb {
    background-color: #cbd5e1; /* Smooth Slate Color */
    border-radius: 20px;
    border: 2px solid transparent; /* padding around thumb */
    background-clip: content-box;
}

/* Restore Firefox support specifically for Profile */
#profile-section {
    -ms-overflow-style: auto;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}
</style>
</head>
<body class="flex flex-col min-h-screen" oncontextmenu="return false;">
<div id="splashScreen">
    
    <img src="https://worldnews24x7.infy.uk/image/advault3.png" alt="AdVault Logo" class="splash-logo">

    <div class="loader-container">
        <div class="loader-bar" id="loadingBar"></div>
    </div>

    <p class="loading-text" id="loadingStatus">Initializing...</p>

  </div>
  <!-- Maintenance Mode Popup -->
 <div id="maintenancePopup" style="display: none;">
    <div class="tech-grid-bg"></div>

    <div class="maintenance-card">
        
        <div class="icon-container">
            <i class="fas fa-cog gear-main"></i>
            <i class="fas fa-cog gear-small"></i>
            <i class="fas fa-bolt sparkle"></i>
        </div>

        <h2 class="maint-title">System Upgrade</h2>
        
        <p class="maint-desc">
            We are currently updating our servers to make AdVault faster and more secure. We'll be back shortly!
        </p>

        <div class="status-badge">
            <div class="status-dot"></div>
            <span class="text-xs font-bold text-blue-700 uppercase tracking-wide">Work in progress</span>
        </div>

        <a href="https://t.me/AdVault_Group" target="_blank" class="telegram-btn">
            <i class="fab fa-telegram-plane text-xl"></i>
            <span>Check Updates on Telegram</span>
        </a>

        <button class="refresh-btn" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Try Refreshing
        </button>

    </div>
  </div>
  <!-- Ad Overlay for Extra Earnings -->
 <div id="adOverlay">
    
    <div class="ad-header">
        <div class="timer-pill">
            <div id="timerSpinner" class="timer-spinner"></div>
            <span id="adHeaderTimer" class="timer-text">Wait 00:00</span>
        </div>

        <div class="hidden sm:block text-slate-400 text-xs font-semibold tracking-wide uppercase">
            Sponsor Content
        </div>

        <button id="closeAdBtn" class="close-btn-modern">
            <i class="fas fa-lock text-sm"></i>
        </button>
    </div>

    <div id="adContainer" class="ad-content-wrapper">
        </div>

    <div class="ad-footer">
        <div id="adFooterMessage" class="status-message">
            <i class="fas fa-eye text-blue-400 text-xs"></i>
            <span>Stay on this page to earn reward</span>
        </div>

        <div class="progress-container">
            <div id="adProgressBar" class="progress-bar-fill"></div>
        </div>
    </div>

  </div>
  <!-- Firebase Loading Indicator -->
  <div class="firebase-loading" id="firebaseLoading">
    <div class="firebase-loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Telegram Warning Popup -->
 <div id="telegramWarningPopup" style="display: none;">
    <div class="security-pattern"></div>

    <div class="warning-card">
        
        <div class="icon-wrapper">
            <div class="icon-bg"></div>
            <i class="fab fa-telegram-plane telegram-icon"></i>
            <div class="lock-badge">
                <i class="fas fa-lock"></i>
            </div>
        </div>

        <h2 class="warning-title">Telegram Required</h2>
        <p class="warning-desc">
            AdVault is designed to run exclusively within the Telegram app to ensure account security and proper reward tracking.
        </p>

        <a href="https://t.me/AdVault_3bot" class="open-bot-btn">
            <i class="fab fa-telegram-plane text-xl"></i>
            <span>Open Telegram Bot</span>
        </a>

        <div class="manual-link">
            <a href="#" onclick="location.reload(); return false;">
                <i class="fas fa-sync-alt mr-1"></i> Refresh Page
            </a>
        </div>
        
    </div>
  </div>


  <!-- Instructions Popup -->
  <div id="instructionsPopup" class="fixed inset-0 bg-black bg-opacity-60 z-[11000] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl transform transition-all relative">
        
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                <i class="fas fa-book-open text-blue-500"></i> App Guide
            </h3>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-4">
            
            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-eye text-green-500"></i> Ad Watching Rules
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Watch ads for the full <span id="instructionAdDuration" class="font-bold text-gray-900">15</span> seconds. Closing early results in penalties and no reward.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-coins text-yellow-500"></i> Earning System
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Each task earns you <span id="instructionEarningsPerAd" class="font-bold text-gray-900">0.05</span> BDT. Complete daily tasks to maximize income.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-ban text-red-500"></i> Penalty System
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Early closing blocks the ad button for <span id="instructionPenaltyDuration" class="font-bold text-gray-900">2</span> minutes. Repeated issues may freeze your account.
                </div>
            </div>
            
            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-wallet text-purple-500"></i> Withdrawal
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Minimum withdrawal is <span id="instructionMinWithdrawal" class="font-bold text-gray-900">100</span> BDT. Setup payment info in Profile first.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-headset text-blue-400"></i> Support
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Questions? Contact us via the official Telegram bot or group.
                </div>
            </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
            <button onclick="hideInstructionsPopup()" class="w-full py-3.5 bg-white border border-gray-300 text-gray-700 font-bold text-lg rounded-xl shadow-sm hover:bg-gray-100 active:scale-95 transition-all">
                Close Guide
            </button>
        </div>

    </div>
</div>
  
  <!-- Dynamic Payment Edit Modal -->
  <div id="dynamicPaymentEditModal" style="display: none;">
    <div class="modal-content">
      <button id="closeDynamicPaymentModal" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
      <h2 class="text-2xl font-bold text-gray-800 mb-5 text-center">Edit Payment Information</h2>
      
      <div id="dynamicPaymentForm" class="space-y-4">
        <!-- Dynamic payment fields will be inserted here -->
      </div>
      
      <button id="saveDynamicPaymentBtn" class="btn-primary w-full mt-8 py-3">
        Save Payment Information
      </button>
    </div>
  </div>

  <!-- New Success Modal for Withdraw Section -->
  <div class="new-modal-overlay" id="new-successModal">
    <div class="new-modal-content text-center">
      <div class="checkmark-wrapper">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">Request Submitted!</h2>
      <p class="text-gray-500 mb-6" id="new-successMessage">Your withdrawal is being processed.</p>
      <button class="btn-primary w-full" onclick="document.getElementById('new-successModal').classList.remove('active')">Done</button>
    </div>
  </div>

  <!-- New Dynamic Payment Edit Modal for Withdraw Section -->
  <div id="new-dynamicPaymentEditModal" class="new-modal-overlay">
    <div class="new-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Edit Payment Info</h2>
        <button id="new-closeDynamicPaymentModal" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
      </div>
      <div id="new-dynamicPaymentForm" class="space-y-4">
        <!-- Dynamic payment fields will be inserted here -->
      </div>
      <button id="new-saveDynamicPaymentBtn" class="btn-primary w-full mt-6">Save Information</button>
    </div>
  </div>

  <!-- Notification Banner -->
 <div id="notification-container"></div>

  <!-- Telegram Connection Indicator -->
  <div class="telegram-connected" id="telegramConnected">
    <i class="fab fa-telegram mr-2"></i>Connected to Telegram
  </div>

  <!-- Success Popup -->
<div id="successPopup">
    <div class="success-card">
      
      <div class="icon-wrapper">
        <div class="icon-circle"></div>
        
        <div class="svg-container">
            <svg class="checkmark-svg" viewBox="0 0 52 52">
                <path d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
        </div>
        
        <div class="burst-core">
            <span class="bg-green-400"></span>
            <span class="bg-blue-400"></span>
            <span class="bg-yellow-400"></span>
            <span class="bg-red-400"></span>
            <span class="bg-purple-400"></span>
            <span class="bg-orange-400"></span>
        </div>
      </div>

      <h2 class="success-title" id="popupTitle">Success!</h2>
      <p class="success-desc" id="popupMessage">Action completed successfully.</p>

      <button class="success-btn" onclick="closeSuccessPopup()">
        Continue
      </button>

    </div>
  </div>
  <!-- Header -->
 <header class="watermark-header" id="main-header">
    
    <div class="brand-watermark">
      <span class="watermark-text">ADVAULT</span>
    </div>

    <div class="header-content">
      
     <div class="user-pill" onclick="showSection('profile-section')">
        <div class="avatar-circle">
            
            <div id="headerProfileImage" class="avatar-img-wrapper">
                <i class="fas fa-user-astronaut text-blue-500"></i>
            </div>

            <div class="status-dot"></div>
            
        </div>
        <div>
           <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide" id="greeting-text">Good Morning</p>
           <p class="text-sm font-extrabold text-slate-800 leading-none" id="header-username">@User</p>
        </div>
      </div>
      <div class="action-group">
        
        <div class="flag-pill">
          <span class="text-lg leading-none" id="country-flag"></span>
          <span id="country-code-text">BD</span>
        </div>

        <button class="notif-btn" onclick="openNotificationsModal()">
          <i class="far fa-bell text-lg"></i>
          <span id="notificationDot" class="red-dot hidden"></span>
        </button>

      </div>

    </div>
  </header>
  <!-- Main Content -->
  <main class="flex-grow p-4 pt-20 pb-20 space-y-6 container mx-auto">
    <!-- Home Section -->
  <div id="home-section" class="section active">
      
      <div class="ticker-pill mt-2">
        <div class="w-6 h-6 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-xs shrink-0">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="flex-1 overflow-hidden">
          <p class="text-xs font-bold text-slate-700 truncate" id="marqueeTextHome">
            Daily Bonus: Tasks pay +10% today!
          </p>
        </div>
        <i class="fas fa-chevron-right text-[10px] text-slate-400"></i>
      </div>

      <div class="wallet-hero">
        <div class="flex justify-between items-start mb-6">
          <div>
            <p class="text-slate-300 text-xs font-semibold uppercase tracking-wider mb-1">Current Balance</p>
            <h1 class="text-3xl font-extrabold tracking-tight" id="home-earnings-val">BDT 0.00</h1>
          </div>
          <div class="bg-white/10 backdrop-blur-md p-2 rounded-lg border border-white/10 text-white/80">
            <i class="fas fa-wallet text-lg"></i>
          </div>
        </div>
        
        <div class="flex items-center justify-between">
           <div class="flex items-center gap-2">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              <span class="text-[10px] font-medium text-slate-300">Live Updates</span>
           </div>
           <span class="text-[10px] font-bold bg-green-500/20 text-green-100 px-2 py-1 rounded border border-green-500/30">
             BDT
           </span>
        </div>
      </div>

      <div class="quick-actions">
        <button class="action-btn" onclick="showSection('earn-section')">
          <div class="icon-sq text-blue-600">
            <i class="fas fa-play"></i>
          </div>
          <span class="action-label">Earn</span>
        </button>

        <button class="action-btn" onclick="showSection('withdraw-section')">
          <div class="icon-sq text-emerald-600">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <span class="action-label">Withdraw</span>
        </button>

        <button class="action-btn" onclick="showSection('earning-history-section'); renderEarningHistory();">
          <div class="icon-sq text-purple-600">
            <i class="fas fa-history"></i>
          </div>
          <span class="action-label">History</span>
        </button>

        <button class="action-btn" onclick="window.open('https://t.me/AdVault_Group', '_blank')">
          <div class="icon-sq text-orange-500">
            <i class="fas fa-headset"></i>
          </div>
          <span class="action-label">Support</span>
        </button>
      </div>

      <h3 class="text-sm font-bold text-slate-800 mb-3 ml-1">Today's Overview</h3>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="flex justify-between items-start mb-2">
             <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
               <i class="fas fa-eye text-sm"></i>
             </div>
             <span class="text-[10px] font-bold text-slate-400 uppercase">Daily</span>
          </div>
          <p class="text-xs text-slate-400 font-bold mb-0.5">Ads Watched</p>
          <div class="flex items-baseline gap-1">
            <span class="text-lg font-bold text-slate-800" id="home-ads-val">0</span>
            <span class="text-[10px] text-slate-400" id="home-ads-target">/ 1000</span>
          </div>
          <div class="progress-line-bg">
            <div class="progress-line-fill" id="home-ads-progress" style="width: 0%"></div>
          </div>
        </div>

        <div class="stat-card">
          <div class="flex justify-between items-start mb-2">
             <div class="w-8 h-8 rounded-lg bg-green-50 text-green-600 flex items-center justify-center">
               <i class="fas fa-check-circle text-sm"></i>
             </div>
             <span class="text-[10px] font-bold text-slate-400 uppercase">Lifetime</span>
          </div>
          <p class="text-xs text-slate-400 font-bold mb-0.5">Total Paid Out</p>
          <div class="flex items-baseline gap-1">
            <span class="text-[10px] text-slate-500">BDT</span>
            <span class="text-lg font-bold text-slate-800" id="home-lifetime-val">0.00</span>
          </div>
          <div class="mt-2 text-[10px] text-green-600 font-bold flex items-center gap-1">
             <i class="fas fa-arrow-up"></i> Growing
          </div>
        </div>
      </div>
    </div>
    <!-- Earn Section -->
 <div id="earn-section" class="section">
      
      <div class="flex items-center justify-between mb-4 pt-2">
        <div>
          <h1 class="text-2xl font-bold text-slate-800">Daily Tasks</h1>
          <p class="text-xs text-slate-500 font-medium">Complete tasks to earn money</p>
        </div>
        <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold border border-blue-100 flex items-center gap-1 shadow-sm">
          <i class="fas fa-trophy text-[10px]"></i> Level 1
        </div>
      </div>

      <div class="goal-card">
        <div class="flex justify-between items-center mb-2">
          <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Today's Goal</span>
          <span class="text-[10px] font-medium text-slate-400 bg-slate-50 px-2 py-0.5 rounded">Resets daily</span>
        </div>
        
        <div class="flex items-baseline gap-1">
          <span class="text-4xl font-bold text-slate-800" id="earn-completed">0</span>
          <span class="text-sm text-slate-400 font-medium">/ <span id="earn-total">1000</span></span>
        </div>

        <div class="progress-track">
          <div id="earn-progress-bar" class="progress-fill" style="width: 0%;"></div>
        </div>

        <div class="flex justify-between text-xs font-medium text-slate-500">
          <div class="flex items-center gap-1.5">
            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
            <span>Completed</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-slate-400">Remaining:</span>
            <span class="text-slate-800 font-bold" id="earn-remaining">1000</span>
          </div>
        </div>
      </div>

      <div class="task-card">
        <div class="task-icon-circle">
          <i class="fas fa-play"></i>
        </div>
        
        <h3 class="text-lg font-bold text-slate-800">Watch Video Ad</h3>
        
        <div class="flex items-center gap-3 my-4 text-sm">
          <span class="bg-green-100 text-green-700 px-2.5 py-1 rounded-md text-xs font-bold border border-green-200">
            +<span id="earningsPerAdDisplay">0.05</span> BDT
          </span>
          <span class="text-slate-300"></span>
          <span class="text-slate-500 flex items-center gap-1.5 font-medium">
            <i class="far fa-clock"></i> <span id="adDurationDisplay">15</span>s
          </span>
        </div>

        <button id="startEarningAd" class="earn-btn">
          <span id="adButtonText">Start Task</span> <i class="fas fa-arrow-right text-xs opacity-70"></i>
        </button>
        
        <div id="penaltyWarningCard" class="penalty-card-modern">
          <div class="flex items-center gap-2 text-red-600 font-bold text-sm mb-2">
            <i class="fas fa-exclamation-triangle"></i> Ad Closed Too Early
          </div>
          <ul class="penalty-list">
            <li><i class="fas fa-times-circle"></i> Must watch for <span id="penaltyAdDuration">15</span> seconds</li>
            <li><i class="fas fa-lock"></i> Task locked for <span id="penaltyDurationDisplay">2</span> minutes</li>
          </ul>
          <div class="text-right mt-2">
             <span class="text-xs text-blue-500 font-medium cursor-pointer hover:underline" id="showInstructions">View Rules</span>
          </div>
        </div>
      </div>
      
      <div id="extraTasksContainer" class="grid gap-4 mb-6">
        </div>
      
      <div id="noAdsMsg" class="hidden text-center text-slate-400 text-sm py-8 italic bg-slate-50 rounded-xl mb-6 border border-slate-100">
          <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-2 text-slate-300">
             <i class="fas fa-box-open text-xl"></i>
          </div>
          No bonus tasks available right now.
      </div>

      <div class="invite-banner">
        <i class="fas fa-gift invite-deco"></i>
        <h3 class="text-xl font-bold mb-1">Invite Friends</h3>
        <p class="text-orange-100 text-sm mb-4 max-w-[85%] leading-relaxed opacity-90">Get bonuses for every friend who joins.</p>
        
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3 mb-4 border border-white/20">
          <div class="flex justify-between items-center mb-1">
            <p class="text-[10px] text-orange-50 uppercase font-bold tracking-wider">Referral Link</p>
            <span class="text-[10px] bg-black/20 px-1.5 rounded text-white/80">0 refs</span>
          </div>
          <p class="font-mono text-sm truncate select-all text-white">Coming Soon</p>
        </div>

        <button id="inviteFriendsBtn" class="btn-white">
          <i class="fas fa-share-alt mr-2"></i> Share Invite Link
        </button>
      </div>
      
      <div class="h-12"></div>

    </div>
    
    <!-- earnings history-->
<div id="earning-history-section" class="section section-fullscreen bg-slate-50" style="position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; padding: 0 !important; margin: 0 !important; height: 100% !important; z-index: 2000;">
        
        <div class="flex flex-col h-full w-full overflow-hidden">
            
            <div class="shrink-0 z-50 bg-slate-50 px-4 pt-8 pb-2 shadow-sm relative">
                
                <div class="flex items-center gap-3 mb-4">
                    <button onclick="showSection('home-section')" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm hover:text-blue-600 transition-all shrink-0 active:scale-95">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 leading-tight">Earning Activity</h1>
                        <p class="text-xs text-gray-500">Your last 3 days of history</p>
                    </div>
                </div>

                <div class="summary-card-history mb-4">
                    <div class="flex items-center gap-2 text-xs font-semibold uppercase opacity-80 mb-1">
                        <i class="far fa-clock"></i> Recent 72h
                    </div>
                    <div class="text-3xl font-extrabold" id="history-total-72h">+ BDT 0.00</div>
                    <p class="text-xs text-blue-100 mt-2 opacity-80">Saved on device storage</p>
                </div>

                <div class="tab-row">
                    <button class="tab-pill active" onclick="filterEarningHistory('all', this)">All</button>
                    <button class="tab-pill" onclick="filterEarningHistory('ad', this)">Video Ads</button>
                    <button class="tab-pill" onclick="filterEarningHistory('task', this)">Special Tasks</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-4 pb-20 pt-2" id="historyScrollArea">
                
                <div id="earningHistoryContainer">
                    <div class="text-center py-10 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2 text-sm">Loading history...</p>
                    </div>
                </div>
                
                <div class="text-center p-4 border-t border-dashed border-gray-200 mt-4 text-xs text-gray-400">
                    History older than 3 days is automatically removed.
                </div>
            </div>
            
        </div>
    </div>
    <!-- NEW Withdraw Section (Replaced with improved UI) -->
    <div id="withdraw-section" class="section section-fullscreen bg-slate-50">
      
      <div class="px-5 pt-8 pb-4">
          <div class="flex items-center gap-3 mb-6">
             <button onclick="showSection('home-section')" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm hover:text-blue-600 transition-all active:scale-95">
                <i class="fas fa-arrow-left"></i>
             </button>
             <div>
                <h1 class="text-2xl font-bold text-slate-800 leading-none">Withdraw Funds</h1>
                <p class="text-xs text-slate-500 font-medium mt-1">Transfer earnings to your account</p>
             </div>
          </div>

          <div class="withdraw-balance-card">
            <div class="flex items-center gap-2 text-green-100 mb-1">
              <i class="fas fa-wallet text-sm"></i>
              <span class="text-xs font-semibold uppercase tracking-wider">Available Balance</span>
            </div>
            <h2 class="text-3xl font-bold" id="withdraw-balance-display">BDT 0.00</h2>
            <p class="text-xs text-green-50 mt-4 opacity-90">Min. withdraw: BDT <span id="minWithdrawDisplay">100.00</span></p>
          </div>

          <label class="section-label">Select Method</label>
          <div id="withdrawMethodGrid" class="payment-grid">
             <div class="col-span-2 text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i> Loading methods...</div>
          </div>

          <div id="sendingToBox" class="account-info-box hidden">
              <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs">
                      <i class="fas fa-user"></i>
                  </div>
                  <div>
                      <p class="text-[10px] text-blue-500 font-bold uppercase">Sending to</p>
                      <p class="text-sm font-semibold text-slate-700" id="sendingToNumber">--</p>
                  </div>
              </div>
              <button onclick="showSection('payment-methods-section'); renderPaymentMethodsPage();" class="text-xs bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-lg font-medium hover:bg-blue-50">Change</button>
          </div>
          
          <div id="linkAccountMsg" class="hidden mb-6 p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm border border-yellow-200 flex items-center justify-between">
              <span><i class="fas fa-exclamation-circle mr-1"></i> No account linked.</span>
              <button onclick="showSection('payment-methods-section'); renderPaymentMethodsPage();" class="font-bold underline">Link Now</button>
          </div>

          <label class="section-label">Enter Amount</label>
          <div class="amount-container">
            <span class="currency-symbol">BDT</span>
            <input type="number" id="withdrawAmountInput" class="amount-input" placeholder="0.00" oninput="updateWithdrawSummary()">
          </div>

          <div class="quick-amounts">
            <button class="pill-btn" onclick="setWithdrawAmount(100)">100</button>
            <button class="pill-btn" onclick="setWithdrawAmount(200)">200</button>
            <button class="pill-btn" onclick="setWithdrawAmount(500)">500</button>
            <button class="pill-btn" onclick="setWithdrawAmount(1000)">1000</button>
            <button class="pill-btn" onclick="setWithdrawAmount('max')">Max</button>
          </div>

          <div class="summary-box">
            <div class="summary-row">
              <span>Withdraw Amount</span>
              <span class="font-medium text-slate-700" id="summaryAmount">BDT 0.00</span>
            </div>
            <div class="summary-row">
              <span>Fee (0%)</span>
              <span class="font-medium text-slate-500" id="summaryFee">- BDT 0.00</span>
            </div>
            <div class="summary-row total">
              <span>You Receive</span>
              <span class="text-green-600" id="summaryTotal">BDT 0.00</span>
            </div>
          </div>

          <button onclick="submitWithdrawal()" class="withdraw-btn mb-8">
            Confirm Withdrawal <i class="fas fa-arrow-right text-xs opacity-70"></i>
          </button>
          
          <div class="flex justify-between items-center mb-4">
              <span class="font-bold text-slate-800">Recent Activity</span>
              <a href="#" onclick="showSection('withdrawal-history-section'); fetchWithdrawalHistory();" class="text-xs text-blue-600 font-medium">View All</a>
          </div>
          <div id="miniWithdrawHistory">
              </div>

          <div class="h-12"></div>
      </div>
    </div>
<div id="payment-methods-section" class="section section-fullscreen bg-slate-50" style="z-index: 2000;">
      
      <div class="pt-8 px-5 pb-6">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-4">
             <button onclick="showSection('profile-section'); updateUI();" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm hover:text-blue-600 transition-all active:scale-95">
                <i class="fas fa-arrow-left"></i>
             </button>
             <div>
                <h1 class="text-2xl font-bold text-slate-800 leading-none">My Wallets</h1>
                <p class="text-xs text-slate-500 font-medium mt-1">Manage payment methods</p>
             </div>
          </div>
          <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm border border-blue-100">
             <i class="fas fa-wallet"></i>
          </div>
        </div>

        <div class="pb-32 w-full">
            
            <div id="paymentMethodsGrid" class="grid gap-4 w-full">
               <div class="text-center py-10 text-gray-400">
                  <i class="fas fa-spinner fa-spin text-2xl"></i>
               </div>
            </div>

            <div id="paymentMethodEditor" class="edit-sheet mt-6">
               <div class="flex items-center justify-between mb-4">
                  <h3 class="font-bold text-slate-800 flex items-center gap-2">
                      <i class="fas fa-pen-square text-blue-500"></i> Edit Details
                  </h3>
                  <button type="button" onclick="clearCurrentPaymentMethod()" class="delete-btn-text">
                    <i class="fas fa-trash-alt mr-1"></i> Unlink
                  </button>
               </div>

               <form id="paymentEditForm" onsubmit="event.preventDefault(); saveCurrentPaymentMethod();">
                  <input type="hidden" id="editMethodId">
                  
                  <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2" id="editMethodLabel">Account Number</label>
                    <div class="relative">
                      <input type="text" id="editMethodValue" class="modern-input w-full" placeholder="Enter details...">
                      <i class="fas fa-pen absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-xs"></i>
                    </div>
                  </div>

                  <button type="submit" class="save-btn-primary w-full">
                    <i class="fas fa-check-circle"></i> Save Changes
                  </button>
               </form>
            </div>
            
            <div class="text-center mt-8 px-4">
                <p class="text-xs text-slate-400 leading-relaxed max-w-xs mx-auto">
                    <i class="fas fa-shield-alt mr-1"></i> Data encrypted. Select a card above to edit or link a new account.
                </p>
            </div>

        </div>
      </div>
    </div>
    <!-- Withdrawal History Section -->
 <div id="withdrawal-history-section" class="section section-fullscreen bg-slate-50" style="position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; padding: 0 !important; margin: 0 !important; height: 100% !important; overflow-y: auto !important; z-index: 2000;">
        
        <div class="bg-white px-5 pt-8 pb-4 border-b border-gray-100 sticky top-0 z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="showSection('profile-section')" class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-slate-600 active:bg-gray-50 transition-all hover:text-blue-600">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold text-slate-800">History</h1>
            </div>
        </div>

        <div id="withdrawalHistoryList" class="history-container">
            <div class="text-center py-20">
                <i class="fas fa-circle-notch fa-spin text-gray-300 text-3xl"></i>
            </div>
        </div>

    </div>

    <!-- Profile Section -->
   <div id="profile-section" class="section section-fullscreen" style="padding: 0 !important;">
      
      <div class="profile-header pt-8 pb-4 px-4 bg-slate-50/50">
        <div class="avatar-ring">
          <div id="profileImageContainer" class="avatar-inner">
            <i class="fas fa-user text-3xl text-gray-300"></i>
          </div>
          </div>

        <h2 class="text-xl font-bold text-slate-800" id="profileName">Loading...</h2>
        <p class="text-sm text-slate-500 font-medium" id="profileUsername">@username</p>
        
        <div class="id-badge">
          <i class="fas fa-fingerprint text-xs"></i>
          <span id="profileId">ID: ---</span>
        </div>
      </div>

      <div class="px-4 pb-24">
          
          <div class="balance-card-glass">
            <div class="flex justify-between items-start mb-2">
              <span class="text-slate-300 text-xs font-medium uppercase tracking-wider">Available Wallet</span>
              <button id="refreshBalance" class="text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            
            <h1 class="text-4xl font-bold mb-1" id="profileBalance">BDT 0.00</h1>
            <p class="text-xs text-emerald-400 mb-4 flex items-center gap-1">
                <i class="fas fa-check-circle"></i> Account Verified
            </p>

            <div class="balance-btn-row">
              <button class="balance-btn" onclick="showSection('withdraw-section')">
                <i class="fas fa-arrow-down"></i> Withdraw
              </button>
              <button class="balance-btn" onclick="showSection('withdrawal-history-section'); fetchWithdrawalHistory();">
                <i class="fas fa-clock"></i> History
              </button>
            </div>
          </div>

          <div class="stats-grid-profile">
            <div class="stat-box">
              <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center mb-2">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <p class="text-slate-400 text-xs font-bold uppercase">Total Earned</p>
              <p class="text-slate-800 font-bold text-lg truncate" id="profileEarnings">0.00</p>
            </div>

            <div class="stat-box">
              <div class="w-8 h-8 rounded-lg bg-green-50 text-green-600 flex items-center justify-center mb-2">
                <i class="fas fa-play"></i>
              </div>
              <p class="text-slate-400 text-xs font-bold uppercase">Ads Watched</p>
              <p class="text-slate-800 font-bold text-lg" id="profileAds">0</p>
            </div>

            <div class="stat-box">
              <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center mb-2">
                <i class="fas fa-check-circle"></i>
              </div>
              <p class="text-slate-400 text-xs font-bold uppercase">Withdrawn</p>
              <p class="text-slate-800 font-bold text-lg truncate" id="profileWithdrawn">0.00</p>
            </div>

            <div class="stat-box">
              <div class="w-8 h-8 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center mb-2">
                <i class="fas fa-users"></i>
              </div>
              <p class="text-slate-400 text-xs font-bold uppercase">Referrals</p>
              <p class="text-slate-800 font-bold text-lg" id="profileReferrals">0</p>
            </div>
          </div>

        <div class="menu-section">
  <div class="menu-label">Finance & Wallet</div>
  <div class="menu-group">
    <div class="menu-item" onclick="showSection('payment-methods-section')">
      <div class="menu-icon bg-blue-50 text-blue-600">
        <i class="fas fa-credit-card"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">Payment Methods</p>
        <p class="text-[10px] text-slate-400" id="paymentMethodStatus">Manage withdrawal accounts</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>
  </div>
</div>

<div class="menu-section">
  <div class="menu-label">Activity & Support</div>
  <div class="menu-group">
    <div class="menu-item" onclick="showSection('notif-history-section')">
      <div class="menu-icon bg-amber-50 text-amber-600">
        <i class="fas fa-bell"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">Alert History</p>
        <p class="text-[10px] text-slate-400">View your recent notifications</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>

    <div class="menu-item" onclick="window.open('https://t.me/AdVault_Group', '_blank')">
      <div class="menu-icon bg-sky-50 text-sky-500">
        <i class="fab fa-telegram-plane"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">Community Support</p>
        <p class="text-[10px] text-slate-400">Join official Telegram group</p>
      </div>
      <i class="fas fa-external-link-alt text-[10px] text-slate-300"></i>
    </div>

    <div class="menu-item" onclick="toggleAboutModal()">
      <div class="menu-icon bg-slate-50 text-slate-500">
        <i class="fas fa-info-circle"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">About AdVault</p>
        <p class="text-[10px] text-slate-400">App version and build info</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>
  </div>
</div>

<div class="menu-section">
  <div class="menu-label">Help & Legal</div>
  <div class="menu-group">
    
    <div class="menu-item" onclick="showInstructionsPopup()">
      <div class="menu-icon bg-purple-50 text-purple-600">
        <i class="fas fa-book-open"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">App Guide</p>
        <p class="text-[10px] text-slate-400">Rules & earning instructions</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>

    <div class="menu-item" onclick="openLegal('terms')">
      <div class="menu-icon bg-slate-100 text-slate-600">
        <i class="fas fa-file-contract"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">Terms of Service</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>

    <div class="menu-item" onclick="openLegal('privacy')">
      <div class="menu-icon bg-blue-50 text-blue-500">
        <i class="fas fa-user-shield"></i>
      </div>
      <div class="flex-1">
        <p class="text-sm font-bold text-slate-800">Privacy Policy</p>
      </div>
      <i class="fas fa-chevron-right text-[10px] text-slate-300"></i>
    </div>

  </div>
</div>
          <div class="text-center mt-6">
            <p class="text-[10px] text-slate-300 font-medium">AdVault Secured  2025</p>
          </div>
    <!-- Original Edit Payment Information Modal -->
    <div id="editModal" style="display: none;">
      <div class="modal-content">
        <button id="closeEditModal" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
        <h2 class="text-2xl font-bold text-gray-800 mb-5 text-center">Edit Payment Information</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-1">PayPal Email</label>
            <input id="editPaypal" type="email" placeholder="e.g. paypal@example.com" class="w-full p-3 border border-gray-300 rounded-lg">
            <div id="paypalError" class="validation-error">Please enter a valid PayPal email</div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1">Payoneer Email</label>
            <input id="editPayoneer" type="email" placeholder="e.g. payoneer@example.com" class="w-full p-3 border border-gray-300 rounded-lg">
            <div id="payoneerError" class="validation-error">Please enter a valid Payoneer email</div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1">bKash Number</label>
            <div class="flex border border-gray-300 rounded-lg">
              <span class="inline-flex items-center px-3 rounded-l-lg bg-gray-100 text-gray-600 text-sm">+88</span>
              <input id="editBkash" type="text" placeholder="01XXXXXXXXX" maxlength="11"
                     class="w-full p-3 rounded-r-lg text-gray-700">
            </div>
            <div id="bkashError" class="validation-error">Please enter a valid bKash number (e.g. 017XXXXXXXX or +88017XXXXXXXX)</div>
          </div>
        </div>

        <button id="saveProfileBtn" class="btn-primary w-full mt-8 py-3">
          Save Payment Information
        </button>
      </div>
    </div>
    
    <div id="notif-history-section" class="section section-fullscreen bg-slate-50" style="z-index: 2000;">
    <div class="pt-8 px-5 pb-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="showSection('profile-section')" class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm active:scale-95">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h1 class="text-2xl font-bold text-slate-800 leading-none">Alert History</h1>
                <p class="text-xs text-slate-500 font-medium mt-1">Recently received notifications</p>
            </div>
        </div>

        <div id="notif-history-list" class="space-y-3 pb-24">
            </div>

        <button onclick="clearNotifHistory()" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-red-50 text-red-500 px-6 py-2 rounded-full text-xs font-bold border border-red-100 shadow-sm">
            <i class="fas fa-trash-alt mr-1"></i> Clear All
        </button>
    </div>
</div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="fintech-bottom-nav">
    <ul class="nav-list">
      
      <li class="nav-item custom-nav-item active" data-target="home-section">
        <div class="nav-icon-box">
          <i class="fas fa-home"></i>
        </div>
        <span>Home</span>
      </li>

      <li class="nav-item custom-nav-item" data-target="earn-section">
        <div class="nav-icon-box">
          <i class="fas fa-wallet"></i>
        </div>
        <span>Earn</span>
      </li>
      

      <li class="nav-item custom-nav-item" data-target="profile-section">
        <div class="nav-icon-box">
          <i class="fas fa-user"></i>
        </div>
        <span>Profile</span>
      </li>

    </ul>
  </nav>
<div id="legalModal" class="legal-overlay">
    <div class="legal-card">
      
      <div class="legal-header">
        <h2 class="legal-title" id="legalTitle">
          </h2>
        <button class="close-legal-btn" onclick="closeLegal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="legal-body legal-text" id="legalContent">
        </div>

      <div class="legal-footer">
        <button class="accept-btn" onclick="closeLegal()">
          I Understand & Agree
        </button>
      </div>

    </div>
  </div>

  <div id="termsText" style="display:none;">
    <h3>1. Introduction</h3>
    <p>Welcome to AdVault. By accessing or using our mobile application, you agree to be bound by these Terms of Service.</p>
    
    <h3>2. Earning Mechanics</h3>
    <p>AdVault allows users to earn rewards by watching advertisements. We reserve the right to:</p>
    <ul>
        <li>Modify reward rates at any time without prior notice.</li>
        <li>Limit the number of ads available per user per day.</li>
        <li>Void earnings generated through automated bots or scripts.</li>
    </ul>

    <h3>3. Withdrawals</h3>
    <p>Withdrawals are processed manually within 24-48 hours. The minimum withdrawal amount is BDT 100.00. We are not responsible for funds lost due to incorrect account numbers.</p>

    <h3>4. Prohibited Conduct</h3>
    <p>You agree not to use VPNs, proxies, or multiple accounts on a single device. Violation of this rule will result in a permanent ban.</p>
  </div>

  <div id="privacyText" style="display:none;">
    <h3>1. Data Collection</h3>
    <p>We collect minimal data required to operate the service, including your Device ID, IP Address (for fraud prevention), and Telegram User ID.</p>
    
    <h3>2. Usage of Data</h3>
    <p>Your data is used solely for:</p>
    <ul>
        <li>Verifying task completion.</li>
        <li>Processing withdrawal requests.</li>
        <li>Preventing fraud and abuse.</li>
    </ul>

    <h3>3. Third-Party Services</h3>
    <p>We use third-party ad networks (e.g., Monetag) to display advertisements. These providers may collect their own data in accordance with their privacy policies.</p>

    <h3>4. Data Security</h3>
    <p>We implement standard security measures to protect your information. However, no method of transmission over the Internet is 100% secure.</p>
  </div>
  <div id="aboutModal">
    <div class="about-card">
      
      <button class="close-icon-btn" onclick="toggleAboutModal()">
        <i class="fas fa-times"></i>
      </button>

      <div class="app-logo-wrapper">
          <img src="https://worldnews24x7.infy.uk/image/advault3.png" alt="App Logo" class="w-full h-full object-cover">
      </div>

      <h2 class="text-xl font-extrabold text-slate-800">AdVault</h2>
      <p class="text-xs text-slate-400 font-medium">Premium Earning Platform</p>

      <div class="info-list">
          <div class="info-row">
              <span class="info-label">App Version</span>
              <span class="info-val">2.5.0 (Beta)</span>
          </div>
          <div class="info-row">
              <span class="info-label">Last Updated</span>
              <span class="info-val">Jan 25, 2026</span>
          </div>
          <div class="info-row">
              <span class="info-label">Developer</span>
              <span class="info-val">AdVault Team</span>
          </div>
      </div>

      <a href="https://t.me/AdVault_Channel" target="_blank" class="telegram-full-btn">
          <i class="fab fa-telegram-plane text-lg"></i>
          <span>Official Channel</span>
      </a>
      
      <div class="mt-6 text-[10px] text-slate-300">
          &copy; 2026 AdVault Inc. All rights reserved.
      </div>

    </div>
  </div>
 <div id="notifOverlay" class="notif-overlay" onclick="closeNotificationsModal()">
  <div class="notif-panel" onclick="event.stopPropagation()">
    
    <div class="flex justify-between items-center p-6 border-b border-slate-100 flex-shrink-0">
      <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
        Notifications 
        <span id="notifBadgeCount" class="bg-blue-100 text-blue-600 text-xs px-2 py-0.5 rounded-full hidden">New</span>
      </h2>
      <button class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors" onclick="markAllNotificationsRead()">
        Mark all read
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 no-scrollbar" id="notificationList">
       <div class="flex justify-center py-10">
          <div class="spinner border-gray-400"></div>
       </div>
    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 mt-auto">
      <button class="w-full py-3 bg-white border border-slate-200 text-slate-600 text-sm font-bold rounded-xl shadow-sm hover:bg-slate-50 transition-colors" onclick="closeNotificationsModal()">
        Close
      </button>
    </div>

  </div>
</div>
  
 

  <div id="confirmModal" class="alert-overlay">
    <div class="alert-card">
      <div class="alert-icon-box confirm-icon">
        <i class="fas fa-question"></i>
      </div>
      <h3 class="alert-title" id="confirmTitle">Are you sure?</h3>
      <p class="alert-desc" id="confirmMsg">This action cannot be undone.</p>
      
      <div class="alert-actions">
        <button class="btn-full btn-outline" onclick="closeModal('confirmModal')">
          Cancel
        </button>
        <button class="btn-full btn-slate" id="confirmYesBtn" onclick="confirmAction()">
          Yes, Proceed
        </button>
      </div>
    </div>
  </div>
<script>
    // Firebase configuration
    const firebaseConfig = {
  apiKey: "AIzaSyAH-6VEsx8Jp2KVeltSlvBFU1nn6M-2r1w",
  authDomain: "adbot-s4.firebaseapp.com",
  projectId: "adbot-s4",
  storageBucket: "adbot-s4.firebasestorage.app",
  messagingSenderId: "422990164333",
  appId: "1:422990164333:web:34c170382c4a87915f2a64"
};


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Collection names
    const USERS_COLLECTION = "adv2_users";
    const WITHDRAWALS_COLLECTION = "adv2_withdrawals";
    const ADMIN_SETTINGS_DOC_ID = "_admin_settings_";
    
    // User data
    let userData = {
        id: "",
        name: "",
        username: "",
        balance: 0.00,
        totalEarnings: 0.00,
        adsWatched: 0,
        completedTasks: 0,
        totalTasks: 1000,
        paypal: "",
        payoneer: "",
        bkash: "",
        lastResetDate: new Date().toISOString().slice(0, 10),
        telegramDetected: false,
        source: "web",
        country: "",
        profilePhoto: null,
        totalWithdrawn: 0.00,
        withdrawalCount: 0,
        referrals: 0,
        joinDate: new Date().toISOString(),
        lastNotificationCheck: new Date(0).toISOString(),
        paymentInfo: {} // For dynamic payment methods
    };

    // Admin settings with extended features
    let adminSettings = {
        // Original settings
        maintenanceMode: false,
        autoApprove: false,
        enablePenalty: true,
        minWithdrawal: 100,
        earningsPerAd: 0.05,
        dailyTasks: 1000,
        adDuration: 15,
        penaltyDuration: 2,
        lastUpdated: new Date().toISOString(),
        
        // Added features
        paymentMethods: [], // [{id, name, type}]
        marqueeSettings: { default: "Welcome to AdVault!" },
        adServices: [],
        popunder: { code: '', active: false },
        socialBar: { code: '', active: false } // [{id, type, name, code, active, reward}]
    };

    // App state
    let userCountry = "BD";
    let penaltyActive = false;
    let penaltyEndTime = 0;
    let penaltyInterval = null;
    let adStartTime = 0;
    let adTimerInterval = null;
    let maintenanceMode = false;
    let maintenanceStartTime = null;
    let adInterval = null; // For extra ad popup
    
    // New Withdraw State
    let currentWithdrawMethod = null;

    // ===================== FIREBASE FUNCTIONS =====================
    
    async function saveUserData() {
        // --- GUARD: BLOCK SAVING IF NOT TELEGRAM ---
        if (!userData.telegramDetected) {
            console.log("Guest/Web Mode: Firestore saving disabled.");
            return false;
        }

        try {
            userData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
            const userId = userData.id || userData.username;
            await db.collection(USERS_COLLECTION).doc(userId).set(userData, { merge: true });
            console.log("User data saved to Firestore");
            return true;
        } catch (error) {
            console.error("Error saving user data:", error);
            // Only show notification if it was a real attempt (Telegram user)
            if (userData.telegramDetected) {
                showTopNotification("Failed to save data. Please try again.");
            }
            return false;
        }
    }
    
    async function loadUserData(userId) {
        try {
            const doc = await db.collection(USERS_COLLECTION).doc(userId).get();
            
            if (doc.exists) {
                // 1. Load existing data
                const data = doc.data();
                userData = { ...userData, ...data };

                // Apply Admin Limits
                userData.totalTasks = adminSettings.dailyTasks || 1000;
                
                // Ensure objects exist
                if (!userData.paymentInfo) userData.paymentInfo = {};
                if (!userData.referrals) userData.referrals = 0;
                if (!userData.totalWithdrawn) userData.totalWithdrawn = 0;
                
                // --- FIX START: COLLECT MISSING DATES ---
                
                let updates = {};
                
                updates.lastUpdated = new Date().toISOString(); 
    
    // Backfill join date if missing
    if (!userData.joinDate) {
        userData.joinDate = new Date().toISOString();
        updates.joinDate = userData.joinDate;
    }

    db.collection(USERS_COLLECTION).doc(userId).set(updates, { merge: true });
                
                // --- FIX END ---

                console.log("User data loaded and status updated");
                return true;
            } else {
                // 2. New User Setup
                userData.id = userId;
                userData.totalTasks = adminSettings.dailyTasks || 1000;
                userData.paymentInfo = {};
                
                // Set Creation Date for new user
                userData.joinDate = new Date().toISOString();
                
                console.log("Creating new user in Firestore");
                await saveUserData(); // This function already saves serverTimestamp
                return false;
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            showTopNotification("Failed to load data. Please try again.");
            return false;
        } finally {
            document.getElementById("firebaseLoading").style.display = "none";
        }
    }
    
    async function loadAdminSettings() {
        try {
            const doc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
            if (doc.exists) {
                const data = doc.data();
                adminSettings = { ...adminSettings, ...data };
                
                // Update maintenance mode
                maintenanceMode = adminSettings.maintenanceMode || false;
                if (maintenanceMode) {
                    maintenanceStartTime = adminSettings.lastUpdated || new Date().toISOString();
                    showMaintenancePopup();
                }
                
                console.log("Admin settings loaded:", adminSettings);
                
                // Apply admin settings to UI
                applyAdminSettings();
                
                return true;
            } else {
                console.log("No admin settings found, using defaults.");
                return false;
            }
        } catch (error) {
            console.error("Error loading admin settings:", error);
            return false;
        }
    }
    
    function setupAdminSettingsListener() {
        db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID)
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    adminSettings = { ...adminSettings, ...data };
                    
                    console.log("Admin settings updated in real-time:", adminSettings);
                    
                    // Update maintenance mode
                    const wasInMaintenance = maintenanceMode;
                    maintenanceMode = adminSettings.maintenanceMode || false;
                    
                    if (maintenanceMode && !wasInMaintenance) {
                        maintenanceStartTime = adminSettings.lastUpdated || new Date().toISOString();
                        showMaintenancePopup();
                    } else if (!maintenanceMode && wasInMaintenance) {
                        hideMaintenancePopup();
                    }
                    
                    // Apply updated settings
                    applyAdminSettings();
                    
                    if (userData.telegramDetected) {
                        showTopNotification("App settings have been updated", 3000);
                    }
                }
            }, (error) => {
                console.error("Error listening to admin settings:", error);
            });
    }

    // Function to inject Popunder & Social Bar scripts safely
    function injectPassiveAds() {
        // 1. Handle Popunder
        if (adminSettings.popunder && adminSettings.popunder.active && adminSettings.popunder.code) {
            if (!document.getElementById('ad-script-popunder')) {
                console.log("Injecting Popunder...");
                const div = document.createElement('div');
                div.id = 'ad-script-popunder';
                div.style.display = 'none';
                document.body.appendChild(div);

                const range = document.createRange();
                range.selectNode(document.body);
                const fragment = range.createContextualFragment(adminSettings.popunder.code);
                div.appendChild(fragment);
            }
        }

        // 2. Handle Social Bar
        if (adminSettings.socialBar && adminSettings.socialBar.active && adminSettings.socialBar.code) {
            if (!document.getElementById('ad-script-socialbar')) {
                console.log("Injecting Social Bar...");
                const div = document.createElement('div');
                div.id = 'ad-script-socialbar';
                div.style.display = 'none';
                document.body.appendChild(div);

                const range = document.createRange();
                range.selectNode(document.body);
                const fragment = range.createContextualFragment(adminSettings.socialBar.code);
                div.appendChild(fragment);
            }
        }
    }
    
    function applyAdminSettings() {
        userData.totalTasks = adminSettings.dailyTasks || 1000;
        
        if (document.getElementById('earn-total')) {
            document.getElementById('earn-total').textContent = adminSettings.dailyTasks || 1000;
        }
        
        if (document.getElementById('earningsPerAdDisplay')) {
            document.getElementById('earningsPerAdDisplay').textContent = (adminSettings.earningsPerAd || 0.05).toFixed(2);
        }
        
        if (document.getElementById('adDurationDisplay')) {
            document.getElementById('adDurationDisplay').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('penaltyAdDuration')) {
            document.getElementById('penaltyAdDuration').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('penaltyDurationDisplay')) {
            document.getElementById('penaltyDurationDisplay').textContent = adminSettings.penaltyDuration || 2;
        }
        
        if (document.getElementById('new-amountInput')) {
            document.getElementById('new-amountInput').min = adminSettings.minWithdrawal || 100;
            document.getElementById('new-amountInput').placeholder = `Min ${adminSettings.minWithdrawal || 100} BDT`;
        }
        
        // Update instructions popup
        if (document.getElementById('instructionAdDuration')) {
            document.getElementById('instructionAdDuration').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('instructionEarningsPerAd')) {
            document.getElementById('instructionEarningsPerAd').textContent = (adminSettings.earningsPerAd || 0.05).toFixed(2);
        }
        
        if (document.getElementById('instructionPenaltyDuration')) {
            document.getElementById('instructionPenaltyDuration').textContent = adminSettings.penaltyDuration || 2;
        }
        
        if (document.getElementById('instructionMinWithdrawal')) {
            document.getElementById('instructionMinWithdrawal').textContent = adminSettings.minWithdrawal || 100;
        }

        // System Info Updates
        if (document.getElementById('appLastUpdated')) {
            if (adminSettings.lastUpdated) {
                const dateObj = new Date(adminSettings.lastUpdated);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                document.getElementById('appLastUpdated').textContent = formattedDate;
            } else {
                document.getElementById('appLastUpdated').textContent = "Not Available";
            }
        }
        if (document.getElementById('displayVersion')) {
            document.getElementById('displayVersion').textContent = adminSettings.appVersion || '2.1.1';
        }
        
        if (document.getElementById('displayBuildNumber')) {
            document.getElementById('displayBuildNumber').textContent = adminSettings.buildNumber || 'AV20250902';
        }
   
        // Render dynamic features
        renderMarquee();
        renderDynamicPaymentUI();
        renderProfilePaymentMethods();
        renderNewPaymentGrid();
        
        // Inject Passive Ads (Popunder/Social Bar)
        injectPassiveAds();
        
        renderExtraAds();
        
        updateUI();
    }
    
    function showMaintenancePopup() {
        const popup = document.getElementById('maintenancePopup');
        if (popup) {
            // Updated to remove dependency on maintenanceTime element
            popup.style.display = 'flex';
            
            // Disable interactions
            document.querySelectorAll('button, input, select').forEach(el => {
                // Allow the new refresh button to work (it has class 'refresh-btn')
                if (!el.classList.contains('refresh-btn')) {
                    el.disabled = true;
                }
            });
        }
    }
    
    function hideMaintenancePopup() {
        const popup = document.getElementById('maintenancePopup');
        if (popup) {
            popup.style.display = 'none';
            
            document.querySelectorAll('button, input, select').forEach(el => {
                el.disabled = false;
            });
            
            showTopNotification("App is back online!", 3000);
        }
    }
    
    async function saveWithdrawalRequest(amount, method, address) {
        // --- GUARD: BLOCK WITHDRAWAL IF NOT TELEGRAM ---
        if (!userData.telegramDetected) {
            showTopNotification("Withdrawals are only available in Telegram.");
            return false;
        }

        try {
            const withdrawalData = {
                userId: userData.id || userData.username,
                username: userData.username,
                amount: amount,
                method: method,
                address: address,
                timestamp: new Date().toISOString(),
                status: "pending"
            };

            await db.collection(WITHDRAWALS_COLLECTION).add(withdrawalData);
            console.log("Withdrawal request saved successfully");
            return true;
        } catch (error) {
            console.error("Error saving withdrawal request:", error);
            return false;
        }
    }

 

    // Global history array (used for mini-lists elsewhere)
    let globalWithdrawalHistory = [];

    async function fetchWithdrawalHistory() {
        const userId = userData.id || userData.username;
        const container = document.getElementById("withdrawalHistoryList");
        
        if (!container) return;

        try {
            // Loading State
            container.innerHTML = `
                <div class="text-center py-20 opacity-50">
                    <div class="spinner border-gray-400 mx-auto mb-4"></div>
                    <p class="text-sm text-gray-500">Loading history...</p>
                </div>`;

            const querySnapshot = await db.collection(WITHDRAWALS_COLLECTION)
                .where("userId", "==", userId)
                .orderBy("timestamp", "desc")
                .get();

            globalWithdrawalHistory = []; // Reset global data
            container.innerHTML = "";     // Clear loading

            if (querySnapshot.empty) {
                container.innerHTML = `
                    <div class="text-center py-20 opacity-50">
                        <i class="fas fa-receipt text-4xl mb-4 text-gray-300"></i>
                        <p class="text-gray-500">No transactions found</p>
                    </div>`;
                
                // Update mini-list on Withdraw page if needed
                if(typeof renderMiniHistory === 'function') renderMiniHistory();
                return;
            }

            let currentDateLabel = "";

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                
                // 1. Save to Global (for mini lists)
                globalWithdrawalHistory.push({
                    amount: data.amount,
                    method: data.method,
                    status: data.status,
                    date: data.timestamp
                });

                // 2. Date Grouping Logic
                const dateObj = new Date(data.timestamp);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                let dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                if (dateObj.toDateString() === today.toDateString()) {
                    dateStr = "Today";
                } else if (dateObj.toDateString() === yesterday.toDateString()) {
                    dateStr = "Yesterday";
                }

                // Insert Date Header if it changes
                if (dateStr !== currentDateLabel) {
                    currentDateLabel = dateStr;
                    container.innerHTML += `<div class="date-label">${dateStr}</div>`;
                }

                // 3. Determine Styles
                let iconClass = "icon-default";
                let iconName = "fa-university";
                const method = (data.method || "").toLowerCase();

                if (method.includes("bkash")) { iconClass = "icon-bkash"; iconName = "fa-mobile-alt"; }
                else if (method.includes("nagad")) { iconClass = "icon-nagad"; iconName = "fa-wallet"; }
                else if (method.includes("rocket")) { iconClass = "icon-rocket"; iconName = "fa-rocket"; }
                else if (method.includes("paypal")) { iconClass = "icon-paypal"; iconName = "fa-paypal"; }

                let statusClass = "status-pending";
                let statusText = "Pending";
                if (data.status === "approved" || data.status === "completed") {
                    statusClass = "status-success";
                    statusText = "Sent";
                } else if (data.status === "rejected") {
                    statusClass = "status-failed";
                    statusText = "Failed";
                }

                const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                // 4. Create Card HTML
                container.innerHTML += `
                    <div class="txn-card">
                      <div class="txn-left">
                        <div class="txn-icon ${iconClass}">
                          <i class="${method.includes('paypal') ? 'fab' : 'fas'} ${iconName}"></i>
                        </div>
                        <div class="txn-details">
                          <span class="txn-title capitalize">${data.method}</span>
                          <span class="txn-meta">${timeStr}</span>
                        </div>
                      </div>
                      <div class="txn-right">
                        <div class="txn-amount amount-neg">-${data.amount.toFixed(2)}</div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                      </div>
                    </div>`;
            });

            // Update mini-list on Withdraw page
            if(typeof renderMiniHistory === 'function') renderMiniHistory();

        } catch (error) {
            console.error("Error fetching history:", error);
            container.innerHTML = `<p class="text-center text-red-500 py-10">Error loading data.</p>`;
        }
    }
    // ===================== ADDED FEATURES =====================
    
    function renderMarquee() {
        // 1. Get the text from Admin Settings (based on User Country or Default)
        const text = adminSettings.marqueeSettings?.[userCountry] || 
                     adminSettings.marqueeSettings?.['default'] || 
                     "Welcome to AdVault! Start earning today.";

        // 2. Target the NEW Home Ticker (The Pill)
        const homeTicker = document.getElementById('marqueeTextHome');
        if (homeTicker) {
            homeTicker.textContent = text;
        }

        // 3. Target the OLD Marquee (Just in case it exists elsewhere)
        const oldMarquee = document.getElementById('marqueeText');
        if (oldMarquee) {
            oldMarquee.textContent = text;
            // Update animation speed based on text length
            oldMarquee.style.animationDuration = `${Math.max(10, text.length / 5)}s`;
        }
    }

    function renderDynamicPaymentUI() {
        // 1. Profile Display
        const displayContainer = document.getElementById('dynamicPaymentDetailsDisplay');
        if (displayContainer) {
            displayContainer.innerHTML = '';
            
            if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
                adminSettings.paymentMethods.forEach(method => {
                    const val = userData.paymentInfo[method.id] || 'Not Set';
                    const div = document.createElement('p');
                    div.innerHTML = `<span class="font-bold">${method.name}:</span> <span class="${val === 'Not Set' ? 'text-red-500' : 'text-gray-900'}">${val}</span>`;
                    displayContainer.appendChild(div);
                });
            } else {
                displayContainer.innerHTML = `
                    <p><span class="font-bold">PayPal:</span> <span class="${!userData.paypal ? 'text-red-500' : 'text-gray-900'}">${userData.paypal || 'Not set'}</span></p>
                    <p><span class="font-bold">Payoneer:</span> <span class="${!userData.payoneer ? 'text-red-500' : 'text-gray-900'}">${userData.payoneer || 'Not set'}</span></p>
                    <p><span class="font-bold">bKash:</span> <span class="${!userData.bkash ? 'text-red-500' : 'text-gray-900'}">${userData.bkash || 'Not set'}</span></p>
                `;
            }
        }

        // 2. Dynamic Edit Modal Form
        const formContainer = document.getElementById('dynamicPaymentForm');
        if (formContainer) {
            formContainer.innerHTML = '';
            
            if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
                adminSettings.paymentMethods.forEach(method => {
                    const wrapper = document.createElement('div');
                    const type = method.type === 'number' ? 'number' : (method.type === 'email' ? 'email' : 'text');
                    wrapper.innerHTML = `
                        <label class="payment-label">${method.name}</label>
                        <input type="${type}" data-id="${method.id}" value="${userData.paymentInfo[method.id] || ''}" class="payment-input" placeholder="Enter ${method.name}">
                    `;
                    formContainer.appendChild(wrapper);
                });
            } else {
                formContainer.innerHTML = `
                    <div>
                        <label class="payment-label">PayPal Email</label>
                        <input type="email" data-id="paypal" value="${userData.paypal || ''}" class="payment-input" placeholder="Enter PayPal email">
                    </div>
                    <div>
                        <label class="payment-label">Payoneer Email</label>
                        <input type="email" data-id="payoneer" value="${userData.payoneer || ''}" class="payment-input" placeholder="Enter Payoneer email">
                    </div>
                    <div>
                        <label class="payment-label">bKash Number</label>
                        <input type="text" data-id="bkash" value="${userData.bkash || ''}" class="payment-input" placeholder="Enter bKash number">
                    </div>
                `;
            }
        }

        // 3. Update profile payment methods
        renderProfilePaymentMethods();
        // 4. Update withdrawal payment methods
        renderNewPaymentGrid();
    }
    
    // Render profile payment methods
   // Render profile payment methods (Updated for New Profile Menu)
    function renderProfilePaymentMethods() {
        // Target the status text in the new menu item
        const statusText = document.getElementById('paymentMethodStatus');
        if (!statusText) return;

        // Count linked methods
        let linkedCount = 0;
        if (userData.paymentInfo) {
            linkedCount = Object.keys(userData.paymentInfo).length;
            
            // Fallback: check for old data fields if paymentInfo is empty
            if (linkedCount === 0) {
                if (userData.bkash) linkedCount++;
                if (userData.paypal) linkedCount++;
                if (userData.payoneer) linkedCount++;
            }
        }

        // Update the text in the menu button
        if (linkedCount > 0) {
            statusText.textContent = `${linkedCount} Account${linkedCount > 1 ? 's' : ''} Connected`;
            statusText.classList.add('text-green-500');
            statusText.classList.remove('text-slate-400');
        } else {
            statusText.textContent = "No accounts linked";
            statusText.classList.remove('text-green-500');
            statusText.classList.add('text-slate-400');
        }
    }
    
    // Render NEW withdrawal payment methods grid
    function renderNewPaymentGrid() {
        const container = document.getElementById('new-paymentGrid');
        if (!container) return;
        
        container.innerHTML = '';
        
        let methods = [];
        
        if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
            methods = adminSettings.paymentMethods;
        } else {
            methods = [
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', color: '#E2136E' },
                { id: 'nagad', name: 'Nagad', icon: 'fas fa-wallet', color: '#F8A01C' },
                { id: 'rocket', name: 'Rocket', icon: 'fas fa-rocket', color: '#8C34FF' },
                { id: 'paypal', name: 'PayPal', icon: 'fab fa-paypal', color: '#003087' }
            ];
        }
        
        methods.forEach(method => {
            const card = document.createElement('div');
            card.className = 'new-payment-method-card';
            card.dataset.id = method.id;
            
            const isSet = userData.paymentInfo[method.id] ? true : false;
            
            card.innerHTML = `
                <div class="new-payment-icon" style="color: ${method.color || '#2563eb'}">
                    <i class="${method.icon || 'fas fa-credit-card'}"></i>
                </div>
                <div class="font-semibold text-sm text-gray-800">${method.name}</div>
                <div class="text-xs ${isSet ? 'text-green-600' : 'text-red-400'} mt-1">
                    ${isSet ? '<i class="fas fa-check-circle"></i> Linked' : 'Not Linked'}
                </div>
            `;

            card.onclick = () => selectNewPaymentMethod(method, card);
            container.appendChild(card);
        });
    }
    
    function selectNewPaymentMethod(method, cardElement) {
        // UI Selection
        document.querySelectorAll('.new-payment-method-card').forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');
        
        currentWithdrawMethod = method.id;
        document.getElementById('new-methodError').classList.add('hidden');

        // Check details
        const detailsDiv = document.getElementById('new-selectedMethodDetails');
        const previewSpan = document.getElementById('new-sendToPreview');
        const savedInfo = userData.paymentInfo[method.id];

        if (savedInfo) {
            detailsDiv.classList.remove('hidden');
            previewSpan.innerText = savedInfo;
        } else {
            detailsDiv.classList.add('hidden');
            showTopNotification(`Please link your ${method.name} account first.`);
            openNewPaymentEditModal();
        }
        
        updateNewFeeCalculation();
    }
    
    function updateNewFeeCalculation() {
        const amount = parseFloat(document.getElementById('new-amountInput').value) || 0;
        const fee = amount * 0.02; // 2% fee
        const net = amount - fee;

        document.getElementById('new-feeDisplay').innerText = `BDT ${fee.toFixed(2)}`;
        document.getElementById('new-netAmountDisplay').innerText = `BDT ${Math.max(0, net).toFixed(2)}`;
    }
    
    function openNewPaymentEditModal() {
        const formContainer = document.getElementById('new-dynamicPaymentForm');
        formContainer.innerHTML = '';
        
        const methods = adminSettings.paymentMethods.length > 0 
            ? adminSettings.paymentMethods 
            : [
                { id: 'bkash', name: 'bKash', type: 'number' },
                { id: 'nagad', name: 'Nagad', type: 'number' },
                { id: 'rocket', name: 'Rocket', type: 'number' },
                { id: 'paypal', name: 'PayPal', type: 'email' }
              ];

        methods.forEach(method => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1">${method.name} ${method.type === 'email' ? 'Email' : 'Number'}</label>
                <input type="${method.type || 'text'}" 
                       class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white transition-colors"
                       placeholder="Enter ${method.name} details"
                       data-id="${method.id}"
                       value="${userData.paymentInfo[method.id] || ''}">
            `;
            formContainer.appendChild(div);
        });

        document.getElementById('new-dynamicPaymentEditModal').classList.add('active');
    }
    
    async function fetchNewHistory() {
        const tbody = document.getElementById('new-historyTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading...</td></tr>';
        
        try {
            const snapshot = await db.collection(WITHDRAWALS_COLLECTION)
                .where('userId', '==', userData.id || userData.username)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
                
            tbody.innerHTML = '';
            
            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No transactions yet</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = new Date(data.timestamp).toLocaleDateString();
                // Check for both 'approved' AND 'completed'
let statusColor = (data.status === 'approved' || data.status === 'completed') ? 'text-green-600' : (data.status === 'rejected' ? 'text-red-500' : 'text-yellow-600');
                
                const row = `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 text-gray-600">${date}</td>
                        <td class="py-3 capitalize">${data.method}</td>
                        <td class="py-3 font-medium">BDT ${data.amount}</td>
                        <td class="py-3 ${statusColor} text-xs font-bold uppercase">${data.status}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Error loading history</td></tr>'; }
    }
    
    // --- Dynamic Extra Ads Rendering ---
    // --- Dynamic Extra Ads Rendering (Updated Style) ---
    function renderExtraAds() {
        const container = document.getElementById('extraTasksContainer');
        const noAdsMsg = document.getElementById('noAdsMsg');
        
        if (!container) return;
        
        container.innerHTML = '';
        
        const validAds = adminSettings.adServices?.filter(s => s.active) || [];
        
        if (validAds.length === 0) {
            if (noAdsMsg) noAdsMsg.classList.remove('hidden');
            return;
        } else {
            if (noAdsMsg) noAdsMsg.classList.add('hidden');
        }

        validAds.forEach(service => {
            const card = document.createElement('div');
            // Using the new 'extra-earn-card' class from the new CSS
            card.className = "extra-earn-card";
            card.innerHTML = `
                <i class="fas fa-gift extra-gift-icon"></i>
                <div class="relative z-10">
                    <h2 class="text-xl font-bold mb-0.5">${service.name || 'Bonus Task'}</h2>
                    <p class="text-xs opacity-90 mb-2">Reward: +${service.reward || 0.10} BDT</p>
                    <button class="extra-btn" onclick="startSpecificAd('${service.id}')">
                        <i class="fas fa-box-open mr-1"></i> Open & Earn
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
   // --- Dynamic Ad Popup with Timer & Smartlink Verification ---
    // --- Dynamic Ad Popup with New UI ---
    window.startSpecificAd = function(serviceId) {
        const service = adminSettings.adServices?.find(s => s.id === serviceId);
        if(!service) {
            showTopNotification("Ad service not available.");
            return;
        }
        
        if (maintenanceMode) {
            showTopNotification('App is under maintenance.');
            return;
        }
        
        if (penaltyActive) {
            showTopNotification('Please wait until penalty expires.');
            return;
        }
        
        // 1. Get Elements
        const overlay = document.getElementById('adOverlay');
        const container = document.getElementById('adContainer');
        const timerText = document.getElementById('adHeaderTimer');
        const spinner = document.getElementById('timerSpinner');
        const btn = document.getElementById('closeAdBtn');
        const bar = document.getElementById('adProgressBar');
        const footerMsg = document.getElementById('adFooterMessage');
        
        // 2. Reset UI State
        container.innerHTML = '';
        btn.className = 'close-btn-modern'; // Reset classes
        btn.innerHTML = '<i class="fas fa-lock text-sm"></i>';
        bar.style.width = '0%';
        bar.style.background = 'linear-gradient(90deg, #3b82f6, #60a5fa)';
        spinner.style.display = 'block';
        timerText.classList.remove('complete');
        timerText.textContent = 'Wait...';
        overlay.style.display = 'flex'; // Show overlay
        
        let lockTime = service.duration || 15;
        
        // 3. Setup Content based on Type
        if (service.type === 'smartlink') {
            // --- SMARTLINK LOGIC ---
            window.open(service.code, '_blank');
            
            // Inject the Radar Animation HTML
            container.innerHTML = `
                <div class="verification-overlay">
                    <div class="radar-pulse">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Verifying Task...</h2>
                    <p class="text-slate-500 text-sm max-w-xs mx-auto mb-6 leading-relaxed">
                        Link opened in new tab. Keep browsing for <strong class="text-blue-600">${lockTime}s</strong> to confirm reward.
                    </p>
                    <div class="flex flex-col gap-3 w-full max-w-xs">
                        <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-lg shadow-sm">
                            <div class="w-5 h-5 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs"><i class="fas fa-check"></i></div>
                            <span class="text-xs font-medium text-slate-600">Link Opened</span>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-100 rounded-lg shadow-sm">
                            <div class="w-5 h-5 rounded-full border-2 border-blue-500 border-t-transparent animate-spin"></div>
                            <span class="text-xs font-bold text-blue-700">Checking Activity...</span>
                        </div>
                    </div>
                </div>
            `;
            footerMsg.innerHTML = '<i class="fas fa-sync fa-spin text-blue-400"></i> <span>Verifying external activity...</span>';
            
        } else {
            // --- IFRAME/BANNER LOGIC ---
            footerMsg.innerHTML = '<i class="fas fa-eye text-blue-400"></i> <span>Stay on this screen</span>';
            const iframe = document.createElement('iframe');
            iframe.className = 'ad-iframe';
            container.appendChild(iframe);
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
                <style>body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;background:#fff;}</style>
                ${service.code || '<h2 style="font-family:sans-serif;">Ad Content Loaded</h2>'}
            `);
            doc.close();
        }

        // 4. Timer Logic
        let elapsed = 0;
        let totalTime = lockTime + 5; 

        if (adInterval) clearInterval(adInterval); 

        adInterval = setInterval(() => {
            elapsed++;
            
            // Update Bar
            const pct = Math.min((elapsed / lockTime) * 100, 100);
            bar.style.width = `${pct}%`;

            if (lockTime - elapsed > 0) {
                // Counting down
                timerText.textContent = `Wait 00:${String(lockTime - elapsed).padStart(2, '0')}`;
            } else {
                // Success State
                timerText.textContent = 'Reward Ready';
                timerText.classList.add('complete');
                spinner.style.display = 'none';
                
                bar.style.background = '#10b981'; // Green bar
                footerMsg.innerHTML = '<i class="fas fa-gift text-green-400"></i> <span class="text-green-400">Task Verified! Tap lock to claim.</span>';
                
                if(!btn.classList.contains('active')) {
                    btn.classList.add('active'); // Unlock button
                    btn.innerHTML = '<i class="fas fa-check text-lg"></i>'; // Change icon
                }
            }

            if (elapsed >= totalTime + 60) clearInterval(adInterval);
        }, 1000);

        // 5. Close Handler
        btn.onclick = async () => {
            if(!btn.classList.contains('active')) return;
            
            clearInterval(adInterval);
            overlay.style.display = 'none';
            
            // Reward
            const bonus = service.reward || 0.10;
            userData.balance += bonus;
            
            // New History Logic (ensure this function is available)
            if(typeof HistoryManager !== 'undefined') {
                HistoryManager.addRecord('task', bonus, service.name || 'Bonus Task');
            }
            
            await saveUserData();
            updateUI();
            showSuccessPopup(` +${bonus.toFixed(2)} BDT Earned!`);
        };
    }; 
    
    async function saveDynamicPaymentInfo() {
        const inputs = document.querySelectorAll('#dynamicPaymentForm input');
        const newInfo = {};
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            if (input.value.trim()) newInfo[id] = input.value.trim();
        });

        userData.paymentInfo = newInfo;
        
        // Update original payment fields for backward compatibility
        if (newInfo.paypal) userData.paypal = newInfo.paypal;
        if (newInfo.payoneer) userData.payoneer = newInfo.payoneer;
        if (newInfo.bkash) userData.bkash = newInfo.bkash;
        
        const btn = document.getElementById('saveDynamicPaymentBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        try {
            await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({ 
                paymentInfo: newInfo,
                paypal: userData.paypal,
                payoneer: userData.payoneer,
                bkash: userData.bkash
            });
            
            renderDynamicPaymentUI();
            updateUI();
            showTopNotification("Payment information updated!");
            
            // Close modal
            document.getElementById('dynamicPaymentEditModal').classList.remove('show');
            setTimeout(() => {
                document.getElementById('dynamicPaymentEditModal').style.display = 'none';
            }, 300);
        } catch (error) {
            console.error("Error saving payment info:", error);
            showTopNotification("Failed to save payment information");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
    
    async function saveNewDynamicPaymentInfo() {
        const inputs = document.querySelectorAll('#new-dynamicPaymentForm input');
        const newInfo = {};
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            if (input.value.trim()) newInfo[id] = input.value.trim();
        });

        userData.paymentInfo = { ...userData.paymentInfo, ...newInfo };
        
        const btn = document.getElementById('new-saveDynamicPaymentBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        try {
            await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({ 
                paymentInfo: userData.paymentInfo
            });
            
            renderProfilePaymentMethods();
            renderNewPaymentGrid();
            updateUI();
            showTopNotification("Payment information updated!");
            
            // Close modal
            document.getElementById('new-dynamicPaymentEditModal').classList.remove('active');
        } catch (error) {
            console.error("Error saving payment info:", error);
            showTopNotification("Failed to save payment information");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    // ===================== HELPER FUNCTIONS =====================
    
    function toggleAboutModal() {
      const modal = document.getElementById('aboutModal');
      if (modal.classList.contains('show')) {
        modal.classList.remove('show');
        // Optional: wait for transition then hide if you want to save resources, 
        // but pointer-events:none in CSS handles clicks fine.
      } else {
        modal.classList.add('show');
      }
    }
// ================= LEGAL MODAL FUNCTIONS =================

    function openLegal(type) {
      const modal = document.getElementById('legalModal');
      const title = document.getElementById('legalTitle');
      const content = document.getElementById('legalContent');
      
      // Inject correct content based on type
      if (type === 'terms') {
        title.innerHTML = '<i class="fas fa-file-contract text-blue-500"></i> Terms of Service';
        content.innerHTML = document.getElementById('termsText').innerHTML;
      } else {
        title.innerHTML = '<i class="fas fa-user-shield text-green-500"></i> Privacy Policy';
        content.innerHTML = document.getElementById('privacyText').innerHTML;
      }

      // Show modal
      modal.style.display = 'flex';
      // Small timeout for CSS transition to work
      setTimeout(() => {
          modal.classList.add('show');
      }, 10);
    }

    function closeLegal() {
      const modal = document.getElementById('legalModal');
      modal.classList.remove('show');
      
      // Wait for animation to finish before hiding
      setTimeout(() => {
          modal.style.display = 'none';
      }, 300);
    }
    
    // Close modal if clicking outside card
    document.addEventListener('DOMContentLoaded', () => {
        const legalModal = document.getElementById('legalModal');
        if(legalModal) {
            legalModal.addEventListener('click', (e) => {
                if (e.target === legalModal) {
                    closeLegal();
                }
            });
        }
    });
    function initTelegram() {
        return new Promise((resolve) => {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                resolve(true);
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-web-app.js';
            
            script.onload = () => {
                if (window.Telegram?.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    resolve(true);
                } else {
                    resolve(false);
                }
            };
            
            script.onerror = () => {
                resolve(false);
            };
            
            document.head.appendChild(script);
        });
    }

    function getTelegramUserData() {
        try {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                return {
                    id: user.id ? user.id.toString() : "",
                    name: [user.first_name, user.last_name].filter(Boolean).join(" "),
                    username: user.username ? `@${user.username}` : user.first_name,
                    photoUrl: user.photo_url || null
                };
            }
            
            if (window.Telegram?.WebApp?.initData) {
                const params = new URLSearchParams(Telegram.WebApp.initData);
                const userJson = params.get('user');
                if (userJson) {
                    const user = JSON.parse(userJson);
                    return {
                        id: user.id ? user.id.toString() : "",
                        name: [user.first_name, user.last_name].filter(Boolean).join(" "),
                        username: user.username ? `@${user.username}` : user.first_name,
                        photoUrl: user.photo_url || null
                    };
                }
            }
        } catch (e) {
            console.error("Error getting Telegram user data:", e);
        }
        return null;
    }

    function generateUsername() {
        return `User${Math.floor(1000 + Math.random() * 9000)}`;
    }

    function showEditNotification() {
        const banner = document.getElementById("androidTopNotification");
        if (!banner) return;
        
        banner.textContent = "To edit payment information, please go to the Profile section and use the Edit button";
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), 3000);
    }

    function isValidEmail(email) {
        if (!email) return false;
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function isValidBkash(number) {
        if (!number) return false;
        return /^(?:\+?88)?01[3-9]\d{8}$/.test(number);
    }

    /**
 * AdVault Android-Style Notification Engine
 * @param {string} title - The Bold Title
 * @param {string} message - The Body text
 * @param {string} type - 'earn', 'error', or 'info'
 */
/**
 * AdVault Intelligent Notification Engine
 * Automatically maps security, earnings, and system alerts.
 */
/**
 * AdVault Intelligent Notification Engine with Local History
 */
function showTopNotification(message, duration = 4000) {
    const container = document.getElementById('notification-container');
    if (!container) return;

    const el = document.createElement('div');
    el.className = 'droid-notify';

    let config = {
        title: "AdVault",
        icon: '<i class="fas fa-bell"></i>',
        bgColor: "icon-bg-info",
        type: "info", // for history filtering
        msg: message
    };

    const lowerMsg = message.toLowerCase();

    if (lowerMsg.includes('invalid') || lowerMsg.includes('fail') || lowerMsg.includes('error') || lowerMsg.includes('penalty') || lowerMsg.includes('link your')) {
        config.title = "Security Alert";
        config.icon = '<i class="fas fa-exclamation-circle"></i>';
        config.bgColor = "icon-bg-error";
        config.type = "security";
    } else if (lowerMsg.includes('earn') || lowerMsg.includes('+')) {
        config.title = "Payment Received";
        config.icon = '<i class="fas fa-coins"></i>';
        config.bgColor = "icon-bg-earn";
        config.type = "earning";
        config.msg = message.replace(/(\+?\d+\.\d+\s?BDT)/g, '<span class="money-green">$1</span>');
    } else if (lowerMsg.includes('success') || lowerMsg.includes('submitted')) {
        config.title = "Action Successful";
        config.icon = '<i class="fas fa-check-circle"></i>';
        config.bgColor = "icon-bg-earn";
        config.type = "success";
    }

    // --- SAVE TO LOCAL STORAGE ---
    saveNotificationToHistory(config.title, message, config.type);

    el.innerHTML = `
        <div class="notify-header">
            <div class="header-left">
                <div class="app-icon-small">
                    <img src="https://worldnews24x7.infy.uk/image/advault3.png" class="w-full h-full object-cover">
                </div>
                <span class="app-name">AdVault</span>
                <span class="text-[10px] text-slate-300"></span>
                <span class="notify-time">now</span>
            </div>
        </div>
        <div class="notify-content">
            <div class="text-area">
                <h3 class="notify-title">${config.title}</h3>
                <p class="notify-body">${config.msg}</p>
            </div>
            <div class="large-icon-box ${config.bgColor}">
                ${config.icon}
            </div>
        </div>
    `;

    container.appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    attachDroidSwipe(el);

    const timer = setTimeout(() => {
        if(document.body.contains(el)) dismissDroid(el, 'swipe-up');
    }, duration);
    el.dataset.timerId = timer;
}

/**
 * Local Storage History Manager
 */
function saveNotificationToHistory(title, message, type) {
    const MAX_HISTORY = 30; // Keep only last 30
    let history = JSON.parse(localStorage.getItem('advault_notif_history') || '[]');
    
    const newEntry = {
        id: Date.now(),
        title: title,
        message: message,
        type: type,
        time: new Date().toISOString()
    };

    history.unshift(newEntry); // Add to start
    if (history.length > MAX_HISTORY) history.pop(); // Remove oldest
    
    localStorage.setItem('advault_notif_history', JSON.stringify(history));
}
// Gesture Handling Function
function attachDroidSwipe(element) {
    let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;
    const threshold = 80;

    const onStart = (e) => {
        clearTimeout(element.dataset.timerId);
        isDragging = true;
        startX = (e.type === 'touchstart') ? e.touches[0].clientX : e.clientX;
        startY = (e.type === 'touchstart') ? e.touches[0].clientY : e.clientY;
        element.style.transition = 'none';
    };

    const onMove = (e) => {
        if (!isDragging) return;
        const x = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
        const y = (e.type === 'touchmove') ? e.touches[0].clientY : e.clientY;
        currentX = x - startX;
        currentY = y - startY;
        element.style.transform = `translate(${currentX}px, ${currentY}px)`;
        const dist = Math.sqrt(currentX*currentX + currentY*currentY);
        element.style.opacity = Math.max(0.5, 1 - (dist / 300));
    };

    const onEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        element.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease';
        if (currentX > threshold) dismissDroid(element, 'swipe-right');
        else if (currentX < -threshold) dismissDroid(element, 'swipe-left');
        else if (currentY < -40) dismissDroid(element, 'swipe-up');
        else {
            element.style.transform = 'translate(0, 0)';
            element.style.opacity = '1';
        }
    };

    element.addEventListener('touchstart', onStart);
    element.addEventListener('touchmove', onMove);
    element.addEventListener('touchend', onEnd);
    element.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', (e) => isDragging && onMove(e));
    window.addEventListener('mouseup', () => isDragging && onEnd());
}

function dismissDroid(element, animClass) {
    element.classList.add(animClass);
    setTimeout(() => { if(element.parentNode) element.parentNode.removeChild(element); }, 300);
}

    /* ================= SUCCESS POPUP LOGIC ================= */

    function showSuccessPopup(message = "Success!", title = "Awesome!") {
        const popup = document.getElementById('successPopup');
        const titleEl = document.getElementById('popupTitle');
        const msgEl = document.getElementById('popupMessage');
        
        if (!popup) return;

        // Update Text
        if(titleEl) titleEl.textContent = title;
        if(msgEl) msgEl.textContent = message;
        
        // --- Animation Reset Trick ---
        // We clone and replace the icon wrapper to force CSS animations to replay
        const wrapper = popup.querySelector('.icon-wrapper');
        if (wrapper) {
            const newWrapper = wrapper.cloneNode(true);
            wrapper.parentNode.replaceChild(newWrapper, wrapper);
        }

        // Show Popup
        popup.classList.add('show');
        
        // Auto-close after 3 seconds (optional, removing it makes user click 'Continue')
        // setTimeout(() => closeSuccessPopup(), 3000); 
    }

    function closeSuccessPopup() {
        const popup = document.getElementById('successPopup');
        if (popup) {
            popup.classList.remove('show');
        }
    }
        
        
    
    function updateUI() {
    const greetingEl = document.getElementById('greeting-text');
        if (greetingEl) {
            const hour = new Date().getHours();
            let greeting = 'Good Morning';
            
            if (hour >= 12 && hour < 17) {
                greeting = 'Good Afternoon';
            } else if (hour >= 17) {
                greeting = 'Good Evening';
            }
            // Optional: Handle late night (12 AM to 4 AM) if you want
            if (hour >= 0 && hour < 5) {
                greeting = 'Good Evening'; // Or 'Late Night' if you prefer
            }
            
            greetingEl.textContent = greeting;
        }
        // 1. Update Header (Safely)
        const headerUsername = document.getElementById('header-username');
        const headerBalance = document.getElementById('header-balance');
        
        if (headerUsername) headerUsername.textContent = userData.username;
        if (headerBalance) headerBalance.textContent = `BDT ${userData.balance.toFixed(2)}`;

        // 2. Update Home Section
        if (document.getElementById('home-earnings-val')) {
            document.getElementById('home-earnings-val').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            document.getElementById('home-ads-val').textContent = userData.adsWatched;
            
            // Update Home Ticker if it exists
            const homeTicker = document.getElementById('marqueeTextHome');
            if (homeTicker) {
                 const text = adminSettings.marqueeSettings?.[userCountry] || 
                              adminSettings.marqueeSettings?.['default'] || 
                              "Welcome to AdVault!";
                 homeTicker.textContent = text;
            }
        }

        // 3. Update Earn Section
        if (document.getElementById('earn-completed')) {
            const remaining = userData.totalTasks - userData.completedTasks;
            document.getElementById('earn-completed').textContent = userData.completedTasks;
            document.getElementById('earn-remaining').textContent = remaining;
            const progressPercent = (userData.completedTasks / userData.totalTasks) * 100;
            
            const progressBar = document.getElementById('earn-progress-bar');
            if(progressBar) progressBar.style.width = `${progressPercent}%`;
        }

        // 4. Update Withdraw Section
        if (document.getElementById('new-withdraw-balance-display')) {
            document.getElementById('new-withdraw-balance-display').textContent = `BDT ${userData.balance.toFixed(2)}`;
            document.getElementById('new-withdraw-total-earn').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            document.getElementById('new-withdraw-total-out').textContent = `BDT ${userData.totalWithdrawn.toFixed(2)}`;
        }

        // 5. Update Profile Section (CRASH FIX IS HERE)
        // We now check if each element exists before setting textContent
        if (document.getElementById('profileName')) {
            document.getElementById('profileName').textContent = userData.name || "Not available";
            document.getElementById('profileUsername').textContent = userData.username;
            
            if (document.getElementById('profileId')) {
                document.getElementById('profileId').textContent = `ID: ${userData.id || "---"}`;
            }
            
            if (document.getElementById('profileBalance')) {
                document.getElementById('profileBalance').textContent = `BDT ${userData.balance.toFixed(2)}`;
            }
            if (document.getElementById('profileEarnings')) {
                document.getElementById('profileEarnings').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            }
            if (document.getElementById('profileAds')) {
                document.getElementById('profileAds').textContent = userData.adsWatched;
            }
            if (document.getElementById('profileReferrals')) {
                document.getElementById('profileReferrals').textContent = userData.referrals || 0;
            }
            if (document.getElementById('profileWithdrawn')) {
                document.getElementById('profileWithdrawn').textContent = `BDT ${userData.totalWithdrawn.toFixed(2)}`;
            }
            
            // Safe Update for Version display in Profile
            if (document.getElementById('displayVersionProfile')) {
                 document.getElementById('displayVersionProfile').textContent = `Version ${adminSettings.appVersion || '2.1.0'}`;
            }
        }
        
        // 6. Update Telegram Indicator
        const telegramIndicator = document.getElementById('telegramIndicator');
        if (telegramIndicator) {
            telegramIndicator.style.display = userData.telegramDetected ? 'flex' : 'none';
        }

        // 7. Update Flag
        if (typeof setCountryFlag === 'function' && userCountry) {
            setCountryFlag(userCountry); 
        }
        
        // 8. Call sub-functions
        if (typeof updateProfileImages === 'function') updateProfileImages();
        if (typeof renderProfilePaymentMethods === 'function') renderProfilePaymentMethods();
    
    
        // Update build number
        if (document.getElementById('buildNumber')) {
            document.getElementById('buildNumber').textContent = "AV20250902";
        }
    }
    
    function updateProfileImages() {
        const profileContainer = document.getElementById('profileImageContainer'); 
        const headerContainer = document.getElementById('headerProfileImage'); // This ID is now on the inner wrapper
        
        if (!profileContainer || !headerContainer) return;
        
        // 2. Clear current content
        profileContainer.innerHTML = '';
        headerContainer.innerHTML = '';
        
        // 3. Logic: Check if user has a photo
        if (userData.profilePhoto) {
            // --- USER HAS PHOTO ---
            
            // A. Main Profile Page Image
            const profileImg = document.createElement('img');
            profileImg.src = userData.profilePhoto;
            profileImg.alt = "Profile photo";
            profileImg.className = "w-full h-full rounded-full object-cover";
            profileContainer.appendChild(profileImg);
            
            // B. Header Image
            const headerImg = document.createElement('img');
            headerImg.src = userData.profilePhoto;
            headerImg.alt = "Profile";
            headerImg.className = "w-full h-full object-cover"; // Fits inside the new avatar-circle
            headerContainer.appendChild(headerImg);

        } else {
            // --- USER HAS NO PHOTO (SHOW PLACEHOLDERS) ---
            
          // A. Main Profile Page Placeholder
            const profilePlaceholder = document.createElement('div');
            profilePlaceholder.className = "w-full h-full rounded-full flex items-center justify-center";
            // CHANGED: text-white -> text-gray-300
            profilePlaceholder.innerHTML = '<i class="fas fa-user text-gray-300 text-3xl"></i>';
            profileContainer.appendChild(profilePlaceholder);
            
            // B. Header Placeholder (Astronaut)
            headerContainer.className = "w-full h-full flex items-center justify-center";
            headerContainer.innerHTML = '<i class="fas fa-user-astronaut text-xl text-blue-500"></i>';
        }
    }
            

    function checkDailyReset() {
        const today = new Date().toISOString().slice(0, 10);
        if (userData.lastResetDate !== today) {
            userData.completedTasks = 0;
            userData.lastResetDate = today;
            saveUserData();
        }
    }

    function showSection(targetId) {
    // 1. Reset all sections and nav items
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    // 2. Activate Target
    const targetSection = document.getElementById(targetId);
    const targetNavItem = document.querySelector(`.nav-item[data-target="${targetId}"]`);
    
    if (targetSection) targetSection.classList.add('active');
    if (targetNavItem) targetNavItem.classList.add('active');
    
    // 3. Header Visibility Logic
    const hideHeaderSections = [
        'profile-section', 
        'withdraw-section', 
        'withdrawal-history-section', 
        'earning-history-section', 
        'payment-methods-section',
        'notif-history-section' // <--- MISSING PART 1: Hides the top header
    ];
    
    if (hideHeaderSections.includes(targetId)) {
        document.body.classList.add('header-hidden');
    } else {
        document.body.classList.remove('header-hidden');
    }
    
    // 4. Data Loading Triggers
    
    // <--- MISSING PART 2: Triggers the list to load
    if (targetId === 'notif-history-section') {
        if(typeof renderNotifHistory === 'function') renderNotifHistory();
    }
    
    // ... Existing triggers ...
    if (targetId === 'withdraw-section') {
        if(typeof renderWithdrawPage === 'function') renderWithdrawPage();
        if(typeof fetchWithdrawalHistory === 'function') fetchWithdrawalHistory();
    }
    
    if (targetId === 'withdrawal-history-section') {
        if(typeof fetchWithdrawalHistory === 'function') fetchWithdrawalHistory();
    }
    
    if (targetId === 'payment-methods-section') {
        if(typeof renderPaymentMethodsPage === 'function') renderPaymentMethodsPage();
    }

    if (targetId === 'earning-history-section') {
        if(typeof renderEarningHistory === 'function') renderEarningHistory();
    }

    if (targetId === 'profile-section') {
        if(typeof updateUI === 'function') updateUI();
    }
}

    async function loadAdSDK() {
        return new Promise((resolve, reject) => {
            if (typeof show_9661177 === 'function') {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://libtl.com/sdk.js';
            
            const timeout = setTimeout(() => {
                reject(new Error('Ad SDK loading timed out'));
                script.remove();
            }, 15000);

            script.onload = () => {
                clearTimeout(timeout);
                if (typeof show_9661177 === 'function') {
                    resolve();
                } else {
                    reject(new Error('Ad SDK function not found'));
                }
            };

            script.onerror = () => {
                clearTimeout(timeout);
                reject(new Error('Failed to load ad SDK'));
            };

            document.head.appendChild(script);
        });
    }
    
    async function detectCountry() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return data.country;
        } catch (error) {
            console.error('Country detection failed:', error);
            return 'BD';
        }
    }
    
    function setCountryFlag(country) {
        const flagElement = document.getElementById('country-flag');
        if (!flagElement) return;
        
        const flagMap = {
    // --- South Asia ---
    'BD': '', 'IN': '', 'PK': '', 'LK': '', 'NP': '', 'MV': '',
    
    // --- North America ---
    'US': '', 'CA': '', 'MX': '',
    
    // --- Europe ---
    'GB': '', 'DE': '', 'FR': '', 'IT': '', 'ES': '', 
    'NL': '', 'BE': '', 'CH': '', 'SE': '', 'NO': '', 
    'DK': '', 'FI': '', 'PT': '', 'PL': '', 'UA': '', 
    'RU': '', 'TR': '', 'RO': '', 'GR': '', 'AT': '', 
    'IE': '', 'CZ': '', 'HU': '',
    
    // --- Middle East ---
    'SA': '', 'AE': '', 'QA': '', 'KW': '', 'OM': '', 
    'BH': '', 'IL': '', 'JO': '', 'LB': '', 'EG': '',

    // --- Southeast & East Asia ---
    'CN': '', 'JP': '', 'KR': '', 'TW': '', 'HK': '',
    'SG': '', 'MY': '', 'ID': '', 'TH': '', 'VN': '', 
    'PH': '', 'KH': '', 'MM': '',
    
    // --- Oceania ---
    'AU': '', 'NZ': '', 'FJ': '',
    
    // --- South America ---
    'BR': '', 'AR': '', 'CO': '', 'CL': '', 'PE': '', 
    'VE': '', 'UY': '',
    
    // --- Africa ---
    'ZA': '', 'NG': '', 'KE': '', 'GH': '', 'MA': '', 
    'DZ': '', 'TN': '', 'UG': '', 'TZ': ''
};
        
        flagElement.textContent = flagMap[country] || '';
    }

    function applyPenalty() {
        const penaltyEnabled = adminSettings.enablePenalty !== false;
        if (!penaltyEnabled) return;
        
        penaltyActive = true;
        penaltyEndTime = Date.now() + (adminSettings.penaltyDuration || 2) * 60000;
        
        localStorage.setItem('penaltyEndTime', penaltyEndTime.toString());
        
        const startEarningAd = document.getElementById('startEarningAd');
        if (startEarningAd) {
            startEarningAd.disabled = true;
            startEarningAd.classList.add('btn-penalty');
        }
        
        const penaltyWarningCard = document.getElementById('penaltyWarningCard');
        if (penaltyWarningCard) {
            penaltyWarningCard.style.display = 'block';
        }
        
        penaltyInterval = setInterval(updatePenaltyTimer, 1000);
        updatePenaltyTimer();
    }
    
    function updatePenaltyTimer() {
        const now = Date.now();
        const remaining = Math.max(0, penaltyEndTime - now);
        
        if (remaining <= 0) {
            clearPenalty();
            return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const adButtonText = document.getElementById('adButtonText');
        if (adButtonText) {
            adButtonText.innerHTML = `Wait ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    function clearPenalty() {
        penaltyActive = false;
        clearInterval(penaltyInterval);
        
        localStorage.removeItem('penaltyEndTime');
        
        const startEarningAd = document.getElementById('startEarningAd');
        const adButtonText = document.getElementById('adButtonText');
        if (startEarningAd && adButtonText) {
            startEarningAd.disabled = false;
            startEarningAd.classList.remove('btn-penalty');
            adButtonText.textContent = 'Start Ad Task';
        }
        
        const penaltyWarningCard = document.getElementById('penaltyWarningCard');
        if (penaltyWarningCard) {
            penaltyWarningCard.style.display = 'none';
        }
    }
    
    function checkExistingPenalty() {
        const savedPenaltyEndTime = localStorage.getItem('penaltyEndTime');
        if (savedPenaltyEndTime) {
            const remaining = parseInt(savedPenaltyEndTime) - Date.now();
            if (remaining > 0) {
                penaltyEndTime = parseInt(savedPenaltyEndTime);
                applyPenalty();
            } else {
                localStorage.removeItem('penaltyEndTime');
            }
        }
    }
    
    function startAdTimer() {
        adStartTime = Date.now();
        clearInterval(adTimerInterval);
        
        adTimerInterval = setInterval(() => {
            const elapsed = Date.now() - adStartTime;
            if (elapsed >= (adminSettings.adDuration || 15) * 1000) {
                clearInterval(adTimerInterval);
            }
        }, 1000);
    }
    
    function checkAdCompletion() {
        const elapsed = Date.now() - adStartTime;
        clearInterval(adTimerInterval);
        
        const requiredDuration = (adminSettings.adDuration || 15) * 1000;
        if (elapsed < requiredDuration) {
            applyPenalty();
            showTopNotification(`Warning: Please watch ads for full ${adminSettings.adDuration || 15} seconds to earn rewards`, 5000);
            return false;
        }
        return true;
    }

    function showInstructionsPopup() {
    const popup = document.getElementById('instructionsPopup');
    if (popup) {
        popup.classList.remove('hidden'); // Remove tailwind hidden class
        popup.style.display = 'flex';     // Force flex display
        // Add animation class if you have one, or just show it
        setTimeout(() => popup.classList.add('active'), 10); 
    }
}

function hideInstructionsPopup() {
    const popup = document.getElementById('instructionsPopup');
    if (popup) {
        popup.classList.remove('active');
        popup.style.display = 'none';
        popup.classList.add('hidden'); // Re-add tailwind hidden class
    }
}
    // ===================== EVENT LISTENERS =====================
    function setupEventListeners() {
        // 1. Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showSection(item.dataset.target));
        });

        // 2. Earn Now button (Safety Check)
        const earnNowBtn = document.getElementById('earnNowBtn');
        if (earnNowBtn) {
            earnNowBtn.addEventListener('click', () => showSection('earn-section'));
        }

        // 3. Start Ad Task button
        const startEarningAd = document.getElementById('startEarningAd');
        const adButtonText = document.getElementById('adButtonText');
        
        if (startEarningAd) {
            startEarningAd.addEventListener('click', async () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                
                if (penaltyActive) {
                    showTopNotification('Please wait until the penalty timer expires to continue');
                    return;
                }
                
                if (userData.completedTasks >= userData.totalTasks) {
                    showTopNotification('All tasks completed for today!');
                    return;
                }

                startEarningAd.disabled = true;
                adButtonText.innerHTML = '<div class="spinner"></div> Loading ad...';
                
                try {
                    await loadAdSDK();
                    startAdTimer();
                    await show_9661177();
                    
                    if (!checkAdCompletion()) {
                        return;
                    }
                    
                    const earnings = adminSettings.earningsPerAd || 0.05;
                    userData.balance += earnings;
                    userData.totalEarnings += earnings;
                    userData.adsWatched++;
                    userData.completedTasks++;
                    
                    if(typeof HistoryManager !== 'undefined') {
                        HistoryManager.addRecord('ad', earnings, 'Video Ad Reward');
                    }
                    
                    await saveUserData();
                    updateUI();
                    showTopNotification(`Earned ${earnings.toFixed(2)} BDT!`);
                    
                } catch (error) {
                    console.error("Ad error:", error);
                    showTopNotification('Ad failed: ' + error.message);
                } finally {
                    if (!penaltyActive) {
                        startEarningAd.disabled = false;
                        adButtonText.textContent = 'Start Ad Task';
                    }
                }
            });
        }
        
        // 4. NEW Payment Modals (Safe Checks Added)
        const newClosePayment = document.getElementById('new-closeDynamicPaymentModal');
        if (newClosePayment) {
             newClosePayment.addEventListener('click', () => {
                 const modal = document.getElementById('new-dynamicPaymentEditModal');
                 if(modal) modal.classList.remove('active');
             });
        }

        const newSavePayment = document.getElementById('new-saveDynamicPaymentBtn');
        if (newSavePayment) {
            newSavePayment.addEventListener('click', async () => {
                await saveNewDynamicPaymentInfo();
            });
        }

        // 5. Invite friends
        const inviteFriendsBtn = document.getElementById('inviteFriendsBtn');
        if (inviteFriendsBtn) {
            inviteFriendsBtn.addEventListener('click', () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                showTopNotification('Invite feature coming soon!');
            });
        }
        
        // 6. Close dynamic payment modal (Old Logic Safe Check)
        const closeDynamicPaymentModal = document.getElementById('closeDynamicPaymentModal');
        if (closeDynamicPaymentModal) {
            closeDynamicPaymentModal.addEventListener('click', function() {
                const modal = document.getElementById('dynamicPaymentEditModal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            });
        }
        
        // 7. Telegram warning popup buttons
        const telegramWarningOk = document.getElementById('telegramWarningOk');
        if (telegramWarningOk) {
            telegramWarningOk.addEventListener('click', () => {
                document.getElementById('telegramWarningPopup').style.display = 'none';
            });
        }
        
        const telegramWarningGo = document.getElementById('telegramWarningGo');
        if (telegramWarningGo) {
            telegramWarningGo.addEventListener('click', () => {
                window.open('https://t.me/AdVault_3bot', '_blank');
                document.getElementById('telegramWarningPopup').style.display = 'none';
            });
        }
        
        // 8. Instructions popup buttons
        const showInstructions = document.getElementById('showInstructions');
        if (showInstructions) showInstructions.addEventListener('click', showInstructionsPopup);
        
        const closeInstructions = document.getElementById('closeInstructions');
        if (closeInstructions) closeInstructions.addEventListener('click', hideInstructionsPopup);
        
        const instructionsCloseBtn = document.getElementById('instructionsCloseBtn');
        if (instructionsCloseBtn) instructionsCloseBtn.addEventListener('click', hideInstructionsPopup);
        
        // 9. Maintenance popup refresh button
        const refreshMaintenanceBtn = document.getElementById('refreshMaintenanceBtn');
        if (refreshMaintenanceBtn) {
            refreshMaintenanceBtn.addEventListener('click', () => {
                location.reload();
            });
        }
        
        // 10. Refresh balance button
        const refreshBalance = document.getElementById('refreshBalance');
        if (refreshBalance) {
            refreshBalance.addEventListener('click', () => {
                updateUI();
                showTopNotification('Balance refreshed!');
            });
        }
        
        // 11. Notification Close Button (Safe Check)
        const closeNotifBtn = document.getElementById("closeNotificationBtn");
        if (closeNotifBtn) {
            closeNotifBtn.addEventListener("click", window.closeNotificationsModal);
        }
    }

/* ================= Notification System Logic ================= */

let unsubscribeNotifications = null;

// 1. Real-time Listener (Efficient: Only downloads 1 doc to check status)
function setupNotificationListener() {
    // If we have a listener already, don't create another
    if (unsubscribeNotifications) return;

    const lastCheck = userData.lastNotificationCheck || new Date(0).toISOString();
    
    // Query: Get notifications newer than the user's last check
    // Limit(1) ensures we don't download everything, saving Firebase costs
    const q = db.collection("adv2_notifications") // Ensure this collection exists in Firebase
        .where("createdAt", ">", lastCheck)
        .orderBy("createdAt", "desc")
        .limit(1);

    unsubscribeNotifications = q.onSnapshot((snapshot) => {
        const dot = document.getElementById("notificationDot");
        if (dot) {
            // Show red dot if snapshot is not empty
            if (!snapshot.empty) {
                dot.classList.remove("hidden");
            } else {
                dot.classList.add("hidden");
            }
        }
    });
}

// 2. Open Modal & Load Full List
/* ================= NOTIFICATION SYSTEM LOGIC (COMPLETE) ================= */

    // 1. Open Modal & Fetch Data
    /* ================= UPDATED NOTIFICATION LOGIC ================= */

// 1. Open Panel & Fetch Data
async function openNotificationsModal() {
    const overlay = document.getElementById("notifOverlay");
    const listEl = document.getElementById("notificationList");
    const badgeEl = document.getElementById("notifBadgeCount");
    
    // Show overlay
    overlay.classList.add("active");
    
    // Loading State
    listEl.innerHTML = '<div class="flex justify-center py-10"><div class="spinner border-gray-400"></div></div>';

    try {
        // Fetch last 20 notifications from Firebase
        const snapshot = await db.collection("adv2_notifications")
            .orderBy("createdAt", "desc")
            .limit(20)
            .get();

        listEl.innerHTML = ""; // Clear loading

        if (snapshot.empty) {
            listEl.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <i class="far fa-bell-slash text-4xl mb-3"></i>
                    <p>No notifications yet</p>
                </div>`;
            if(badgeEl) badgeEl.classList.add('hidden');
        } else {
            if(badgeEl) badgeEl.classList.remove('hidden');
            
            // Render Loop
            let delay = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Date Formatting
                let dateStr = "Recent";
                if (data.createdAt) {
                    const dateObj = new Date(data.createdAt);
                    const diffMs = new Date() - dateObj;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if(diffMins < 60) dateStr = `${diffMins} mins ago`;
                    else if(diffMins < 1440) dateStr = `${Math.floor(diffMins/60)} hours ago`;
                    else dateStr = dateObj.toLocaleDateString();
                }
                
                // Style Logic
                let typeClass = "icon-info";
                let iconClass = "fa-info-circle";
                const title = (data.title || "").toLowerCase();
                
                if(title.includes("bonus") || title.includes("earned")) { typeClass = "icon-success"; iconClass = "fa-check-circle"; }
                else if(title.includes("alert") || title.includes("failed")) { typeClass = "icon-warn"; iconClass = "fa-exclamation-triangle"; }
                else if(title.includes("promo")) { typeClass = "icon-promo"; iconClass = "fa-gift"; }

                // Create Item
                const item = document.createElement("div");
                item.className = "n-item unread"; // Add 'unread' class for blue strip
                item.style.animationDelay = `${delay}s`; // Stagger animation
                
                item.innerHTML = `
                    <div class="icon-box ${typeClass}">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="text-sm font-bold text-slate-800">${data.title || 'Notification'}</h4>
                            <span class="text-[10px] text-slate-400 font-medium">${dateStr}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">${data.message || ''}</p>
                    </div>
                `;
                listEl.appendChild(item);
                
                // Trigger Animation
                requestAnimationFrame(() => item.classList.add('animate-in'));
                delay += 0.05;
            });
        }

        // Update "Last Checked" time in database to clear red dot on header
        const nowISO = new Date().toISOString();
        if (userData.id || userData.username) {
            db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({
                lastNotificationCheck: nowISO
            });
            userData.lastNotificationCheck = nowISO;
        }
        
        // Hide Header Red Dot immediately
        const dot = document.getElementById("notificationDot");
        if(dot) dot.classList.add("hidden");

    } catch (error) {
        console.error("Error loading notifications:", error);
        listEl.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load notifications.</p>';
    }
}

// 2. Close Panel
window.closeNotificationsModal = function() {
    document.getElementById("notifOverlay").classList.remove("active");
};

// 3. Mark All Read (Visual Only)
window.markAllNotificationsRead = function() {
    const items = document.querySelectorAll('.n-item.unread');
    const badge = document.getElementById('notifBadgeCount');
    
    // Remove blue strip styling
    items.forEach(item => {
        item.classList.remove('unread');
        item.style.backgroundColor = '#ffffff'; // Visual feedback
    });

    if(badge) badge.style.display = 'none';
    
    // Feedback
    const btn = document.querySelector('button[onclick="markAllNotificationsRead()"]');
    if(btn) {
        const originalText = btn.innerText;
        btn.innerText = "All read ";
        setTimeout(() => btn.innerText = originalText, 2000);
    }
};

// OPTIONAL: Add this to close the modal when clicking the dark background
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById("notificationModal");
    if (modal) {
        modal.addEventListener('click', (e) => {
            // Close if clicking the dark overlay (not the white box)
            if (e.target === modal) {
                window.closeNotificationsModal();
            }
        });
    }
});

// ================= PAYMENT METHODS SECTION LOGIC =================

    let selectedMethodId = null;

    // ================= DYNAMIC MY WALLETS RENDERER =================
    function renderPaymentMethodsPage() {
        const grid = document.getElementById('paymentMethodsGrid');
        const editor = document.getElementById('paymentMethodEditor');
        
        // Hide editor initially
        if (editor) editor.classList.remove('active');
        selectedMethodId = null;
        
        // 1. Get Methods from Admin (or use defaults)
        let methods = adminSettings.paymentMethods || [];
        if (methods.length === 0) {
            methods = [
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', color: '#E2136E', type: 'number' },
                { id: 'nagad', name: 'Nagad', icon: 'fas fa-wallet', color: '#F8A01C', type: 'number' },
                { id: 'rocket', name: 'Rocket', icon: 'fas fa-rocket', color: '#8C34FF', type: 'number' },
                { id: 'paypal', name: 'PayPal', icon: 'fab fa-paypal', color: '#003087', type: 'email' }
            ];
        }

        if (!grid) return;
        grid.innerHTML = '';

        methods.forEach(method => {
            const currentVal = userData.paymentInfo[method.id] || '';
            const isLinked = currentVal.length > 0;
            
            // 2. GET DYNAMIC COLORS & ICONS
            const brandColor = method.color || '#64748b'; // Default to Slate if missing
            const iconClass = method.icon || 'fas fa-credit-card';
            
            // 3. Mask the Account Number (Privacy)
            let displayVal = 'Not Linked';
            if(isLinked) {
                if(currentVal.includes('@')) {
                    const parts = currentVal.split('@');
                    displayVal = parts[0].slice(0,3) + '***@' + parts[1];
                } else {
                    displayVal = currentVal.slice(0,3) + '  ' + currentVal.slice(-3);
                }
            }

            const card = document.createElement('div');
            card.className = 'wallet-card'; // Keeps base shape/padding
            
            // 4. APPLY DYNAMIC STYLING (The Fix)
            // Use the brand color with a subtle gradient overlay for depth
            card.style.backgroundColor = brandColor;
            card.style.backgroundImage = `linear-gradient(135deg, transparent 0%, rgba(0,0,0,0.2) 100%)`;
            card.style.boxShadow = `0 10px 20px -5px ${brandColor}66`; // Colored Shadow with transparency
            card.style.borderColor = 'transparent'; // Reset border
            
            card.onclick = () => {
                selectPaymentCard(method, currentVal, card);
                // Add white border on selection to stand out against color
                card.style.borderColor = 'rgba(255,255,255,0.8)';
            };
            
            card.innerHTML = `
                <div class="card-logo-area">
                    <div class="card-icon" style="background: rgba(255,255,255,0.2); color: white;">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="card-badge" style="background: rgba(0,0,0,0.2); color: white; backdrop-filter: blur(4px);">
                        ${isLinked ? '<i class="fas fa-check-circle"></i> Linked' : '<i class="fas fa-plus"></i> Add'}
                    </div>
                </div>
                <div class="card-details">
                    <div class="card-label" style="color: rgba(255,255,255,0.9);">${method.name} ${method.type === 'email' ? 'Email' : 'Number'}</div>
                    <div class="card-number" style="color: white; letter-spacing: 1px;">${displayVal}</div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function selectPaymentCard(method, currentVal, cardElement) {
        // 1. Visual Selection
        document.querySelectorAll('.wallet-card').forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');
        
        // 2. Setup Editor
        selectedMethodId = method.id;
        const editor = document.getElementById('paymentMethodEditor');
        const label = document.getElementById('editMethodLabel');
        const input = document.getElementById('editMethodValue');
        const hiddenId = document.getElementById('editMethodId');

        label.textContent = `${method.name} ${method.type === 'email' ? 'Email Address' : 'Wallet Number'}`;
        input.value = currentVal;
        input.placeholder = method.type === 'email' ? 'example@mail.com' : '01XXXXXXXXX';
        hiddenId.value = method.id;

        // 3. Show Editor (Slide Up)
        editor.classList.add('active');
        
        // Scroll to bottom to ensure editor is visible
        const section = document.getElementById('payment-methods-section');
        section.scrollTo({ top: section.scrollHeight, behavior: 'smooth' });
    }

    async function saveCurrentPaymentMethod() {
        if (!selectedMethodId) return;

        const val = document.getElementById('editMethodValue').value.trim();
        const btn = document.querySelector('#paymentEditForm button');
        
        // Simple Validation
        if (val.length < 5) {
            showTopNotification("Please enter a valid detail");
            return;
        }

        // UI Loading State
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        // Update Data
        userData.paymentInfo[selectedMethodId] = val;
        
        // Backward compatibility
        if(selectedMethodId === 'bkash') userData.bkash = val;
        if(selectedMethodId === 'paypal') userData.paypal = val;

        try {
            await saveUserData();
            showSuccessPopup("Wallet Updated!");
            
            // Refresh Grid to show new masked value
            renderPaymentMethodsPage();
            
            // Also update main profile text
            renderProfilePaymentMethods();
            
        } catch (e) {
            showTopNotification("Failed to save. Try again.");
        } finally {
            btn.innerHTML = oldHtml;
            btn.disabled = false;
        }
    }

    async function clearCurrentPaymentMethod() {
        if (!selectedMethodId) return;
        
        if(!confirm("Are you sure you want to unlink this account?")) return;

        delete userData.paymentInfo[selectedMethodId];
        // Backward compatibility
        if(selectedMethodId === 'bkash') userData.bkash = "";
        if(selectedMethodId === 'paypal') userData.paypal = "";

        await saveUserData();
        showTopNotification("Account unlinked.");
        
        // Reset UI
        document.getElementById('editMethodValue').value = "";
        renderPaymentMethodsPage();
        renderProfilePaymentMethods();
    }
    // ===================== INITIALIZE APP =====================
    async function initApp() {
    /* ================= LOADING SCREEN LOGIC ================= */

    /* ================= LOADING SCREEN LOGIC (OPTIMIZED) ================= */

    window.addEventListener('load', () => {
        const bar = document.getElementById('loadingBar');
        const text = document.getElementById('loadingStatus');
        const screen = document.getElementById('splashScreen');
        
        // Lock scroll
        document.body.style.overflow = 'hidden';

        let progress = 0;
        
        // Use requestAnimationFrame for buttery smooth 60fps animation
        function animateLoad() {
            // Increment speed (randomized for realism)
            progress += Math.random() * 2.5; 
            
            if (progress > 100) progress = 100;
            
            // Update DOM
            if(bar) bar.style.width = progress + '%';

            // Update Text (Reduced layout thrashing)
            if(text) {
                if (progress < 30) {
                    if(text.innerText !== "Connecting...") text.innerText = "Connecting...";
                } else if (progress < 60) {
                    if(text.innerText !== "Verifying User...") text.innerText = "Verifying User...";
                } else if (progress < 90) {
                    if(text.innerText !== "Syncing Data...") text.innerText = "Syncing Data...";
                } else {
                    if(text.innerText !== "Finalizing...") text.innerText = "Finalizing...";
                }
            }

            if (progress < 100) {
                requestAnimationFrame(animateLoad);
            } else {
                // Done
                setTimeout(() => {
                    if(screen) {
                        screen.classList.add('fade-out-up');
                        // Force GPU layer removal after animation
                        screen.style.willChange = 'auto'; 
                    }
                    document.body.style.overflow = 'auto';
                    setTimeout(() => { 
                        if(screen) screen.style.display = 'none'; 
                    }, 600);
                }, 200);
            }
        }
        
        // Start the engine
        requestAnimationFrame(animateLoad);
    });
        document.getElementById('header-username').textContent = "Loading...";
        
        checkExistingPenalty();
        await loadAdminSettings();
        setupAdminSettingsListener();
        
        const isTelegram = await initTelegram();
        let telegramUserData = null;
        let telegramDetected = false;
        
        if (isTelegram) {
            telegramUserData = getTelegramUserData();
            telegramDetected = !!telegramUserData;
        }
        
        if (!telegramDetected) {
            document.getElementById('telegramWarningPopup').style.display = 'flex';
        }
        
        if (telegramUserData) {
            document.getElementById('telegramConnected').style.display = 'block';
            setTimeout(() => {
                document.getElementById('telegramConnected').style.display = 'none';
            }, 3000);
            
            userData.id = telegramUserData.id;
            userData.name = telegramUserData.name;
            userData.username = telegramUserData.username;
            userData.telegramDetected = true;
            userData.source = "telegram";
            
            if (telegramUserData.photoUrl) {
                userData.profilePhoto = telegramUserData.photoUrl;
            }
            
            showTopNotification(`Welcome ${telegramUserData.username}!`);
            await loadUserData(userData.id);
        }
        
       // ... (telegram logic above remains same) ...
        
        // --- UPDATED FALLBACK LOGIC ---
        if (!userData.username) {
            // Setup Guest User (In-Memory Only)
            userData.username = "Guest";
            userData.source = "web";
            userData.telegramDetected = false; // Enforce false
            
            console.log("Guest Mode Initialized: No Firestore connection.");
            
            // HIDE LOADER MANUALLY (Since we are skipping loadUserData)
            document.getElementById("firebaseLoading").style.display = "none";
            
            // Optional: Show a subtle notification
            // showTopNotification("Guest Mode: Progress will not be saved.");
        }
        
        updateUI();
        userCountry = await detectCountry();
        setCountryFlag(userCountry);
        
        // Save country ONLY if Telegram detected (Re-using our safe save function)
        if (userCountry && userData.country !== userCountry) {
            userData.country = userCountry;
            saveUserData(); 
        }
        
        checkDailyReset();
        setupEventListeners();
        
        const closeBtn = document.getElementById("closeNotificationBtn");
        if (closeBtn) {
            closeBtn.addEventListener("click", window.closeNotificationsModal);
        }
        
        // Only setup listeners for real users
        if (userData.telegramDetected) {
            setupNotificationListener();
        }
        
        showSection('home-section');
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initApp);
    /* ================= HISTORY MANAGER (LOCAL STORAGE) ================= */
    const HistoryManager = {
        KEY: 'adv_earning_history_v1',
        RETENTION_HOURS: 72,

        // Save a new record
        addRecord: function(type, amount, title) {
            try {
                const now = new Date();
                const record = {
                    id: Date.now() + Math.random().toString(36).substr(2, 5),
                    type: type, // 'ad' or 'task'
                    amount: parseFloat(amount),
                    title: title,
                    timestamp: now.toISOString()
                };

                // Get existing
                let history = this.getHistory();
                
                // Add new to top
                history.unshift(record);
                
                // Prune old data
                history = this.pruneHistory(history);
                
                // Save back
                localStorage.setItem(this.KEY, JSON.stringify(history));
                return true;
            } catch (e) {
                console.error("Save history failed", e);
                return false;
            }
        },

        // Get all history
        getHistory: function() {
            try {
                const raw = localStorage.getItem(this.KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        },

        // Remove items older than 72 hours
        pruneHistory: function(list) {
            const cutoff = new Date();
            cutoff.setHours(cutoff.getHours() - this.RETENTION_HOURS);
            return list.filter(item => new Date(item.timestamp) > cutoff);
        },
        
        // Calculate total for display
        getRecentTotal: function() {
            const list = this.getHistory();
            return list.reduce((sum, item) => sum + (item.amount || 0), 0);
        }
    };

    // Render Function for UI
    function renderEarningHistory(filterType = 'all') {
        const container = document.getElementById('earningHistoryContainer');
        const totalDisplay = document.getElementById('history-total-72h');
        
        // 1. Get Data
        let data = HistoryManager.getHistory();
        
        // 2. Update Total
        if(totalDisplay) {
            const total = HistoryManager.getRecentTotal();
            totalDisplay.textContent = `+ BDT ${total.toFixed(2)}`;
        }
        
        // 3. Apply Filter
        if (filterType !== 'all') {
            data = data.filter(item => item.type === filterType);
        }
        
        // 4. Group by Date
        container.innerHTML = '';
        
        if (data.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 opacity-50">
                    <i class="fas fa-history text-4xl mb-3 text-gray-300"></i>
                    <p class="text-gray-500">No records found</p>
                </div>`;
            return;
        }

        let currentDate = '';
        
        data.forEach(item => {
            const dateObj = new Date(item.timestamp);
            // Check if date header needed
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const isToday = new Date().toDateString() === dateObj.toDateString();
            const displayDate = isToday ? 'Today' : dateStr;
            
            if (displayDate !== currentDate) {
                currentDate = displayDate;
                container.innerHTML += `
                    <div class="date-header">
                        <span>${displayDate}</span>
                        <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-400">${dateStr}</span>
                    </div>`;
            }

            // Render Item
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const iconClass = item.type === 'ad' ? 'icon-ad' : 'icon-task';
            const iconHTML = item.type === 'ad' ? '<i class="fas fa-play"></i>' : '<i class="fas fa-star"></i>';
            
            container.innerHTML += `
                <div class="history-item">
                    <div class="item-icon ${iconClass}">
                        ${iconHTML}
                    </div>
                    <div class="item-meta">
                        <p class="item-title">${item.title}</p>
                        <p class="item-time">${timeStr}</p>
                    </div>
                    <div class="item-amount">
                        <p class="amt-val">+${item.amount.toFixed(2)}</p>
                        <p class="amt-status">Added</p>
                    </div>
                </div>`;
        });
    }
    
    // Tab Switching Logic
    window.filterEarningHistory = function(type, btnElement) {
        // Update UI
        document.querySelectorAll('.tab-pill').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        // Render
        renderEarningHistory(type);
    }
    // ================= NEW WITHDRAWAL LOGIC =================

    let selectedWithdrawMethod = null;

    // 1. Initialize the Withdrawal Page
   
    function renderWithdrawPage() {
        const grid = document.getElementById('withdrawMethodGrid');
        const balanceDisplay = document.getElementById('withdraw-balance-display');
        const minDisplay = document.getElementById('minWithdrawDisplay');
        
        // Update Balance
        if(balanceDisplay) balanceDisplay.textContent = `BDT ${userData.balance.toFixed(2)}`;
        
        // 1. READ SETTINGS FROM ADMIN (This connects your Admin Panel to the App)
        let methods = adminSettings.paymentMethods || [];
        
        // Fallback if no methods exist yet
        if (methods.length === 0) {
            methods = [
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', color: '#E2136E', minWithdraw: 100 },
                { id: 'nagad', name: 'Nagad', icon: 'fas fa-wallet', color: '#F8A01C', minWithdraw: 100 }
            ];
        }
        
        // Update Min Withdraw Text
        const defaultMin = methods[0]?.minWithdraw || 100;
        if(minDisplay) minDisplay.textContent = defaultMin.toFixed(2);

        // 2. RENDER GRID
        if(grid) {
            grid.innerHTML = '';
            methods.forEach((method, index) => {
                const card = document.createElement('div');
                
                // Auto-select first method
                if (index === 0) selectedWithdrawMethod = method;
                const isSelected = selectedWithdrawMethod?.id === method.id;
                
                // USE THE SAVED COLOR
                const brandColor = method.color || '#64748b'; 
                const iconClass = method.icon || 'fas fa-wallet';

                // Apply Styles
                card.className = `method-card ${isSelected ? 'selected' : ''}`;
                
                // Apply Color to Border/Shadow if selected
                if(isSelected) {
                    card.style.borderColor = brandColor;
                    card.style.backgroundColor = 'rgba(255,255,255,1)';
                    card.style.boxShadow = `0 4px 12px -2px ${brandColor}40`; 
                }

                card.onclick = () => selectWithdrawMethod(method, card);
                
                card.innerHTML = `
                    <div class="check-badge" style="color: ${brandColor}; display: ${isSelected ? 'block' : 'none'};">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <div class="method-icon" style="color: ${brandColor}">
                    <i class="${iconClass}"></i>
                    </div>
                    <span class="method-name">${method.name}</span>
                `;
                grid.appendChild(card);
            });
        }
        
        updateSendingToBox();
        renderMiniHistory();
    }
    // 2. Select Method Logic
    
    function selectWithdrawMethod(method, cardElement) {
        selectedWithdrawMethod = method;
        const brandColor = method.color || '#64748b';
        
        // 1. Reset all cards
        document.querySelectorAll('.method-card').forEach(c => {
            c.classList.remove('selected');
            c.style.borderColor = '#e2e8f0'; // Reset to grey
            c.style.boxShadow = 'none';
            c.style.backgroundColor = 'white';
            
            // Hide checks
            const badge = c.querySelector('.check-badge');
            if(badge) badge.style.display = 'none';
        });
        
        // 2. Highlight clicked card with ITS COLOR
        cardElement.classList.add('selected');
        cardElement.style.borderColor = brandColor;
        cardElement.style.boxShadow = `0 4px 12px -2px ${brandColor}40`;
        
        // Show check badge
        const badge = cardElement.querySelector('.check-badge');
        if(badge) {
            badge.style.display = 'block';
            badge.style.color = brandColor;
        }
        
        // 3. Update Info Box
        updateSendingToBox();
    }
    // 3. Update "Sending To" Info
    function updateSendingToBox() {
        if(!selectedWithdrawMethod) return;
        
        const box = document.getElementById('sendingToBox');
        const msg = document.getElementById('linkAccountMsg');
        const numDisplay = document.getElementById('sendingToNumber');
        
        const linkedNum = userData.paymentInfo[selectedWithdrawMethod.id] || 
                          (selectedWithdrawMethod.id === 'bkash' ? userData.bkash : '') ||
                          (selectedWithdrawMethod.id === 'paypal' ? userData.paypal : '');

        if (linkedNum && linkedNum.length > 2) {
            box.classList.remove('hidden');
            msg.classList.add('hidden');
            numDisplay.textContent = linkedNum;
        } else {
            box.classList.add('hidden');
            msg.classList.remove('hidden');
        }
    }

    // 4. Quick Amount Logic
    function setWithdrawAmount(amt) {
        const input = document.getElementById('withdrawAmountInput');
        
        // Reset pills
        document.querySelectorAll('.pill-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        if (amt === 'max') {
            input.value = Math.floor(userData.balance);
        } else {
            input.value = amt;
        }
        updateWithdrawSummary();
    }

    // 5. Update Summary Logic
    function updateWithdrawSummary() {
        const input = document.getElementById('withdrawAmountInput');
        const amount = parseFloat(input.value) || 0;
        
        document.getElementById('summaryAmount').textContent = `BDT ${amount.toFixed(2)}`;
        document.getElementById('summaryTotal').textContent = `BDT ${amount.toFixed(2)}`;
        // If you implement fees later, update logic here
    }
    // ================= WITHDRAWAL SUBMISSION LOGIC =================

async function submitWithdrawal() {
    // 1. Validation Checks
    if (!selectedWithdrawMethod) {
        showTopNotification("Please select a payment method");
        return;
    }

    const input = document.getElementById('withdrawAmountInput');
    const amount = parseFloat(input.value);
    const minWithdraw = selectedWithdrawMethod.minWithdraw || 100;

    // Check Amount
    if (isNaN(amount) || amount <= 0) {
        showTopNotification("Please enter a valid amount");
        return;
    }

    if (amount < minWithdraw) {
        showTopNotification(`Minimum withdrawal is BDT ${minWithdraw}`);
        return;
    }

    // Check Balance
    if (amount > userData.balance) {
        showTopNotification("Insufficient balance for this withdrawal");
        return;
    }

    // 2. Check if Account is Linked
    const methodId = selectedWithdrawMethod.id;
    // Look in paymentInfo object first, then fallback to old fields
    const accountNum = (userData.paymentInfo && userData.paymentInfo[methodId]) 
                       || userData[methodId] 
                       || userData.paymentInfo?.[methodId.toLowerCase()]; 

    if (!accountNum) {
         showTopNotification(`Please link your ${selectedWithdrawMethod.name} account first`);
         // Redirect to link page
         showSection('payment-methods-section');
         renderPaymentMethodsPage();
         return;
    }

    // 3. UI Loading State
    const btn = document.querySelector('.withdraw-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing...';
    btn.disabled = true;

    try {
        // 4. Firebase Batch Update (Atomic Operation)
        const batch = db.batch();
        
        // A. Update User Balance
        const userRef = db.collection(USERS_COLLECTION).doc(userData.id || userData.username);
        const newBalance = userData.balance - amount;
        const newWithdrawn = (userData.totalWithdrawn || 0) + amount;
        
        batch.update(userRef, {
            balance: newBalance,
            totalWithdrawn: newWithdrawn,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });

        // B. Create Withdrawal Record
        const withdrawRef = db.collection(WITHDRAWALS_COLLECTION).doc();
        batch.set(withdrawRef, {
            userId: userData.id || userData.username,
            username: userData.username,
            amount: amount,
            method: selectedWithdrawMethod.name,
            methodId: methodId,
            accountNumber: accountNum,
            status: 'pending',
            timestamp: new Date().toISOString(),
            fee: 0, // Set fee logic here if needed
            deviceSource: 'web_app_v2'
        });

        // Commit changes
        await batch.commit();

        // 5. Update Local Data & UI
        userData.balance = newBalance;
        userData.totalWithdrawn = newWithdrawn;
        
        updateUI(); // Refresh header/profile balance
        input.value = ''; // Clear input
        document.getElementById('summaryAmount').innerText = 'BDT 0.00';
        document.getElementById('summaryTotal').innerText = 'BDT 0.00';
        
        // 6. Show Success & Refresh History
        if (typeof fetchWithdrawalHistory === 'function') fetchWithdrawalHistory();
        if (typeof renderMiniHistory === 'function') renderMiniHistory();

        // Trigger the new Success Modal
        const successModal = document.getElementById('new-successModal');
        if(successModal) {
            successModal.classList.add('active');
        } else {
            showSuccessPopup(`Withdrawal of BDT ${amount} submitted!`);
        }

    } catch (error) {
        console.error("Withdrawal failed:", error);
        showTopNotification("Network error. Please try again.");
    } finally {
        // Reset Button
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
    // 6. Mini History Renderer
    function renderMiniHistory() {
        const container = document.getElementById('miniWithdrawHistory');
        if(!container) return;
        
        // Use the global variable we populated in Fix 2
        // Slice(0, 2) to take only the top 2 items
        const list = (typeof globalWithdrawalHistory !== 'undefined') ? globalWithdrawalHistory.slice(0, 2) : [];
        
        container.innerHTML = '';
        if(list.length === 0) {
            container.innerHTML = '<p class="text-xs text-center text-slate-400 py-4 bg-white rounded-xl border border-gray-100">No recent transactions</p>';
            return;
        }

        list.forEach(item => {
            const isSuccess = item.status === 'approved' || item.status === 'completed';
            const statusColor = isSuccess ? 'bg-green-50 text-green-600' : 'bg-yellow-50 text-yellow-600';
            const icon = isSuccess ? 'fa-check' : 'fa-clock';
            const statusText = item.status || 'Pending';
            
            container.innerHTML += `
              <div class="history-item" style="background: white; padding: 1rem; border-radius: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: space-between; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.01);">
                  <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full ${statusColor} flex items-center justify-center">
                          <i class="fas ${icon}"></i>
                      </div>
                      <div>
                          <p class="text-sm font-bold text-slate-800 capitalize">${item.method}</p>
                          <p class="text-xs text-slate-400">${new Date(item.date).toLocaleDateString()}</p>
                      </div>
                  </div>
                  <div class="text-right">
                      <p class="text-sm font-bold text-slate-800">-${item.amount}</p>
                      <p class="text-[10px] font-bold uppercase ${isSuccess ? 'text-green-600' : 'text-yellow-600'}">
                        ${statusText}
                      </p>
                  </div>
              </div>`;
        });
    }

    // Hook this new render function to your showSection logic
    // Add this line inside your showSection function for 'withdraw-section':
    // if (sectionId === 'withdraw-section') renderWithdrawPage();
    
    /* ================= SYSTEM ALERTS LOGIC ================= */

    // 1. Trigger Error Modal
    function triggerError(title, msg) {
    // Instead of opening the old modal, we show a Droid Notification
    showTopNotification(msg);
}
    // 2. Trigger Confirmation Modal
    let onConfirmCallback = null; // Store the function to run

    function triggerConfirm(title, msg, callback) {
        const modal = document.getElementById('confirmModal');
        
        // Update Text
        if(title) document.getElementById('confirmTitle').textContent = title;
        if(msg) document.getElementById('confirmMsg').textContent = msg;
        
        // Show Modal
        modal.classList.add('show');
        
        // Store callback
        if (callback) {
            onConfirmCallback = callback;
        } else {
            onConfirmCallback = () => { console.log("Confirmed!"); };
        }
    }

    // Executed when user clicks "Yes"
    function confirmAction() {
        if (onConfirmCallback) onConfirmCallback();
        closeModal('confirmModal');
    }

    // 3. Generic Close Function
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
        }
    }
    
    // Example Usage:
    // triggerConfirm("Log Out?", "Are you sure you want to exit?", () => { performLogout(); });

// ================= WITHDRAWAL SECTION LOGIC =================

    // 1. Render the Payment Grid with Admin Colors
    function renderWithdrawSection() {
        const grid = document.getElementById('paymentMethodsGrid');
        if (!grid) return;

        // Get methods from Admin Settings (or use defaults if loading/empty)
        // We use 'contentSettings' which is loaded from Firestore in your init()
        const methods = (typeof contentSettings !== 'undefined' && contentSettings.paymentMethods && contentSettings.paymentMethods.length > 0) 
            ? contentSettings.paymentMethods 
            : [
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', color: '#E2136E', type: 'number', minWithdraw: 100 },
                { id: 'nagad', name: 'Nagad', icon: 'fas fa-mobile-alt', color: '#F7921E', type: 'number', minWithdraw: 100 },
                { id: 'rocket', name: 'Rocket', icon: 'fas fa-rocket', color: '#8C3494', type: 'number', minWithdraw: 100 },
                { id: 'binance', name: 'Binance', icon: 'fab fa-bitcoin', color: '#F0B90B', type: 'text', minWithdraw: 500 }
              ];

        grid.innerHTML = methods.map(method => {
            // Default color if missing
            const color = method.color || '#64748b'; 
            // Default icon if missing
            const icon = method.icon || 'fas fa-wallet';

            return `
            <div class="method-card" 
                 id="method-${method.id}" 
                 onclick="selectPaymentMethod('${method.id}', '${method.type}', '${method.minWithdraw || 100}', '${color}')"
                 data-color="${color}">
                 
                <div class="check-badge" style="color: ${color}">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <i class="${icon} method-icon" style="color: ${color}; font-size: 1.75rem; margin-bottom: 0.5rem;"></i>
                
                <span class="method-name" style="font-size: 0.75rem; font-weight: 600; color: #475569;">${method.name}</span>
            </div>
            `;
        }).join('');
    }

    // 2. Handle Card Clicks (Highlighting & Inputs)
    let selectedPaymentMethodId = null;

    function selectPaymentMethod(id, type, min, color) {
        selectedPaymentMethodId = id;
        
        // Reset all cards
        document.querySelectorAll('.method-card').forEach(card => {
            card.classList.remove('selected');
            card.style.borderColor = '#e2e8f0';
            card.style.backgroundColor = 'white';
            card.style.boxShadow = 'none';
        });

        // Highlight active card
        const card = document.getElementById(`method-${id}`);
        if (card) {
            card.classList.add('selected');
            card.style.borderColor = color;
            // Light background tint
            card.style.backgroundColor = hexToRgba(color, 0.05);
            card.style.boxShadow = `0 4px 10px -2px ${hexToRgba(color, 0.2)}`;
        }

        // Show Input Fields
        const inputContainer = document.getElementById('paymentDetailsContainer');
        const label = document.getElementById('paymentInputLabel');
        const input = document.getElementById('paymentDetails');
        const minLabel = document.getElementById('minWithdrawLabel');
        
        if(inputContainer) inputContainer.style.display = 'block';
        if(input) input.value = ''; // Clear old input
        
        // Update Label based on Type
        if (label && input) {
            if (type === 'number') {
                label.innerText = 'Enter Wallet Number';
                input.placeholder = 'e.g. 017xxxxxxxx';
                input.type = 'tel';
            } else if (type === 'email') {
                label.innerText = 'Enter Email Address';
                input.placeholder = 'e.g. user@example.com';
                input.type = 'email';
            } else {
                label.innerText = 'Enter Wallet ID / Address';
                input.placeholder = 'Wallet ID...';
                input.type = 'text';
            }
        }

        // Update Min Withdraw Text
        if(minLabel) minLabel.innerText = `Min: ${min} BDT`;
    }

    // 3. Helper for Colors
    function hexToRgba(hex, alpha) {
        let c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c= hex.substring(1).split('');
            if(c.length== 3){
                c= [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c= '0x'+c.join('');
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
        }
        return `rgba(0,0,0,${alpha})`;
    }
    // --- MISSING ALERT HISTORY FUNCTIONS ---

function renderNotifHistory() {
    const list = document.getElementById('notif-history-list');
    if (!list) return;

    // Fetch from Local Storage
    const history = JSON.parse(localStorage.getItem('advault_notif_history') || '[]');
    
    // Clear current list
    list.innerHTML = '';

    if (history.length === 0) {
        list.innerHTML = `
            <div class="text-center py-20 opacity-40">
                <i class="fas fa-bell-slash text-4xl mb-3 text-slate-300"></i>
                <p class="text-sm text-slate-400">No recent alerts found</p>
            </div>`;
        return;
    }

    // Generate List
    list.innerHTML = history.map(item => {
        let iconClass = "bg-blue-50 text-blue-500"; // Default
        let icon = "fa-bell";
        
        if (item.type === 'security') { iconClass = "bg-red-50 text-red-500"; icon = "fa-exclamation-triangle"; }
        if (item.type === 'earning' || item.type === 'success') { iconClass = "bg-green-50 text-green-500"; icon = "fa-check-circle"; }

        const dateObj = new Date(item.time);
        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        return `
            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex gap-3 animate-fade-in">
                <div class="w-10 h-10 rounded-xl ${iconClass} flex items-center justify-center shrink-0">
                    <i class="fas ${icon} text-sm"></i>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <h4 class="text-sm font-bold text-slate-800">${item.title}</h4>
                        <span class="text-[10px] text-slate-400 font-bold uppercase">${timeStr}</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">${item.message}</p>
                </div>
            </div>`;
    }).join('');
}

function clearNotifHistory() {
    if(confirm("Are you sure you want to delete all history?")) {
        localStorage.removeItem('advault_notif_history');
        renderNotifHistory(); // Re-render to show empty state
    }
}
</script>
</body>
</html>
