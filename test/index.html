<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdVault Earnings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src='//libtl.com/sdk.js' data-zone='9661177' data-sdk='show_9661177'></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
<style>
    :root {
      --color-primary: #1A5237;
      --color-secondary: #3B7A57;
      --color-accent: #FFD700;
      --color-success: #28a745;
      --color-logo-blue: #2A64B2;
      --color-logo-green: #4CAF50;
      --color-logo-gold: #FFD700;
      --color-logo-orange: #FFA500;
      --color-logo-light-green: #8BC34A;
      --color-danger: #ef4444;
      --color-warning: #f59e0b;
      --color-light: #f8fafc;
      --color-dark: #1e293b;
      --color-gray: #64748b;
      --color-light-gray: #e2e8f0;
      
      --gradient-primary: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.25rem;
      --radius-full: 9999px;
    }
.withdraw-btn {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e0e0e0 0%, #f8f9fa 100%);
      color: #334155;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    

/* Additional Styles for Compact Stats Grid */
.stats-grid-compact .stat-item {
  transition: all 0.2s ease;
}

.stats-grid-compact .stat-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Ensure consistent icon sizing */
.stats-grid-compact .stat-icon {
  min-width: 40px;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}
    /* ===================== UPDATED TOP BAR ANIMATIONS ===================== */
    .fixed-top-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 6rem;
      z-index: 1001;
      background: #ffffff;
      padding: 1rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      border-radius: 0 0 1rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  opacity 0.3s ease,
                  visibility 0.4s ease;
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    /* Hide top bar for profile, withdraw, and history sections */
    body.header-hidden .fixed-top-header {
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
    }

    .fixed-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5rem;
      z-index: 1000;
      background: #ffffff;
      padding: 1rem;
      box-shadow: 0 -15px 30px rgba(0,0,0,0.1);
      border-radius: 1rem 1rem 0 0;
    }

    /* Adjust main content when header is hidden */
    main {
      position: fixed;
      top: 6rem;
      bottom: 5rem;
      left: 0;
      right: 0;
      overflow: hidden;
      padding: 1rem;
      transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body.header-hidden main {
      top: 0;
    }

    .sections-container {
      height: 100%;
      width: 100%;
      position: relative;
      overflow: hidden;
    }

    .section {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 1rem;
      display: none;
      background: transparent;
    }
    .section.active {
      display: block;
    }
    
    /* Full Screen Section Override (For Profile and Withdraw) */
    .section-fullscreen {
        top: 0 !important; /* Changed from -6rem to 0 when header hidden */
        padding-top: 1rem !important;
        background: #f8fafc;
        z-index: 1050;
        height: 100%;
    }

    /* Adjust section-fullscreen when header is visible */
    body:not(.header-hidden) .section-fullscreen {
        top: -6rem !important;
        height: calc(100% + 6rem);
    }

    .nav-item {
      transition: all 0.3s ease-in-out;
      color: #64748b;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .nav-item.active {
      color: var(--color-logo-green);
      font-weight: 600;
      transform: translateY(-4px);
    }

    .content-card {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }

    .section-content {
      min-height: calc(100% - 2rem);
      display: flex;
      flex-direction: column;
    }

    #marqueeContainer {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      background-color: #FFFACD;
      padding: 1rem;
      border-radius: 1rem 1rem 0 0;
    }
    #marqueeText {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
      color: #B8860B;
      font-weight: 600;
      font-size: 0.875rem;
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    #androidTopNotification {
      position: fixed;
      top: 7rem;
      left: 50%;
      transform: translateY(-100%) translateX(-50%);
      width: 90%;
      max-width: 28rem;
      background: #1f2937;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      text-align: center;
      z-index: 9999;
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    #androidTopNotification.show {
      transform: translateY(0) translateX(-50%);
      opacity: 1;
    }

    #editModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1003;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    #editModal.show {
      display: flex;
      opacity: 1;
    }
    #editModal .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 28rem;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    #editModal.show .modal-content {
      transform: translateY(0);
    }

    #successPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 82, 55, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1002;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    #successPopup.show {
      opacity: 1;
      pointer-events: auto;
    }

   .checkmark-wrapper {
      width: 100px;
      height: 100px;
      margin: 0 auto 1.5rem;
    }

    .checkmark {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: block;
      stroke-width: 5;
      stroke: var(--color-success);
      stroke-miterlimit: 10;
      box-shadow: inset 0 0 0 var(--color-success);
      animation:
        fill 0.4s ease-in-out 0.4s forwards,
        scale 0.3s ease-in-out 0.9s both;
    }

    .checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 5;
      stroke-miterlimit: 10;
      stroke: var(--color-success);
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    @keyframes fill {
      100% {
        box-shadow: inset 0 0 0 100px rgba(16, 185, 129, 0.1);
      }
    }

    .btn-primary {
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green)) !important;
      color: white !important;
      border-radius: 9999px !important;
      padding: 0.75rem 2rem !important;
      border: none !important;
      font-weight: 600 !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      cursor: pointer !important;
      transition: transform 0.2s !important;
      width: 100% !important;
    }
    .btn-primary:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    }
    #inviteFriendsBtn {
      background-color: var(--color-logo-gold) !important;
      color: #334155 !important;
    }
    .edit-payment-btn {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background-color: var(--color-logo-green);
      color: white;
      border: none;
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }
    .edit-payment-btn:hover {
      background-color: var(--color-logo-light-green);
      transform: translateY(-2px);
    }
    .edit-payment-btn i {
      margin-right: 0.25rem;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .banner-img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: 0 0 1rem 1rem;
      background: linear-gradient(45deg, var(--color-logo-blue), var(--color-logo-green));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.5rem;
    }

    .telegram-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #0088cc;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .telegram-connected {
      position: fixed;
      bottom: 6rem;
      left: 50%;
      transform: translateX(-50%);
      background: #0088cc;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      z-index: 1000;
      display: none;
    }

    .profile-image {
      width: 128px;
      height: 128px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--color-logo-light-green);
      background-color: #E6FFE6;
    }

    .profile-placeholder {
      width: 128px;
      height: 128px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 4px solid var(--color-logo-light-green);
      background-color: #E6FFE6;
      font-size: 4rem;
      color: var(--color-logo-green);
    }

    .profile-header-image {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      border: 2px solid #C1E1C1;
    }

    .profile-header-placeholder {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #E6FFE6;
      color: var(--color-logo-green);
      font-size: 1.5rem;
      margin-right: 12px;
      border: 2px solid #C1E1C1;
    }

    .validation-error {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: none;
    }

    .country-flag {
      margin-left: 8px;
      font-size: 1.5rem;
      vertical-align: middle;
    }

    .firebase-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .firebase-loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--color-logo-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .profile-id {
      font-family: monospace;
      background-color: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .withdrawal-history-container {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .withdrawal-history-table {
      width: 100%;
      border-collapse: collapse;
      text-align: left;
    }

    .withdrawal-history-table th,
    .withdrawal-history-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .withdrawal-history-table th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #475569;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .withdrawal-history-table tbody tr:last-child td {
      border-bottom: none;
    }

    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-approved {
      background-color: #d1fae5;
      color: #065f46;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-rejected {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .history-btn {
      background-color: var(--color-logo-green);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
    }
    .history-btn:hover {
      background-color: var(--color-logo-light-green);
      transform: translateY(-2px);
    }
    .history-btn i {
      margin-right: 0.25rem;
    }

    .withdraw-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .content-card.bg-gradient-to-br.from-purple-600.to-indigo-700 {
        background: linear-gradient(to bottom right, var(--color-logo-blue), var(--color-logo-green));
    }

    .content-card.bg-gradient-to-br.from-gray-800.to-gray-900 {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange));
    }
    .content-card.bg-gradient-to-br.from-gray-800.to-gray-900 .bg-white.p-3.rounded-full.text-gray-800 {
        color: var(--color-logo-gold);
    }

    .content-card.bg-gradient-to-br.from-blue-500.to-cyan-500 {
        background: linear-gradient(to bottom right, var(--color-logo-blue), var(--color-logo-green));
    }

    .content-card.bg-gradient-to-br.from-red-500.to-orange-500 {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange));
    }

    #earn-progress-bar {
        background-color: var(--color-logo-green) !important;
    }

    .balance-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green));
      color: white;
      border-radius: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .balance-text {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .balance-amount {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .withdraw-btn {
      background-color: var(--color-logo-gold);
      color: #334155;
      border: none;
      border-radius: 9999px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .withdraw-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .back-button {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      color: var(--color-logo-blue);
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
    }

    #maintenancePopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }
    .maintenance-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 28rem;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .maintenance-icon {
      font-size: 3rem;
      color: #f59e0b;
      margin-bottom: 1rem;
    }
    .maintenance-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    .maintenance-message {
      font-size: 1rem;
      color: #4b5563;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .maintenance-time {
      font-size: 0.9rem;
      color: #6b7280;
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    .maintenance-btn {
      padding: 0.75rem 2rem;
      background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green));
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .maintenance-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #telegramWarningPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 1rem;
    }
    .telegram-warning-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 28rem;
      text-align: center;
    }
    .telegram-warning-icon {
      font-size: 3rem;
      color: #ef4444;
      margin-bottom: 1rem;
    }
    .telegram-warning-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1f2937;
    }
    .telegram-warning-message {
      font-size: 1rem;
      color: #4b5563;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .telegram-warning-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .telegram-warning-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .telegram-warning-btn-ok {
      background-color: #3b82f6;
      color: white;
      border: none;
    }
    .telegram-warning-btn-ok:hover {
      background-color: #2563eb;
    }
    .telegram-warning-btn-go {
      background-color: #10b981;
      color: white;
      border: none;
    }
    .telegram-warning-btn-go:hover {
      background-color: #059669;
    }

    .penalty-warning {
      color: #ef4444;
      font-weight: 600;
      text-align: center;
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #fee2e2;
      border-radius: 0.5rem;
      display: none;
    }

    .penalty-timer {
      color: #ef4444;
      font-weight: 600;
    }

    .penalty-warning-card {
      border: 2px solid #ef4444;
      background-color: #fef2f2;
      border-radius: 1rem;
      padding: 1rem;
      margin-top: 1rem;
      display: none;
    }
    .penalty-warning-title {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    .penalty-warning-title i {
      margin-right: 0.5rem;
    }
    .penalty-warning-list {
      list-style-type: none;
      padding: 0;
      margin: 0.5rem 0;
    }
    .penalty-warning-list li {
      padding: 0.25rem 0;
      color: #7f1d1d;
      font-size: 0.875rem;
      display: flex;
      align-items: flex-start;
    }
    .penalty-warning-list li i {
      margin-right: 0.5rem;
      color: #ef4444;
      margin-top: 0.25rem;
    }
    .details-link {
      color: #3b82f6;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: inline-block;
    }

    #instructionsPopup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1004;
      padding: 1rem;
    }
    #instructionsPopup.show {
      display: flex;
    }
    .instructions-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 32rem;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    .close-instructions {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
    }
    .instructions-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 1rem;
      text-align: center;
    }
    .instructions-list {
      margin-bottom: 1.5rem;
    }
    .instructions-item {
      margin-bottom: 1rem;
      padding-left: 1.5rem;
      position: relative;
    }
    .instructions-item-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    .instructions-item-desc {
      color: #4b5563;
      font-size: 0.9375rem;
    }
    .instructions-item::before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: var(--color-logo-green);
      font-weight: bold;
    }
    .instructions-close-btn {
      background-color: var(--color-logo-blue);
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s;
    }
    .instructions-close-btn:hover {
      background-color: #1e40af;
    }

    .app-info-card {
      border-top: 1px solid #e5e7eb;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    .app-info-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.75rem;
      text-align: center;
    }
    .app-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    .app-info-label {
      color: #6b7280;
    }
    .app-info-value {
      color: #374151;
      font-weight: 500;
    }
    .app-info-link {
      color: #3b82f6;
      text-decoration: none;
    }
    .app-info-link:hover {
      text-decoration: underline;
    }

    .btn-penalty {
      background: linear-gradient(to right, #ef4444, #dc2626) !important;
      color: white !important;
      cursor: not-allowed !important;
    }
    .btn-penalty:hover {
      transform: none !important;
    }
    
    /* ========== ADDED FEATURES ========== */
    
    .extra-earn-card {
        background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
        border: 3px solid #FFD700;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
        border-radius: 1.5rem;
        padding: 1.5rem;
        box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
    }
    .extra-earn-card::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
        animation: rotate 10s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .gift-icon {
        position: absolute;
        top: -10px;
        left: -10px;
        font-size: 4.5rem;
        color: rgba(255, 255, 255, 0.25);
        transform: rotate(-25deg);
        z-index: 1;
    }
    .extra-content { position: relative; z-index: 2; text-align: center; color: white; }
    .extra-earn-btn {
        background: white !important;
        color: #FF6B6B !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 2px solid #fff !important;
        margin-top: 10px;
    }

    #adOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        display: none;
        flex-direction: column;
    }
    .ad-header {
        height: 60px;
        background: #1a1a1a;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #333;
    }
    .ad-timer-text {
        font-size: 0.9rem;
        color: #fbbf24;
        font-weight: bold;
    }
    .close-ad-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid #555;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0.5;
        pointer-events: none;
        transition: 0.3s;
    }
    .close-ad-btn.active {
        background: #ef4444;
        border-color: #ef4444;
        opacity: 1;
        pointer-events: auto;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }
    .ad-content-area {
        flex: 1;
        background: #ffffff;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .ad-footer {
        height: 50px;
        background: rgba(0,0,0,0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 20px;
    }
    .ad-message {
        text-align: center;
        color: white;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .ad-progress-bg {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 3px;
        overflow: hidden;
    }
    .ad-progress-bar {
        height: 100%;
        width: 0%;
        background: #10b981;
        transition: width 1s linear;
    }
    
    .ad-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    .payment-field-group { margin-bottom: 1rem; }
    .payment-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
    .payment-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; }
    .validation-error { color: #ef4444; font-size: 0.75rem; display: none; }
    
    #dynamicPaymentEditModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1003;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    #dynamicPaymentEditModal.show {
        display: flex;
        opacity: 1;
    }
    #dynamicPaymentEditModal .modal-content {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        width: 90%;
        max-width: 28rem;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
    }
    #dynamicPaymentEditModal.show .modal-content {
        transform: translateY(0);
    }
    
    /* Payment Details Display */
    #dynamicPaymentDetailsDisplay p {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 0.5rem;
    }

    /* Extra Tasks Container */
    #extraTasksContainer {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    #noAdsMsg {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 2rem 0;
        display: none;
    }

    /* ========== NEW PROFILE STYLES ========== */
    .profile-page {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        padding: 1rem;
        background: linear-gradient(135deg, #e0e0e0 0%, #f8f9fa 100%);
    }

    /* Payment method grid for more than 2 methods */
    .payment-methods-grid {
        display: grid;
        gap: 1rem;
    }
    
    .payment-methods-grid.single-column {
        grid-template-columns: 1fr;
    }
    
    .payment-methods-grid.two-column {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .payment-methods-grid.multi-column {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    /* Custom animations for new profile */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease forwards;
    }

    /* Custom scrollbar for new profile */
    .profile-page::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    
    .profile-page::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .profile-page::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .profile-page::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Page transition */
    .page-transition {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    /* Color classes for new profile */
    .bg-logo-blue { background-color: var(--color-logo-blue) !important; }
    .text-logo-blue { color: var(--color-logo-blue) !important; }
    .border-logo-blue { border-color: var(--color-logo-blue) !important; }

    .bg-logo-green { background-color: var(--color-logo-green) !important; }
    .text-logo-green { color: var(--color-logo-green) !important; }
    .border-logo-green { border-color: var(--color-logo-green) !important; }

    .bg-logo-gold { background-color: var(--color-logo-gold) !important; }
    .text-logo-gold { color: var(--color-logo-gold) !important; }
    .border-logo-gold { border-color: var(--color-logo-gold) !important; }

    .bg-logo-orange { background-color: var(--color-logo-orange) !important; }
    .text-logo-orange { color: var(--color-logo-orange) !important; }

    .bg-gradient-logo {
        background: linear-gradient(to right, var(--color-logo-blue), var(--color-logo-green)) !important;
    }
    
    .bg-gradient-logo-secondary {
        background: linear-gradient(to bottom right, var(--color-logo-gold), var(--color-logo-orange)) !important;
    }

    /* ========== NEW WITHDRAW STYLES ========== */
    .balance-summary {
      background: var(--gradient-primary);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      box-shadow: var(--shadow-lg);
    }
    .balance-amount {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .withdrawal-card {
      background: white;
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      margin-bottom: 5rem; /* Spacing for bottom nav */
      box-shadow: var(--shadow-md);
    }
    .new-payment-methods-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .new-payment-method-card {
      border: 2px solid var(--color-light-gray);
      border-radius: var(--radius-lg);
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .new-payment-method-card:hover {
      border-color: var(--color-logo-blue);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .new-payment-method-card.selected {
      border-color: var(--color-logo-blue);
      background: rgba(42, 100, 178, 0.05);
    }
    .new-payment-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: var(--color-light);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.75rem;
      font-size: 1.5rem;
      color: var(--color-logo-blue);
    }
    .new-amount-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    .new-amount-option {
      padding: 0.375rem 0.75rem;
      background: var(--color-light);
      border: 1px solid var(--color-light-gray);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .new-amount-option:hover {
      background: var(--color-logo-blue);
      color: white;
      border-color: var(--color-logo-blue);
    }

    /* Modal Overlay (Generic) */
    .new-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }
    .new-modal-overlay.active { opacity: 1; visibility: visible; }
    .new-modal-content {
      background: white;
      border-radius: 1.25rem;
      padding: 2rem;
      width: 90%;
      max-width: 28rem;
      transform: translateY(20px);
      transition: transform 0.3s ease;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .new-modal-overlay.active .new-modal-content { transform: translateY(0); }

    /* Other Utility Classes */
    .checkmark-wrapper { width: 80px; height: 80px; margin: 0 auto 1.5rem; }
    .checkmark { width: 100%; height: 100%; border-radius: 50%; display: block; stroke-width: 5; stroke: var(--color-success); stroke-miterlimit: 10; box-shadow: inset 0 0 0 var(--color-success); animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both; }
    .checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 5; stroke-miterlimit: 10; stroke: var(--color-success); fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
    .checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill { 100% { box-shadow: inset 0 0 0 100px rgba(16, 185, 129, 0.1); } }

    /* Specific Ad/Notification Styles (Kept from original) */
    #androidTopNotification { position: fixed; top: 7rem; left: 50%; transform: translateY(-100%) translateX(-50%); width: 90%; max-width: 28rem; background: #1f2937; color: white; padding: 0.75rem 1rem; border-radius: 1rem; text-align: center; z-index: 9999; opacity: 0; transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    #androidTopNotification.show { transform: translateY(0) translateX(-50%); opacity: 1; }
    
    .ad-header { height: 60px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #333; }
    .close-ad-btn { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
    .close-ad-btn.active { background: #ef4444; border-color: #ef4444; opacity: 1; pointer-events: auto; box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
</style>
</head>
<body class="flex flex-col min-h-screen" oncontextmenu="return false;">

  <!-- Maintenance Mode Popup -->
  <div id="maintenancePopup" style="display: none;">
    <div class="maintenance-content">
      <div class="maintenance-icon">
        <i class="fas fa-tools"></i>
      </div>
      <h2 class="maintenance-title">Under Maintenance</h2>
      <p class="maintenance-message">
        The app is currently undergoing maintenance to improve your experience. 
        We'll be back online as soon as possible.
      </p>
      <p class="maintenance-time" id="maintenanceTime">
        Maintenance started: Just now
      </p>
      <button id="refreshMaintenanceBtn" class="maintenance-btn">
        <i class="fas fa-sync-alt mr-2"></i> Refresh Page
      </button>
    </div>
  </div>
  
  <!-- Ad Overlay for Extra Earnings -->
  <div id="adOverlay" style="display: none;">
    <div class="ad-header">
        <div class="flex items-center gap-2">
            <div style="width: 20px; height: 20px; border: 2px solid #fbbf24; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite;" id="timerSpinner"></div>
            <div id="adHeaderTimer" class="font-bold text-yellow-400 text-sm">Wait: 15s</div>
        </div>
        <button id="closeAdBtn" class="close-ad-btn"><i class="fas fa-times"></i></button>
    </div>
    
    <div id="adContainer" class="ad-content-area">
        <!-- Ad will be injected here -->
    </div>
    
    <div class="bg-gray-900 p-4 border-t border-gray-800">
        <div id="adFooterMessage" class="text-center text-white text-sm mb-2 font-medium">Stay on this page to earn double!</div>
        <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
            <div id="adProgressBar" class="h-full bg-gradient-to-r from-green-500 to-green-400 w-0 transition-all duration-1000 ease-linear"></div>
        </div>
    </div>
  </div>

  <!-- Firebase Loading Indicator -->
  <div class="firebase-loading" id="firebaseLoading">
    <div class="firebase-loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Telegram Warning Popup -->
  <div id="telegramWarningPopup" style="display: none;">
    <div class="telegram-warning-content">
      <div class="telegram-warning-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h2 class="telegram-warning-title">User Not Found</h2>
      <p class="telegram-warning-message">
        Telegram user not detected. Please go to the bot and press or type /start to run the bot properly. 
        Otherwise, your progress will not be saved. Close this mini app and launch it from the bot.
      </p>
      <div class="telegram-warning-buttons">
        <button id="telegramWarningOk" class="telegram-warning-btn telegram-warning-btn-ok">OK, Continue</button>
        <button id="telegramWarningGo" class="telegram-warning-btn telegram-warning-btn-go">Go to Bot</button>
      </div>
    </div>
  </div>

  <!-- Instructions Popup -->
  <div id="instructionsPopup" class="fixed inset-0 bg-black bg-opacity-60 z-[11000] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md h-[85vh] flex flex-col shadow-2xl transform transition-all relative">
        
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                <i class="fas fa-book-open text-blue-500"></i> App Guide
            </h3>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-4">
            
            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-eye text-green-500"></i> Ad Watching Rules
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Watch ads for the full <span id="instructionAdDuration" class="font-bold text-gray-900">15</span> seconds. Closing early results in penalties and no reward.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-coins text-yellow-500"></i> Earning System
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Each task earns you <span id="instructionEarningsPerAd" class="font-bold text-gray-900">0.05</span> BDT. Complete daily tasks to maximize income.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-ban text-red-500"></i> Penalty System
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Early closing blocks the ad button for <span id="instructionPenaltyDuration" class="font-bold text-gray-900">2</span> minutes. Repeated issues may freeze your account.
                </div>
            </div>
            
            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-wallet text-purple-500"></i> Withdrawal
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Minimum withdrawal is <span id="instructionMinWithdrawal" class="font-bold text-gray-900">100</span> BDT. Setup payment info in Profile first.
                </div>
            </div>

            <div class="instructions-item">
                <div class="font-bold text-gray-800 mb-1 flex items-center gap-2">
                    <i class="fas fa-headset text-blue-400"></i> Support
                </div>
                <div class="text-gray-600 text-sm leading-relaxed pl-6">
                    Questions? Contact us via the official Telegram bot or group.
                </div>
            </div>

        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
            <button onclick="hideInstructionsPopup()" class="w-full py-3.5 bg-white border border-gray-300 text-gray-700 font-bold text-lg rounded-xl shadow-sm hover:bg-gray-100 active:scale-95 transition-all">
                Close Guide
            </button>
        </div>

    </div>
</div>
  
  <!-- Dynamic Payment Edit Modal -->
  <div id="dynamicPaymentEditModal" style="display: none;">
    <div class="modal-content">
      <button id="closeDynamicPaymentModal" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
      <h2 class="text-2xl font-bold text-gray-800 mb-5 text-center">Edit Payment Information</h2>
      
      <div id="dynamicPaymentForm" class="space-y-4">
        <!-- Dynamic payment fields will be inserted here -->
      </div>
      
      <button id="saveDynamicPaymentBtn" class="btn-primary w-full mt-8 py-3">
        Save Payment Information
      </button>
    </div>
  </div>

  <!-- New Success Modal for Withdraw Section -->
  <div class="new-modal-overlay" id="new-successModal">
    <div class="new-modal-content text-center">
      <div class="checkmark-wrapper">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>
      <h2 class="text-xl font-bold text-gray-800 mb-2">Request Submitted!</h2>
      <p class="text-gray-500 mb-6" id="new-successMessage">Your withdrawal is being processed.</p>
      <button class="btn-primary w-full" onclick="document.getElementById('new-successModal').classList.remove('active')">Done</button>
    </div>
  </div>

  <!-- New Dynamic Payment Edit Modal for Withdraw Section -->
  <div id="new-dynamicPaymentEditModal" class="new-modal-overlay">
    <div class="new-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">Edit Payment Info</h2>
        <button id="new-closeDynamicPaymentModal" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
      </div>
      <div id="new-dynamicPaymentForm" class="space-y-4">
        <!-- Dynamic payment fields will be inserted here -->
      </div>
      <button id="new-saveDynamicPaymentBtn" class="btn-primary w-full mt-6">Save Information</button>
    </div>
  </div>

  <!-- Notification Banner -->
  <div id="androidTopNotification" class="fixed top-0 left-1/2 transform -translate-x-1/2 mt-2 w-11/12 max-w-md bg-gray-800 text-white text-sm font-medium text-center px-4 py-3 rounded-xl shadow-lg z-[9999]">
    <!-- Notification message appears here -->
  </div>

  <!-- Telegram Connection Indicator -->
  <div class="telegram-connected" id="telegramConnected">
    <i class="fab fa-telegram mr-2"></i>Connected to Telegram
  </div>

  <!-- Success Popup -->
  <div id="successPopup" class="fixed inset-0 flex items-center justify-center z-[1002] hidden">
    <div class="bg-white p-8 rounded-2xl text-center max-w-xs mx-auto">
      <div class="checkmark-wrapper">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-800">Success!</h3>
      <p id="successMessage" class="text-gray-600 mt-2">Operation completed successfully</p>
    </div>
  </div>

  <!-- Header -->
  <header class="fixed-top-header p-4 flex items-center justify-between shadow-lg rounded-b-xl">
    <div class="flex items-center space-x-3">
      <div class="relative">
        <div id="headerProfileImage" class="profile-header-placeholder">
          <i class="fas fa-user"></i>
        </div>
        <div class="telegram-indicator" id="telegramIndicator" style="display: none;">
          <i class="fab fa-telegram"></i>
        </div>
      </div>
      <div class="flex flex-col">
        <span id="header-username" class="text-gray-800 text-base font-medium">@User</span>
        <span id="header-balance" class="text-gray-600 text-sm opacity-90">BDT 0.00</span>
      </div>
    </div>
    <div class="text-gray-800 font-semibold text-lg flex items-center">
      AdVault
      <span id="country-flag" class="country-flag"></span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow p-4 pt-20 pb-20 space-y-6 container mx-auto">
    <!-- Home Section -->
    <div id="home-section" class="section active">
      <div class="content-card mb-6 overflow-hidden">
        <div id="marqueeContainer" class="bg-yellow-50 p-4 rounded-t-2xl">
          <div id="marqueeText" class="text-sm font-semibold text-yellow-800">
            ðŸ””  AdVault $ Bot Made by Fahim  ðŸ”” 
          </div>
        </div>
        <div class="banner-img">AdVault ðŸ’¸ Earnings</div>
      </div>

      <div class="content-card mb-6 text-center">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome to AdVault</h2>
        <p class="text-gray-600 mb-6">Start maximizing your ad revenue today!</p>
        <button id="earnNowBtn" class="btn-primary py-3 px-8 w-full">
          <i class="fas fa-play-circle mr-2"></i> Start Earning
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="content-card bg-gradient-to-br from-purple-600 to-indigo-700 text-white">
          <div class="flex items-center space-x-4">
            <div class="bg-white p-3 rounded-full text-purple-700 shadow-md">
              <i class="fas fa-dollar-sign text-2xl"></i>
            </div>
            <div>
              <p class="text-3xl font-bold" id="home-earnings-val">BDT 0.00</p>
              <p class="text-sm opacity-90">Total Earnings</p>
            </div>
          </div>
        </div>

        <div class="content-card bg-gradient-to-br from-gray-800 to-gray-900 text-white">
          <div class="flex items-center space-x-4">
            <div class="bg-white p-3 rounded-full text-gray-800 shadow-md">
              <i class="fas fa-eye text-2xl"></i>
            </div>
            <div>
              <p class="text-3xl font-bold" id="home-ads-val">0</p>
              <p class="text-sm opacity-90">Ads Watched</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Earn Section -->
    <div id="earn-section" class="section">
      <h1 class="text-center text-3xl font-bold text-gray-800 mb-6">Earn Rewards</h1>
      <div class="content-card mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Today's Tasks Progress</h2>
        <div class="flex justify-between items-center text-gray-600 mb-4">
          <p>Total Tasks: <span class="font-medium text-gray-800" id="earn-total">1000</span></p>
          <div>
          <p>Completed: <span class="font-medium text-purple-600" id="earn-completed">0</span></p>
          <p>Remaining: <span class="font-medium text-red-500" id="earn-remaining">1000</span></p>
       </div> </div>
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
          <div id="earn-progress-bar" class="h-full rounded-full bg-purple-600" style="width: 0%;"></div>
        </div>
        
        <!-- Earnings per ad display -->
        <div class="text-center mb-4 p-2 bg-blue-50 rounded-lg">
          <p class="text-sm text-gray-700">
            Earnings per ad: <span class="font-bold text-blue-700" id="earningsPerAdDisplay">0.05</span> BDT
          </p>
          <p class="text-xs text-gray-500 mt-1">
            Each ad requires <span id="adDurationDisplay">15</span> seconds to complete
          </p>
        </div>
        
        <button id="startEarningAd" class="btn-primary py-3 px-6 w-full">
          <span id="adButtonText">Start Ad Task</span>
        </button>
        
        <!-- Penalty warning card -->
        <div id="penaltyWarningCard" class="penalty-warning-card">
          <div class="penalty-warning-title">
            <i class="fas fa-exclamation-triangle"></i>
            Warning: Ad Closed Too Early
          </div>
          <ul class="penalty-warning-list">
            <li><i class="fas fa-ban"></i> Do not close ads before the time over (<span id="penaltyAdDuration">15</span> seconds)</li>
            <li><i class="fas fa-user-slash"></i> Quick closes harm your account reputation</li>
            <li><i class="fas fa-money-bill-wave"></i> You will not get paid for quick closes</li>
            <li><i class="fas fa-clock"></i> Button blocked for <span id="penaltyDurationDisplay">2</span> minutes as penalty</li>
          </ul>
          <span class="details-link" id="showInstructions">Details &gt;&gt;</span>
        </div>
      </div>
      
      <!-- Extra Tasks Container -->
      <div id="extraTasksContainer" class="space-y-4 mb-6">
        <!-- Dynamic extra ad cards will be inserted here -->
      </div>
      
      <div id="noAdsMsg" class="hidden text-center text-gray-400 text-sm py-4">
          No extra tasks available right now.
      </div>

      <div class="content-card mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Refer & Earn More</h2>
        <p class="text-gray-600 mb-6">Invite your friends and earn bonuses!</p>
        <div class="text-gray-600 mb-6">
          <p>Your Referral Link: <span class="text-blue-500 break-all">Coming Soon</span></p>
          <p class="mt-2">Total Referrals: <span class="font-medium text-gray-800">0</span></p>
        </div>
        <button id="inviteFriendsBtn" class="bg-yellow-400 text-gray-800 py-3 px-6 w-full rounded-full font-semibold">
          Share Invite Link
        </button>
      </div>
    </div>

    <!-- NEW Withdraw Section (Replaced with improved UI) -->
    <div id="withdraw-section" class="section section-fullscreen">
        <!-- Fixed: Added proper back button to return to profile section -->
        <button onclick="showSection('profile-section')" class="absolute top-4 left-4 w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm hover:text-blue-600 transition-all z-10">
            <i class="fas fa-arrow-left"></i>
        </button>
        
        <div class="pt-4 pb-4">
            <h1 class="text-2xl font-bold text-gray-800 text-center mb-2">Withdraw Funds</h1>
            <p class="text-sm text-gray-500 text-center">Cash out your earnings</p>
        </div>

        <div class="balance-summary fade-in">
            <div class="flex items-center gap-2 text-sm opacity-90 mb-2">
                <i class="fas fa-wallet"></i> Available Balance
            </div>
            
            <div class="balance-amount" id="new-withdraw-balance-display">BDT 0.00</div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="block opacity-80">Total Earnings</span>
                    <span class="font-bold" id="new-withdraw-total-earn">BDT 0.00</span>
                </div>
                <div>
                    <span class="block opacity-80">Already Withdrawn</span>
                    <span class="font-bold" id="new-withdraw-total-out">BDT 0.00</span>
                </div>
            </div>
        </div>

        <div class="withdrawal-card fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-money-bill-wave text-blue-600"></i> Request Payout
                </h2>
                <button id="new-toggleHistoryBtn" class="text-blue-600 text-sm font-medium hover:underline">
                    <i class="fas fa-history"></i> History
                </button>
            </div>

            <div id="new-withdrawInputs">
                <form id="new-withdrawForm">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Payment Method</label>
                        <div class="new-payment-methods-grid" id="new-paymentGrid">
                            <!-- Payment methods will be inserted here -->
                        </div>
                        <p id="new-methodError" class="text-red-500 text-xs mt-1 hidden">Please select a payment method</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Withdrawal Amount</label>
                        <div class="relative mb-2">
                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 font-bold text-gray-500">BDT</span>
                            <input type="number" id="new-amountInput" class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 transition-colors" placeholder="0.00" min="100" step="0.01">
                        </div>
                        <div class="new-amount-options">
                            <button type="button" class="new-amount-option" data-amt="100">100</button>
                            <button type="button" class="new-amount-option" data-amt="200">200</button>
                            <button type="button" class="new-amount-option" data-amt="500">500</button>
                            <button type="button" class="new-amount-option" id="new-maxAmountBtn">MAX</button>
                        </div>
                        <p id="new-amountError" class="text-red-500 text-xs mt-1 hidden">Invalid amount</p>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl mb-6">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-500">Processing Fee (2%)</span>
                            <span class="font-medium text-gray-700" id="new-feeDisplay">0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-gray-800 pt-2 border-t border-gray-200">
                            <span>You Receive</span>
                            <span class="text-blue-600" id="new-netAmountDisplay">BDT 0.00</span>
                        </div>
                    </div>

                    <div id="new-selectedMethodDetails" class="mb-6 p-3 bg-blue-50 rounded-lg text-sm text-blue-800 hidden">
                        <div class="flex justify-between items-center">
                            <span>Sending to: <strong id="new-sendToPreview">...</strong></span>
                            <button type="button" id="new-editPaymentFromWithdraw" class="text-xs bg-white px-2 py-1 rounded border border-blue-200">Edit</button>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary w-full py-4 text-lg shadow-lg">
                        Submit Request <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </form>
            </div>

            <div id="new-withdrawHistoryView" class="hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase">
                            <th class="py-2">Date</th>
                            <th class="py-2">Method</th>
                            <th class="py-2">Amount</th>
                            <th class="py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody id="new-historyTableBody" class="text-sm">
                        <!-- History will be inserted here -->
                    </tbody>
                </table>
                <button id="new-backToWithdrawInput" class="mt-4 text-gray-500 text-sm underline w-full text-center">Back to Request</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal History Section -->
    <div id="withdrawal-history-section" class="section section-fullscreen">
      <!-- Fixed: Changed back button to go to profile section instead of withdraw section -->
      <button class="absolute top-4 left-4 w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-600 shadow-sm hover:text-blue-600 transition-all z-10" onclick="showSection('profile-section')">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-center text-3xl font-bold text-gray-800 mb-6">Withdrawal History</h1>
      
      <div class="withdrawal-history-container">
        <table class="withdrawal-history-table">
          <thead>
            <tr>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="withdrawal-history-body">
            <tr>
              <td colspan="4" class="text-center py-4 text-gray-500">Loading your withdrawal history...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile-section" class="section section-fullscreen">
      <div class="profile-page">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Profile Dashboard</h1>
            <p class="text-sm text-gray-500 mt-1">Manage your account and earnings</p>
          </div>
          <div class="flex gap-3">
           <button class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-logo-blue hover:border-logo-blue hover:shadow-md transition-all duration-200 relative z-20" onclick="openNotificationsModal()">
        <i class="fas fa-bell"></i>
        <span id="notificationDot" class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full hidden"></span>
    </button>

<div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 z-[11000] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md h-[80vh] flex flex-col shadow-2xl transform transition-all relative">
        
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
            <h3 class="font-bold text-gray-800 text-lg">Notifications</h3>
            </div>

        <div id="notificationList" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="text-center text-gray-400 mt-10">
                <i class="fas fa-spinner fa-spin text-2xl"></i>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
            <button 
                type="button" 
                onclick="window.closeNotificationsModal()" 
                class="w-full py-3.5 bg-white border border-gray-300 text-gray-700 font-bold text-lg rounded-xl shadow-sm hover:bg-gray-50 active:scale-95 transition-all"
            >
                Close
            </button>
        </div>

    </div>
</div>
           <button class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-blue-500 hover:border-blue-500 hover:shadow-md transition-all duration-200 relative z-20" onclick="showInstructionsPopup()">
    <i class="fas fa-info-circle text-xl"></i>
</button>
          </div>
        </div>

        <!-- Profile Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-fade-in">
          <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
            <!-- Avatar -->
            <div class="relative">
              <div id="profileImageContainer" class="w-20 h-20 rounded-full bg-gradient-to-br from-logo-blue to-logo-green flex items-center justify-center text-white text-3xl shadow-lg">
                <!-- Profile image will be inserted here -->
              </div>
              <div class="absolute -inset-1 rounded-full bg-gradient-to-br from-logo-blue to-logo-green opacity-20 -z-10"></div>
            </div>
            
            <!-- Info -->
            <div class="flex-1 text-center md:text-left">
              <h2 class="text-xl font-bold text-gray-800 mb-1" id="profileName">John Doe</h2>
              <div class="flex items-center justify-center md:justify-start gap-2 text-gray-500 text-sm mb-3">
                <i class="fas fa-check-circle text-logo-green"></i>
                <span id="profileUsername">@johndoe</span>
              </div>
              
              <!-- Stats -->
              <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                <span class="inline-flex items-center gap-1 bg-gray-50 text-gray-600 text-xs px-3 py-1 rounded-full">
                  <i class="fas fa-id-card text-gray-400"></i>
                  <span id="profileId">USR123456</span>
                </span>
                <span class="inline-flex items-center gap-1 bg-gray-50 text-gray-600 text-xs px-3 py-1 rounded-full">
                  <i class="fab fa-telegram text-gray-400"></i>
                  <span id="profileSource">Telegram</span>
                </span>
                <span class="inline-flex items-center gap-1 bg-gray-50 text-gray-600 text-xs px-3 py-1 rounded-full">
                  <i class="fas fa-calendar-alt text-gray-400"></i>
                  <span id="profileJoinDate">Joined: Loading...</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Balance Card -->
        <div class="bg-gradient-logo rounded-2xl shadow-xl p-6 mb-6 text-white animate-fade-in">
          <div class="flex justify-between items-center mb-4">
            <span class="text-sm opacity-90">Available Balance</span>
            <button class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/30 transition-colors" id="refreshBalance" title="Refresh" onclick="updateUI()">
              <i class="fas fa-redo"></i>
            </button>
          </div>
          <div class="text-3xl md:text-4xl font-bold mb-6" id="profileBalance">BDT 0.00</div>
          <div class="flex flex-col sm:flex-row gap-3">
            <button class="bg-white text-logo-blue font-semibold py-3 px-6 rounded-full flex items-center justify-center gap-2 hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200" onclick="showSection('withdraw-section')">
              <i class="fas fa-wallet"></i>
              Withdraw Funds
            </button>
            <button class="bg-white/10 text-white font-semibold py-3 px-6 rounded-full border border-white/30 flex items-center justify-center gap-2 hover:bg-white/20 transition-all duration-200" onclick="showSection('withdrawal-history-section'); fetchWithdrawalHistory();">
              <i class="fas fa-history"></i>
              Transaction History
            </button>
          </div>
        </div>

       <!-- Stats Grid - Compact 2x2 Layout -->
<div class="grid grid-cols-2 gap-3 mb-6 animate-fade-in">
  <!-- Earnings Card -->
  <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow duration-200 border border-gray-100">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
        <i class="fas fa-dollar-sign text-sm"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold text-gray-800" id="profileEarnings">BDT 0.00</div>
        <div class="text-xs text-gray-500">Earnings</div>
      </div>
    </div>
  </div>
  
  <!-- Ads Card -->
  <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow duration-200 border border-gray-100">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
        <i class="fas fa-tv text-sm"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold text-gray-800" id="profileAds">0</div>
        <div class="text-xs text-gray-500">Ads Watched</div>
      </div>
    </div>
  </div>
  
  <!-- Referrals Card -->
  <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow duration-200 border border-gray-100">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
        <i class="fas fa-share-alt text-sm"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold text-gray-800" id="profileReferrals">0</div>
        <div class="text-xs text-gray-500">Referrals</div>
      </div>
    </div>
  </div>
  
  <!-- Withdrawn Card -->
  <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow duration-200 border border-gray-100">
    <div class="flex items-center space-x-3">
      <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
        <i class="fas fa-money-check-alt text-sm"></i>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold text-gray-800" id="profileWithdrawn">BDT 0.00</div>
        <div class="text-xs text-gray-500">Withdrawn</div>
      </div>
    </div>
  </div>
</div>

        <!-- Payment Methods -->
        <div class="bg-white rounded-2xl shadow-md p-6 mb-6 animate-fade-in">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
              <i class="fas fa-credit-card text-logo-blue"></i>
              Payment Methods
            </h3>
            <button class="text-sm font-semibold bg-logo-blue text-white py-2 px-4 rounded-full flex items-center gap-2 hover:bg-logo-green transition-colors" id="editDynamicPaymentBtn">
              <i class="fas fa-edit"></i>
              Edit
            </button>
          </div>
          
          <div class="space-y-4" id="profilePaymentMethodsContainer">
            <!-- Dynamic payment methods will be inserted here -->
            <div class="text-center py-4 text-gray-400">
              <i class="fas fa-credit-card text-3xl mb-2"></i>
              <p>Loading payment methods...</p>
            </div>
          </div>
        </div>

        <!-- App Info -->
        <div class="bg-white rounded-2xl shadow-md p-6 animate-fade-in">
          <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-6">
            <i class="fas fa-info-circle text-logo-blue"></i>
            App Information
          </h3>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">App Name</div>
              <div class="font-medium text-gray-800">AdVault Earnings</div>
            </div>
            
             <div class="p-3 bg-gray-50 rounded-lg">
  <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Version</div>
  <div class="font-medium text-gray-800" id="displayVersion">Loading...</div>
</div>
            
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Official Group</div>
              <a href="https://t.me/AdVault_Group" target="_blank" class="font-medium text-logo-blue hover:text-logo-green transition-colors">
                @AdVault_Group
              </a>
            </div>
            
            <div class="p-3 bg-gray-50 rounded-lg">
              <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Developer</div>
              <a href="https://t.me/Monetag_SupportBot" target="_blank" class="font-medium text-logo-blue hover:text-logo-green transition-colors">
                MT Support
              </a>
            </div>
            

<div class="p-3 bg-gray-50 rounded-lg">
  <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Build Number</div>
  <div class="font-medium text-gray-800" id="displayBuildNumber">Loading...</div>
</div>
            
           <div class="p-3 bg-gray-50 rounded-lg">
  <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Last Updated</div>
  <div class="font-medium text-gray-800" id="appLastUpdated">Loading...</div>
</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Original Edit Payment Information Modal -->
    <div id="editModal" style="display: none;">
      <div class="modal-content">
        <button id="closeEditModal" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
        <h2 class="text-2xl font-bold text-gray-800 mb-5 text-center">Edit Payment Information</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-1">PayPal Email</label>
            <input id="editPaypal" type="email" placeholder="e.g. paypal@example.com" class="w-full p-3 border border-gray-300 rounded-lg">
            <div id="paypalError" class="validation-error">Please enter a valid PayPal email</div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1">Payoneer Email</label>
            <input id="editPayoneer" type="email" placeholder="e.g. payoneer@example.com" class="w-full p-3 border border-gray-300 rounded-lg">
            <div id="payoneerError" class="validation-error">Please enter a valid Payoneer email</div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1">bKash Number</label>
            <div class="flex border border-gray-300 rounded-lg">
              <span class="inline-flex items-center px-3 rounded-l-lg bg-gray-100 text-gray-600 text-sm">+88</span>
              <input id="editBkash" type="text" placeholder="01XXXXXXXXX" maxlength="11"
                     class="w-full p-3 rounded-r-lg text-gray-700">
            </div>
            <div id="bkashError" class="validation-error">Please enter a valid bKash number (e.g. 017XXXXXXXX or +88017XXXXXXXX)</div>
          </div>
        </div>

        <button id="saveProfileBtn" class="btn-primary w-full mt-8 py-3">
          Save Payment Information
        </button>
      </div>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav class="fixed-bottom-nav p-3 rounded-t-3xl shadow-2xl">
    <ul class="flex justify-around items-center h-full">
      <li class="nav-item flex flex-col items-center text-center text-xs font-medium active" data-target="home-section">
        <i class="fas fa-home text-xl mb-1"></i><span>Home</span>
      </li>
      <li class="nav-item flex flex-col items-center text-center text-xs font-medium" data-target="earn-section">
        <i class="fas fa-coins text-xl mb-1"></i><span>Earn</span>
      </li>
      <li class="nav-item flex flex-col items-center text-center text-xs font-medium" data-target="profile-section">
        <i class="fas fa-user-circle text-xl mb-1"></i><span>Profile</span>
      </li>
    </ul>
  </nav>

<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB3HVFRch3p3fXpK2oAMbONg9NLoKssnqk",
        authDomain: "adbot-s1.firebaseapp.com",
        projectId: "adbot-s1",
        storageBucket: "adbot-s1.firebasestorage.app",
        messagingSenderId: "24458241388",
        appId: "1:24458241388:web:c6e8a8a742508cc0a1bf49"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Collection names
    const USERS_COLLECTION = "adv2_users";
    const WITHDRAWALS_COLLECTION = "adv2_withdrawals";
    const ADMIN_SETTINGS_DOC_ID = "_admin_settings_";
    
    // User data
    let userData = {
        id: "",
        name: "",
        username: "",
        balance: 0.00,
        totalEarnings: 0.00,
        adsWatched: 0,
        completedTasks: 0,
        totalTasks: 1000,
        paypal: "",
        payoneer: "",
        bkash: "",
        lastResetDate: new Date().toISOString().slice(0, 10),
        telegramDetected: false,
        source: "web",
        profilePhoto: null,
        totalWithdrawn: 0.00,
        withdrawalCount: 0,
        referrals: 0,
        joinDate: new Date().toISOString(),
        lastNotificationCheck: new Date(0).toISOString(),
        paymentInfo: {} // For dynamic payment methods
    };

    // Admin settings with extended features
    let adminSettings = {
        // Original settings
        maintenanceMode: false,
        autoApprove: false,
        enablePenalty: true,
        minWithdrawal: 100,
        earningsPerAd: 0.05,
        dailyTasks: 1000,
        adDuration: 15,
        penaltyDuration: 2,
        lastUpdated: new Date().toISOString(),
        
        // Added features
        paymentMethods: [], // [{id, name, type}]
        marqueeSettings: { default: "Welcome to AdVault!" },
        adServices: [],
        popunder: { code: '', active: false },
        socialBar: { code: '', active: false } // [{id, type, name, code, active, reward}]
    };

    // App state
    let userCountry = "BD";
    let penaltyActive = false;
    let penaltyEndTime = 0;
    let penaltyInterval = null;
    let adStartTime = 0;
    let adTimerInterval = null;
    let maintenanceMode = false;
    let maintenanceStartTime = null;
    let adInterval = null; // For extra ad popup
    
    // New Withdraw State
    let currentWithdrawMethod = null;

    // ===================== FIREBASE FUNCTIONS =====================
    
    async function saveUserData() {
        try {
            userData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
            const userId = userData.id || userData.username;
            await db.collection(USERS_COLLECTION).doc(userId).set(userData, { merge: true });
            console.log("User data saved to Firestore");
            return true;
        } catch (error) {
            console.error("Error saving user data:", error);
            showTopNotification("Failed to save data. Please try again.");
            return false;
        }
    }
    
    async function loadUserData(userId) {
        try {
            const doc = await db.collection(USERS_COLLECTION).doc(userId).get();
            
            if (doc.exists) {
                // 1. Load existing data
                const data = doc.data();
                userData = { ...userData, ...data };

                // Apply Admin Limits
                userData.totalTasks = adminSettings.dailyTasks || 1000;
                
                // Ensure objects exist
                if (!userData.paymentInfo) userData.paymentInfo = {};
                if (!userData.referrals) userData.referrals = 0;
                if (!userData.totalWithdrawn) userData.totalWithdrawn = 0;
                
                // --- FIX START: COLLECT MISSING DATES ---
                
                let updates = {};
                
                updates.lastUpdated = new Date().toISOString(); 
    
    // Backfill join date if missing
    if (!userData.joinDate) {
        userData.joinDate = new Date().toISOString();
        updates.joinDate = userData.joinDate;
    }

    db.collection(USERS_COLLECTION).doc(userId).set(updates, { merge: true });
                
                // --- FIX END ---

                console.log("User data loaded and status updated");
                return true;
            } else {
                // 2. New User Setup
                userData.id = userId;
                userData.totalTasks = adminSettings.dailyTasks || 1000;
                userData.paymentInfo = {};
                
                // Set Creation Date for new user
                userData.joinDate = new Date().toISOString();
                
                console.log("Creating new user in Firestore");
                await saveUserData(); // This function already saves serverTimestamp
                return false;
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            showTopNotification("Failed to load data. Please try again.");
            return false;
        } finally {
            document.getElementById("firebaseLoading").style.display = "none";
        }
    }
    
    async function loadAdminSettings() {
        try {
            const doc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
            if (doc.exists) {
                const data = doc.data();
                adminSettings = { ...adminSettings, ...data };
                
                // Update maintenance mode
                maintenanceMode = adminSettings.maintenanceMode || false;
                if (maintenanceMode) {
                    maintenanceStartTime = adminSettings.lastUpdated || new Date().toISOString();
                    showMaintenancePopup();
                }
                
                console.log("Admin settings loaded:", adminSettings);
                
                // Apply admin settings to UI
                applyAdminSettings();
                
                return true;
            } else {
                console.log("No admin settings found, using defaults.");
                return false;
            }
        } catch (error) {
            console.error("Error loading admin settings:", error);
            return false;
        }
    }
    
    function setupAdminSettingsListener() {
        db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID)
            .onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    adminSettings = { ...adminSettings, ...data };
                    
                    console.log("Admin settings updated in real-time:", adminSettings);
                    
                    // Update maintenance mode
                    const wasInMaintenance = maintenanceMode;
                    maintenanceMode = adminSettings.maintenanceMode || false;
                    
                    if (maintenanceMode && !wasInMaintenance) {
                        maintenanceStartTime = adminSettings.lastUpdated || new Date().toISOString();
                        showMaintenancePopup();
                    } else if (!maintenanceMode && wasInMaintenance) {
                        hideMaintenancePopup();
                    }
                    
                    // Apply updated settings
                    applyAdminSettings();
                    
                    if (userData.telegramDetected) {
                        showTopNotification("App settings have been updated", 3000);
                    }
                }
            }, (error) => {
                console.error("Error listening to admin settings:", error);
            });
    }

    // Function to inject Popunder & Social Bar scripts safely
    function injectPassiveAds() {
        // 1. Handle Popunder
        if (adminSettings.popunder && adminSettings.popunder.active && adminSettings.popunder.code) {
            if (!document.getElementById('ad-script-popunder')) {
                console.log("Injecting Popunder...");
                const div = document.createElement('div');
                div.id = 'ad-script-popunder';
                div.style.display = 'none';
                document.body.appendChild(div);

                const range = document.createRange();
                range.selectNode(document.body);
                const fragment = range.createContextualFragment(adminSettings.popunder.code);
                div.appendChild(fragment);
            }
        }

        // 2. Handle Social Bar
        if (adminSettings.socialBar && adminSettings.socialBar.active && adminSettings.socialBar.code) {
            if (!document.getElementById('ad-script-socialbar')) {
                console.log("Injecting Social Bar...");
                const div = document.createElement('div');
                div.id = 'ad-script-socialbar';
                div.style.display = 'none';
                document.body.appendChild(div);

                const range = document.createRange();
                range.selectNode(document.body);
                const fragment = range.createContextualFragment(adminSettings.socialBar.code);
                div.appendChild(fragment);
            }
        }
    }
    
    function applyAdminSettings() {
        userData.totalTasks = adminSettings.dailyTasks || 1000;
        
        if (document.getElementById('earn-total')) {
            document.getElementById('earn-total').textContent = adminSettings.dailyTasks || 1000;
        }
        
        if (document.getElementById('earningsPerAdDisplay')) {
            document.getElementById('earningsPerAdDisplay').textContent = (adminSettings.earningsPerAd || 0.05).toFixed(2);
        }
        
        if (document.getElementById('adDurationDisplay')) {
            document.getElementById('adDurationDisplay').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('penaltyAdDuration')) {
            document.getElementById('penaltyAdDuration').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('penaltyDurationDisplay')) {
            document.getElementById('penaltyDurationDisplay').textContent = adminSettings.penaltyDuration || 2;
        }
        
        if (document.getElementById('new-amountInput')) {
            document.getElementById('new-amountInput').min = adminSettings.minWithdrawal || 100;
            document.getElementById('new-amountInput').placeholder = `Min ${adminSettings.minWithdrawal || 100} BDT`;
        }
        
        // Update instructions popup
        if (document.getElementById('instructionAdDuration')) {
            document.getElementById('instructionAdDuration').textContent = adminSettings.adDuration || 15;
        }
        
        if (document.getElementById('instructionEarningsPerAd')) {
            document.getElementById('instructionEarningsPerAd').textContent = (adminSettings.earningsPerAd || 0.05).toFixed(2);
        }
        
        if (document.getElementById('instructionPenaltyDuration')) {
            document.getElementById('instructionPenaltyDuration').textContent = adminSettings.penaltyDuration || 2;
        }
        
        if (document.getElementById('instructionMinWithdrawal')) {
            document.getElementById('instructionMinWithdrawal').textContent = adminSettings.minWithdrawal || 100;
        }

        // System Info Updates
        if (document.getElementById('appLastUpdated')) {
            if (adminSettings.lastUpdated) {
                const dateObj = new Date(adminSettings.lastUpdated);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                document.getElementById('appLastUpdated').textContent = formattedDate;
            } else {
                document.getElementById('appLastUpdated').textContent = "Not Available";
            }
        }
        if (document.getElementById('displayVersion')) {
            document.getElementById('displayVersion').textContent = adminSettings.appVersion || '2.1.1';
        }
        
        if (document.getElementById('displayBuildNumber')) {
            document.getElementById('displayBuildNumber').textContent = adminSettings.buildNumber || 'AV20250902';
        }
   
        // Render dynamic features
        renderMarquee();
        renderDynamicPaymentUI();
        renderProfilePaymentMethods();
        renderNewPaymentGrid();
        
        // Inject Passive Ads (Popunder/Social Bar)
        injectPassiveAds();
        
        renderExtraAds();
        
        updateUI();
    }
    
    function showMaintenancePopup() {
        const popup = document.getElementById('maintenancePopup');
        if (popup) {
            if (maintenanceStartTime) {
                const time = new Date(maintenanceStartTime).toLocaleString();
                document.getElementById('maintenanceTime').textContent = `Maintenance started: ${time}`;
            }
            popup.style.display = 'flex';
            
            document.querySelectorAll('button, input, select').forEach(el => {
                if (el.id !== 'refreshMaintenanceBtn') {
                    el.disabled = true;
                }
            });
        }
    }
    
    function hideMaintenancePopup() {
        const popup = document.getElementById('maintenancePopup');
        if (popup) {
            popup.style.display = 'none';
            
            document.querySelectorAll('button, input, select').forEach(el => {
                el.disabled = false;
            });
            
            showTopNotification("App is back online!", 3000);
        }
    }
    
    async function saveWithdrawalRequest(amount, method, address) {
        try {
            const withdrawalData = {
                userId: userData.id || userData.username,
                username: userData.username,
                amount: amount,
                method: method,
                address: address,
                timestamp: new Date().toISOString(),
                status: "pending"
            };

            await db.collection(WITHDRAWALS_COLLECTION).add(withdrawalData);
            console.log("Withdrawal request saved successfully");
            return true;
        } catch (error) {
            console.error("Error saving withdrawal request:", error);
            return false;
        }
    }

    async function fetchWithdrawalHistory() {
        const userId = userData.id || userData.username;
        if (!userId) {
            document.getElementById("withdrawal-history-body").innerHTML = 
                '<tr><td colspan="4" class="text-center py-4 text-red-500">User not identified</td></tr>';
            return;
        }

        try {
            document.getElementById("withdrawal-history-body").innerHTML = 
                '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading your withdrawal history...</td></tr>';

            const querySnapshot = await db.collection(WITHDRAWALS_COLLECTION)
                .where("userId", "==", userId)
                .orderBy("timestamp", "desc")
                .get();

            const tbody = document.getElementById("withdrawal-history-body");
            tbody.innerHTML = "";

            if (querySnapshot.empty) {
                tbody.innerHTML = 
                    '<tr><td colspan="4" class="text-center py-4 text-gray-500">No withdrawal history found</td></tr>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const date = new Date(data.timestamp).toLocaleDateString();
                
                let statusClass = "status-pending";
                if (data.status === "completed") statusClass = "status-approved";
                if (data.status === "rejected") statusClass = "status-rejected";
                
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="font-medium">BDT ${data.amount?.toFixed(2) || '0.00'}</td>
                    <td>${data.method || 'N/A'}</td>
                    <td><span class="${statusClass}">${data.status || 'pending'}</span></td>
                    <td class="text-gray-500 text-sm">${date}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error("Error fetching withdrawal history:", error);
            document.getElementById("withdrawal-history-body").innerHTML = 
                '<tr><td colspan="4" class="text-center py-4 text-red-500">Error loading history: ' + error.message + '</td></tr>';
        }
    }
    
    // ===================== ADDED FEATURES =====================
    
    function renderMarquee() {
        const text = adminSettings.marqueeSettings[userCountry] || adminSettings.marqueeSettings['default'] || "Welcome to AdVault!";
        const marqueeElement = document.getElementById('marqueeText');
        if (marqueeElement) {
            marqueeElement.textContent = text;
            marqueeElement.style.animationDuration = `${Math.max(10, text.length / 5)}s`;
        }
    }

    function renderDynamicPaymentUI() {
        // 1. Profile Display
        const displayContainer = document.getElementById('dynamicPaymentDetailsDisplay');
        if (displayContainer) {
            displayContainer.innerHTML = '';
            
            if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
                adminSettings.paymentMethods.forEach(method => {
                    const val = userData.paymentInfo[method.id] || 'Not Set';
                    const div = document.createElement('p');
                    div.innerHTML = `<span class="font-bold">${method.name}:</span> <span class="${val === 'Not Set' ? 'text-red-500' : 'text-gray-900'}">${val}</span>`;
                    displayContainer.appendChild(div);
                });
            } else {
                displayContainer.innerHTML = `
                    <p><span class="font-bold">PayPal:</span> <span class="${!userData.paypal ? 'text-red-500' : 'text-gray-900'}">${userData.paypal || 'Not set'}</span></p>
                    <p><span class="font-bold">Payoneer:</span> <span class="${!userData.payoneer ? 'text-red-500' : 'text-gray-900'}">${userData.payoneer || 'Not set'}</span></p>
                    <p><span class="font-bold">bKash:</span> <span class="${!userData.bkash ? 'text-red-500' : 'text-gray-900'}">${userData.bkash || 'Not set'}</span></p>
                `;
            }
        }

        // 2. Dynamic Edit Modal Form
        const formContainer = document.getElementById('dynamicPaymentForm');
        if (formContainer) {
            formContainer.innerHTML = '';
            
            if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
                adminSettings.paymentMethods.forEach(method => {
                    const wrapper = document.createElement('div');
                    const type = method.type === 'number' ? 'number' : (method.type === 'email' ? 'email' : 'text');
                    wrapper.innerHTML = `
                        <label class="payment-label">${method.name}</label>
                        <input type="${type}" data-id="${method.id}" value="${userData.paymentInfo[method.id] || ''}" class="payment-input" placeholder="Enter ${method.name}">
                    `;
                    formContainer.appendChild(wrapper);
                });
            } else {
                formContainer.innerHTML = `
                    <div>
                        <label class="payment-label">PayPal Email</label>
                        <input type="email" data-id="paypal" value="${userData.paypal || ''}" class="payment-input" placeholder="Enter PayPal email">
                    </div>
                    <div>
                        <label class="payment-label">Payoneer Email</label>
                        <input type="email" data-id="payoneer" value="${userData.payoneer || ''}" class="payment-input" placeholder="Enter Payoneer email">
                    </div>
                    <div>
                        <label class="payment-label">bKash Number</label>
                        <input type="text" data-id="bkash" value="${userData.bkash || ''}" class="payment-input" placeholder="Enter bKash number">
                    </div>
                `;
            }
        }

        // 3. Update profile payment methods
        renderProfilePaymentMethods();
        // 4. Update withdrawal payment methods
        renderNewPaymentGrid();
    }
    
    // Render profile payment methods
    function renderProfilePaymentMethods() {
        const container = document.getElementById('profilePaymentMethodsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
            adminSettings.paymentMethods.forEach(method => {
                const val = userData.paymentInfo[method.id] || 'Not Set';
                const methodElement = document.createElement('div');
                methodElement.className = 'flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors';
                methodElement.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-logo-blue text-lg shadow-sm mr-4">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">${method.name}</div>
                        <div class="text-sm text-gray-500">${val}</div>
                    </div>
                    <span class="text-xs font-medium ${val !== 'Not Set' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-3 py-1 rounded-full">
                        ${val !== 'Not Set' ? 'Set' : 'Not Set'}
                    </span>
                `;
                container.appendChild(methodElement);
            });
        } else {
            // Use default payment methods
            const methods = [
                { id: 'paypal', name: 'PayPal', icon: 'fab fa-paypal', value: userData.paypal || 'Not set' },
                { id: 'payoneer', name: 'Payoneer', icon: 'fas fa-money-check', value: userData.payoneer || 'Not set' },
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', value: userData.bkash || 'Not set' }
            ];
            
            methods.forEach(method => {
                const methodElement = document.createElement('div');
                methodElement.className = 'flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors';
                methodElement.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-logo-blue text-lg shadow-sm mr-4">
                        <i class="${method.icon}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">${method.name}</div>
                        <div class="text-sm text-gray-500">${method.value}</div>
                    </div>
                    <span class="text-xs font-medium ${method.value !== 'Not set' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} px-3 py-1 rounded-full">
                        ${method.value !== 'Not set' ? 'Set' : 'Not Set'}
                    </span>
                `;
                container.appendChild(methodElement);
            });
        }
    }
    
    // Render NEW withdrawal payment methods grid
    function renderNewPaymentGrid() {
        const container = document.getElementById('new-paymentGrid');
        if (!container) return;
        
        container.innerHTML = '';
        
        let methods = [];
        
        if (adminSettings.paymentMethods && adminSettings.paymentMethods.length > 0) {
            methods = adminSettings.paymentMethods;
        } else {
            methods = [
                { id: 'bkash', name: 'bKash', icon: 'fas fa-mobile-alt', color: '#E2136E' },
                { id: 'nagad', name: 'Nagad', icon: 'fas fa-wallet', color: '#F8A01C' },
                { id: 'rocket', name: 'Rocket', icon: 'fas fa-rocket', color: '#8C34FF' },
                { id: 'paypal', name: 'PayPal', icon: 'fab fa-paypal', color: '#003087' }
            ];
        }
        
        methods.forEach(method => {
            const card = document.createElement('div');
            card.className = 'new-payment-method-card';
            card.dataset.id = method.id;
            
            const isSet = userData.paymentInfo[method.id] ? true : false;
            
            card.innerHTML = `
                <div class="new-payment-icon" style="color: ${method.color || '#2563eb'}">
                    <i class="${method.icon || 'fas fa-credit-card'}"></i>
                </div>
                <div class="font-semibold text-sm text-gray-800">${method.name}</div>
                <div class="text-xs ${isSet ? 'text-green-600' : 'text-red-400'} mt-1">
                    ${isSet ? '<i class="fas fa-check-circle"></i> Linked' : 'Not Linked'}
                </div>
            `;

            card.onclick = () => selectNewPaymentMethod(method, card);
            container.appendChild(card);
        });
    }
    
    function selectNewPaymentMethod(method, cardElement) {
        // UI Selection
        document.querySelectorAll('.new-payment-method-card').forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');
        
        currentWithdrawMethod = method.id;
        document.getElementById('new-methodError').classList.add('hidden');

        // Check details
        const detailsDiv = document.getElementById('new-selectedMethodDetails');
        const previewSpan = document.getElementById('new-sendToPreview');
        const savedInfo = userData.paymentInfo[method.id];

        if (savedInfo) {
            detailsDiv.classList.remove('hidden');
            previewSpan.innerText = savedInfo;
        } else {
            detailsDiv.classList.add('hidden');
            showTopNotification(`Please link your ${method.name} account first.`);
            openNewPaymentEditModal();
        }
        
        updateNewFeeCalculation();
    }
    
    function updateNewFeeCalculation() {
        const amount = parseFloat(document.getElementById('new-amountInput').value) || 0;
        const fee = amount * 0.02; // 2% fee
        const net = amount - fee;

        document.getElementById('new-feeDisplay').innerText = `BDT ${fee.toFixed(2)}`;
        document.getElementById('new-netAmountDisplay').innerText = `BDT ${Math.max(0, net).toFixed(2)}`;
    }
    
    function openNewPaymentEditModal() {
        const formContainer = document.getElementById('new-dynamicPaymentForm');
        formContainer.innerHTML = '';
        
        const methods = adminSettings.paymentMethods.length > 0 
            ? adminSettings.paymentMethods 
            : [
                { id: 'bkash', name: 'bKash', type: 'number' },
                { id: 'nagad', name: 'Nagad', type: 'number' },
                { id: 'rocket', name: 'Rocket', type: 'number' },
                { id: 'paypal', name: 'PayPal', type: 'email' }
              ];

        methods.forEach(method => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1">${method.name} ${method.type === 'email' ? 'Email' : 'Number'}</label>
                <input type="${method.type || 'text'}" 
                       class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white transition-colors"
                       placeholder="Enter ${method.name} details"
                       data-id="${method.id}"
                       value="${userData.paymentInfo[method.id] || ''}">
            `;
            formContainer.appendChild(div);
        });

        document.getElementById('new-dynamicPaymentEditModal').classList.add('active');
    }
    
    async function fetchNewHistory() {
        const tbody = document.getElementById('new-historyTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Loading...</td></tr>';
        
        try {
            const snapshot = await db.collection(WITHDRAWALS_COLLECTION)
                .where('userId', '==', userData.id || userData.username)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .get();
                
            tbody.innerHTML = '';
            
            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No transactions yet</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = new Date(data.timestamp).toLocaleDateString();
                // Check for both 'approved' AND 'completed'
let statusColor = (data.status === 'approved' || data.status === 'completed') ? 'text-green-600' : (data.status === 'rejected' ? 'text-red-500' : 'text-yellow-600');
                
                const row = `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 text-gray-600">${date}</td>
                        <td class="py-3 capitalize">${data.method}</td>
                        <td class="py-3 font-medium">BDT ${data.amount}</td>
                        <td class="py-3 ${statusColor} text-xs font-bold uppercase">${data.status}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4" class="text-center">Error loading history</td></tr>'; }
    }
    
    // --- Dynamic Extra Ads Rendering ---
    function renderExtraAds() {
        const container = document.getElementById('extraTasksContainer');
        const noAdsMsg = document.getElementById('noAdsMsg');
        
        if (!container) return;
        
        container.innerHTML = '';
        
        const validAds = adminSettings.adServices?.filter(s => s.active) || [];
        
        if (validAds.length === 0) {
            if (noAdsMsg) noAdsMsg.classList.remove('hidden');
            return;
        } else {
            if (noAdsMsg) noAdsMsg.classList.add('hidden');
        }

        validAds.forEach(service => {
            const card = document.createElement('div');
            card.className = "extra-earn-card content-card";
            card.innerHTML = `
                <i class="fas fa-gift gift-icon"></i>
                <div class="extra-content">
                    <h2 class="text-xl font-bold mb-1 drop-shadow-md">${service.name || 'Premium Task'}</h2>
                    <p class="text-sm mb-3 opacity-90 font-medium">Watch this for Bonus Rewards!</p>
                    <button class="btn-primary extra-earn-btn w-full shadow-lg" onclick="startSpecificAd('${service.id}')">
                        <i class="fas fa-box-open mr-2"></i> Open Gift Box
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
   // --- Dynamic Ad Popup with Timer & Smartlink Verification ---
    window.startSpecificAd = function(serviceId) {
        const service = adminSettings.adServices?.find(s => s.id === serviceId);
        if(!service) {
            showTopNotification("Ad service not available.");
            return;
        }
        
        if (maintenanceMode) {
            showTopNotification('App is under maintenance. Please try again later.');
            return;
        }
        
        if (penaltyActive) {
            showTopNotification('Please wait until the penalty timer expires to continue');
            return;
        }
        
        const overlay = document.getElementById('adOverlay');
        const container = document.getElementById('adContainer');
        const timer = document.getElementById('adHeaderTimer');
        const btn = document.getElementById('closeAdBtn');
        const prog = document.getElementById('adProgressBar');
        const spinner = document.getElementById('timerSpinner');
        const footerMsg = document.getElementById('adFooterMessage');
        
        // 1. Reset State
        container.innerHTML = '';
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-lock"></i>';
        prog.style.width = '0%';
        spinner.style.display = 'block';
        overlay.style.display = 'flex';
        
        // 2. Determine Ad Type and Setup UI
        let lockTime = service.duration || 15;
        
        if (service.type === 'smartlink') {
            // --- SMARTLINK LOGIC ---
            
            // A. Open Link in New Tab
            window.open(service.code, '_blank');
            
            // B. Show Verification UI
            footerMsg.textContent = "Verifying task... Please wait.";
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full p-6 text-center bg-gray-50">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6 relative">
                        <i class="fas fa-search-dollar text-4xl text-blue-600"></i>
                        <div class="absolute top-0 right-0 w-6 h-6 bg-yellow-400 rounded-full animate-ping"></div>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Verifying Task...</h3>
                    <p class="text-gray-600 mb-6 max-w-xs">
                        We opened the link in a new tab. <br>
                        <strong>Explore it for <span class="text-blue-600 font-bold">${lockTime} seconds</span></strong>.
                    </p>
                    <div class="bg-white p-4 rounded-xl border border-blue-100 shadow-sm w-full max-w-xs">
                        <div class="flex items-center gap-3 text-left">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-medium text-gray-700">Checking activity...</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            Do not close the new tab until verification completes.
                        </div>
                    </div>
                </div>
            `;
            
        } else {
            // --- BANNER/SCRIPT LOGIC ---
            
            footerMsg.textContent = "Stay on this page to earn reward.";
            const iframe = document.createElement('iframe');
            iframe.className = 'ad-iframe bg-white';
            container.appendChild(iframe);
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(`
                <style>body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;background:#fff;}</style>
                ${service.code || '<div style="padding: 20px; text-align: center;"><h2>Ad Content</h2></div>'}
            `);
            doc.close();
        }

        // 3. Shared Timer Logic (Handles verification for both types)
        let elapsed = 0;
        let totalTime = lockTime + 10; // Buffer

        if (adInterval) clearInterval(adInterval); // Clear any existing interval

        adInterval = setInterval(() => {
            elapsed++;
            
            // Update Progress Bar
            const pct = Math.min((elapsed / lockTime) * 100, 100);
            prog.style.width = `${pct}%`;

            if (lockTime - elapsed > 0) {
                // Counting down
                timer.textContent = `Verify: ${lockTime - elapsed}s`;
                if(service.type === 'smartlink') {
                     footerMsg.textContent = `Keep browsing... ${lockTime - elapsed}s remaining`;
                }
            } else {
                // Success / Unlocking
                timer.textContent = "VERIFIED";
                timer.className = "font-bold text-green-400 text-sm";
                spinner.style.display = 'none';
                footerMsg.textContent = "Task Verified! Tap the X button to claim.";
                
                if(!btn.classList.contains('active')) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-check"></i>'; // Change lock to checkmark
                    
                    // Add pulse effect to the button to draw attention
                    btn.style.animation = "pulse 1.5s infinite";
                    const style = document.createElement('style');
                    style.innerHTML = `@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }`;
                    document.head.appendChild(style);
                }
            }

            // Auto-close safety (Stop timer only)
            if (elapsed >= totalTime + 60) { 
                clearInterval(adInterval);
            }
        }, 1000);

        // 4. Close & Reward Handler
        btn.onclick = async () => {
            if(!btn.classList.contains('active')) return;
            
            clearInterval(adInterval);
            overlay.style.display = 'none';
            btn.style.animation = "none";
            
            // Give Reward
            const bonus = service.reward || 0.10;
            userData.balance += bonus;
            userData.totalEarnings += bonus;
            
            // Save to Firebase
            try {
                await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({
                    balance: userData.balance,
                    totalEarnings: userData.totalEarnings
                });
                updateUI();
                showSuccessPopup(`ðŸŽ‰ Verified! ${bonus.toFixed(2)} BDT Added!`);
            } catch(e) {
                console.error("Reward Save Error", e);
                showTopNotification("Failed to save bonus reward");
            }
        };
    };
    
    async function saveDynamicPaymentInfo() {
        const inputs = document.querySelectorAll('#dynamicPaymentForm input');
        const newInfo = {};
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            if (input.value.trim()) newInfo[id] = input.value.trim();
        });

        userData.paymentInfo = newInfo;
        
        // Update original payment fields for backward compatibility
        if (newInfo.paypal) userData.paypal = newInfo.paypal;
        if (newInfo.payoneer) userData.payoneer = newInfo.payoneer;
        if (newInfo.bkash) userData.bkash = newInfo.bkash;
        
        const btn = document.getElementById('saveDynamicPaymentBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        try {
            await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({ 
                paymentInfo: newInfo,
                paypal: userData.paypal,
                payoneer: userData.payoneer,
                bkash: userData.bkash
            });
            
            renderDynamicPaymentUI();
            updateUI();
            showTopNotification("Payment information updated!");
            
            // Close modal
            document.getElementById('dynamicPaymentEditModal').classList.remove('show');
            setTimeout(() => {
                document.getElementById('dynamicPaymentEditModal').style.display = 'none';
            }, 300);
        } catch (error) {
            console.error("Error saving payment info:", error);
            showTopNotification("Failed to save payment information");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }
    
    async function saveNewDynamicPaymentInfo() {
        const inputs = document.querySelectorAll('#new-dynamicPaymentForm input');
        const newInfo = {};
        
        inputs.forEach(input => {
            const id = input.getAttribute('data-id');
            if (input.value.trim()) newInfo[id] = input.value.trim();
        });

        userData.paymentInfo = { ...userData.paymentInfo, ...newInfo };
        
        const btn = document.getElementById('new-saveDynamicPaymentBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        try {
            await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({ 
                paymentInfo: userData.paymentInfo
            });
            
            renderProfilePaymentMethods();
            renderNewPaymentGrid();
            updateUI();
            showTopNotification("Payment information updated!");
            
            // Close modal
            document.getElementById('new-dynamicPaymentEditModal').classList.remove('active');
        } catch (error) {
            console.error("Error saving payment info:", error);
            showTopNotification("Failed to save payment information");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    // ===================== HELPER FUNCTIONS =====================

    function initTelegram() {
        return new Promise((resolve) => {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                resolve(true);
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-web-app.js';
            
            script.onload = () => {
                if (window.Telegram?.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    resolve(true);
                } else {
                    resolve(false);
                }
            };
            
            script.onerror = () => {
                resolve(false);
            };
            
            document.head.appendChild(script);
        });
    }

    function getTelegramUserData() {
        try {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                return {
                    id: user.id ? user.id.toString() : "",
                    name: [user.first_name, user.last_name].filter(Boolean).join(" "),
                    username: user.username ? `@${user.username}` : user.first_name,
                    photoUrl: user.photo_url || null
                };
            }
            
            if (window.Telegram?.WebApp?.initData) {
                const params = new URLSearchParams(Telegram.WebApp.initData);
                const userJson = params.get('user');
                if (userJson) {
                    const user = JSON.parse(userJson);
                    return {
                        id: user.id ? user.id.toString() : "",
                        name: [user.first_name, user.last_name].filter(Boolean).join(" "),
                        username: user.username ? `@${user.username}` : user.first_name,
                        photoUrl: user.photo_url || null
                    };
                }
            }
        } catch (e) {
            console.error("Error getting Telegram user data:", e);
        }
        return null;
    }

    function generateUsername() {
        return `User${Math.floor(1000 + Math.random() * 9000)}`;
    }

    function showEditNotification() {
        const banner = document.getElementById("androidTopNotification");
        if (!banner) return;
        
        banner.textContent = "To edit payment information, please go to the Profile section and use the Edit button";
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), 3000);
    }

    function isValidEmail(email) {
        if (!email) return false;
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function isValidBkash(number) {
        if (!number) return false;
        return /^(?:\+?88)?01[3-9]\d{8}$/.test(number);
    }

    function showTopNotification(message, duration = 3000) {
        const banner = document.getElementById("androidTopNotification");
        if (!banner) return;
        
        banner.textContent = message;
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), duration);
    }

    function showSuccessPopup(message = "Success!") {
        const popup = document.getElementById("successPopup");
        if (!popup) return;
        
        const checkmarkWrapper = popup.querySelector('.checkmark-wrapper');
        if (checkmarkWrapper) {
            const svg = checkmarkWrapper.innerHTML;
            checkmarkWrapper.innerHTML = '';
            setTimeout(() => {
                checkmarkWrapper.innerHTML = svg;
            }, 10);
        }
        
        document.getElementById("successMessage").textContent = message;
        popup.classList.remove("hidden");
        popup.classList.add("show");
        
        setTimeout(() => {
            popup.classList.remove("show");
            setTimeout(() => {
                popup.classList.add("hidden");
            }, 300);
        }, 2000);
    }
    
    function updateUI() {
        // Update header
        if (document.getElementById('header-username')) {
            document.getElementById('header-username').textContent = userData.username;
            document.getElementById('header-balance').textContent = `BDT ${userData.balance.toFixed(2)}`;
        }

        // Update home section
        if (document.getElementById('home-earnings-val')) {
            document.getElementById('home-earnings-val').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            document.getElementById('home-ads-val').textContent = userData.adsWatched;
        }

        // Update earn section
        if (document.getElementById('earn-completed')) {
            const remaining = userData.totalTasks - userData.completedTasks;
            document.getElementById('earn-completed').textContent = userData.completedTasks;
            document.getElementById('earn-remaining').textContent = remaining;
            const progressPercent = (userData.completedTasks / userData.totalTasks) * 100;
            document.getElementById('earn-progress-bar').style.width = `${progressPercent}%`;
        }

        // Update NEW withdraw section
        if (document.getElementById('new-withdraw-balance-display')) {
            document.getElementById('new-withdraw-balance-display').textContent = `BDT ${userData.balance.toFixed(2)}`;
            document.getElementById('new-withdraw-total-earn').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            document.getElementById('new-withdraw-total-out').textContent = `BDT ${userData.totalWithdrawn.toFixed(2)}`;
        }

        // Update profile section
        if (document.getElementById('profileName')) {
            document.getElementById('profileName').textContent = userData.name || "Not available";
            document.getElementById('profileUsername').textContent = userData.username;
            document.getElementById('profileId').textContent = userData.id || "Not available";
            document.getElementById('profileSource').textContent = userData.source === 'telegram' ? 'Telegram' : 'Web';
            document.getElementById('profileBalance').textContent = `BDT ${userData.balance.toFixed(2)}`;
            document.getElementById('profileEarnings').textContent = `BDT ${userData.totalEarnings.toFixed(2)}`;
            document.getElementById('profileAds').textContent = userData.adsWatched;
            document.getElementById('profileReferrals').textContent = userData.referrals || 0;
            document.getElementById('profileWithdrawn').textContent = `BDT ${userData.totalWithdrawn.toFixed(2)}`;
            
            // Format join date
            if (userData.joinDate) {
                const joinDate = new Date(userData.joinDate);
                const formattedDate = joinDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: 'numeric' 
                });
                document.getElementById('profileJoinDate').textContent = `Joined: ${formattedDate}`;
            }
        }
        
        // Update Telegram indicator
        const telegramIndicator = document.getElementById('telegramIndicator');
        if (telegramIndicator) {
            telegramIndicator.style.display = userData.telegramDetected ? 'flex' : 'none';
        }
        
        // Update profile images
        updateProfileImages();
        
        // Update payment information display
        renderProfilePaymentMethods();
        
        // Update build number
        if (document.getElementById('buildNumber')) {
            document.getElementById('buildNumber').textContent = "AV20250902";
        }
    }
    
    function updateProfileImages() {
        const profileContainer = document.getElementById('profileImageContainer');
        const headerContainer = document.getElementById('headerProfileImage');
        
        if (!profileContainer || !headerContainer) return;
        
        // Clear containers
        profileContainer.innerHTML = '';
        headerContainer.innerHTML = '';
        
        if (userData.profilePhoto) {
            // Profile image in profile section
            const profileImg = document.createElement('img');
            profileImg.src = userData.profilePhoto;
            profileImg.alt = "Profile photo";
            profileImg.className = "w-full h-full rounded-full object-cover";
            profileContainer.appendChild(profileImg);
            
            // Header image
            const headerImg = document.createElement('img');
            headerImg.src = userData.profilePhoto;
            headerImg.alt = "Profile photo";
            headerImg.className = "profile-header-image";
            headerContainer.appendChild(headerImg);
        } else {
            // Profile placeholder in profile section
            const profilePlaceholder = document.createElement('div');
            profilePlaceholder.className = "w-full h-full rounded-full flex items-center justify-center";
            profilePlaceholder.innerHTML = '<i class="fas fa-user text-white text-3xl"></i>';
            profileContainer.appendChild(profilePlaceholder);
            
            // Header placeholder
            const headerPlaceholder = document.createElement('div');
            headerPlaceholder.className = "profile-header-placeholder";
            headerPlaceholder.innerHTML = '<i class="fas fa-user"></i>';
            headerContainer.appendChild(headerPlaceholder);
        }
    }

    function checkDailyReset() {
        const today = new Date().toISOString().slice(0, 10);
        if (userData.lastResetDate !== today) {
            userData.completedTasks = 0;
            userData.lastResetDate = today;
            saveUserData();
        }
    }

    function showSection(targetId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        
        const targetSection = document.getElementById(targetId);
        const targetNavItem = document.querySelector(`.nav-item[data-target="${targetId}"]`);
        
        if (targetSection) targetSection.classList.add('active');
        if (targetNavItem) targetNavItem.classList.add('active');
        
        // Show/hide header based on section
        const hideHeaderSections = ['profile-section', 'withdraw-section', 'withdrawal-history-section'];
        const showHeaderSections = ['home-section', 'earn-section'];
        
        if (hideHeaderSections.includes(targetId)) {
            document.body.classList.add('header-hidden');
        } else if (showHeaderSections.includes(targetId)) {
            document.body.classList.remove('header-hidden');
        }
        
        // If showing profile section, update the profile data
        if (targetId === 'profile-section') {
            updateUI();
        }
        
        // If showing NEW withdraw section, update payment methods
        if (targetId === 'withdraw-section') {
            renderNewPaymentGrid();
            updateNewFeeCalculation();
        }
        
        // If showing history section, fetch history
        if (targetId === 'withdrawal-history-section') {
            fetchWithdrawalHistory();
        }
    }

    async function loadAdSDK() {
        return new Promise((resolve, reject) => {
            if (typeof show_9661177 === 'function') {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = 'https://libtl.com/sdk.js';
            
            const timeout = setTimeout(() => {
                reject(new Error('Ad SDK loading timed out'));
                script.remove();
            }, 15000);

            script.onload = () => {
                clearTimeout(timeout);
                if (typeof show_9661177 === 'function') {
                    resolve();
                } else {
                    reject(new Error('Ad SDK function not found'));
                }
            };

            script.onerror = () => {
                clearTimeout(timeout);
                reject(new Error('Failed to load ad SDK'));
            };

            document.head.appendChild(script);
        });
    }
    
    async function detectCountry() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return data.country;
        } catch (error) {
            console.error('Country detection failed:', error);
            return 'BD';
        }
    }
    
    function setCountryFlag(country) {
        const flagElement = document.getElementById('country-flag');
        if (!flagElement) return;
        
        const flagMap = {
    // --- South Asia ---
    'BD': 'ðŸ‡§ðŸ‡©', 'IN': 'ðŸ‡®ðŸ‡³', 'PK': 'ðŸ‡µðŸ‡°', 'LK': 'ðŸ‡±ðŸ‡°', 'NP': 'ðŸ‡³ðŸ‡µ', 'MV': 'ðŸ‡²ðŸ‡»',
    
    // --- North America ---
    'US': 'ðŸ‡ºðŸ‡¸', 'CA': 'ðŸ‡¨ðŸ‡¦', 'MX': 'ðŸ‡²ðŸ‡½',
    
    // --- Europe ---
    'GB': 'ðŸ‡¬ðŸ‡§', 'DE': 'ðŸ‡©ðŸ‡ª', 'FR': 'ðŸ‡«ðŸ‡·', 'IT': 'ðŸ‡®ðŸ‡¹', 'ES': 'ðŸ‡ªðŸ‡¸', 
    'NL': 'ðŸ‡³ðŸ‡±', 'BE': 'ðŸ‡§ðŸ‡ª', 'CH': 'ðŸ‡¨ðŸ‡­', 'SE': 'ðŸ‡¸ðŸ‡ª', 'NO': 'ðŸ‡³ðŸ‡´', 
    'DK': 'ðŸ‡©ðŸ‡°', 'FI': 'ðŸ‡«ðŸ‡®', 'PT': 'ðŸ‡µðŸ‡¹', 'PL': 'ðŸ‡µðŸ‡±', 'UA': 'ðŸ‡ºðŸ‡¦', 
    'RU': 'ðŸ‡·ðŸ‡º', 'TR': 'ðŸ‡¹ðŸ‡·', 'RO': 'ðŸ‡·ðŸ‡´', 'GR': 'ðŸ‡¬ðŸ‡·', 'AT': 'ðŸ‡¦ðŸ‡¹', 
    'IE': 'ðŸ‡®ðŸ‡ª', 'CZ': 'ðŸ‡¨ðŸ‡¿', 'HU': 'ðŸ‡­ðŸ‡º',
    
    // --- Middle East ---
    'SA': 'ðŸ‡¸ðŸ‡¦', 'AE': 'ðŸ‡¦ðŸ‡ª', 'QA': 'ðŸ‡¶ðŸ‡¦', 'KW': 'ðŸ‡°ðŸ‡¼', 'OM': 'ðŸ‡´ðŸ‡²', 
    'BH': 'ðŸ‡§ðŸ‡­', 'IL': 'ðŸ‡®ðŸ‡±', 'JO': 'ðŸ‡¯ðŸ‡´', 'LB': 'ðŸ‡±ðŸ‡§', 'EG': 'ðŸ‡ªðŸ‡¬',

    // --- Southeast & East Asia ---
    'CN': 'ðŸ‡¨ðŸ‡³', 'JP': 'ðŸ‡¯ðŸ‡µ', 'KR': 'ðŸ‡°ðŸ‡·', 'TW': 'ðŸ‡¹ðŸ‡¼', 'HK': 'ðŸ‡­ðŸ‡°',
    'SG': 'ðŸ‡¸ðŸ‡¬', 'MY': 'ðŸ‡²ðŸ‡¾', 'ID': 'ðŸ‡®ðŸ‡©', 'TH': 'ðŸ‡¹ðŸ‡­', 'VN': 'ðŸ‡»ðŸ‡³', 
    'PH': 'ðŸ‡µðŸ‡­', 'KH': 'ðŸ‡°ðŸ‡­', 'MM': 'ðŸ‡²ðŸ‡²',
    
    // --- Oceania ---
    'AU': 'ðŸ‡¦ðŸ‡º', 'NZ': 'ðŸ‡³ðŸ‡¿', 'FJ': 'ðŸ‡«ðŸ‡¯',
    
    // --- South America ---
    'BR': 'ðŸ‡§ðŸ‡·', 'AR': 'ðŸ‡¦ðŸ‡·', 'CO': 'ðŸ‡¨ðŸ‡´', 'CL': 'ðŸ‡¨ðŸ‡±', 'PE': 'ðŸ‡µðŸ‡ª', 
    'VE': 'ðŸ‡»ðŸ‡ª', 'UY': 'ðŸ‡ºðŸ‡¾',
    
    // --- Africa ---
    'ZA': 'ðŸ‡¿ðŸ‡¦', 'NG': 'ðŸ‡³ðŸ‡¬', 'KE': 'ðŸ‡°ðŸ‡ª', 'GH': 'ðŸ‡¬ðŸ‡­', 'MA': 'ðŸ‡²ðŸ‡¦', 
    'DZ': 'ðŸ‡©ðŸ‡¿', 'TN': 'ðŸ‡¹ðŸ‡³', 'UG': 'ðŸ‡ºðŸ‡¬', 'TZ': 'ðŸ‡¹ðŸ‡¿'
};
        
        flagElement.textContent = flagMap[country] || '';
    }

    function applyPenalty() {
        const penaltyEnabled = adminSettings.enablePenalty !== false;
        if (!penaltyEnabled) return;
        
        penaltyActive = true;
        penaltyEndTime = Date.now() + (adminSettings.penaltyDuration || 2) * 60000;
        
        localStorage.setItem('penaltyEndTime', penaltyEndTime.toString());
        
        const startEarningAd = document.getElementById('startEarningAd');
        if (startEarningAd) {
            startEarningAd.disabled = true;
            startEarningAd.classList.add('btn-penalty');
        }
        
        const penaltyWarningCard = document.getElementById('penaltyWarningCard');
        if (penaltyWarningCard) {
            penaltyWarningCard.style.display = 'block';
        }
        
        penaltyInterval = setInterval(updatePenaltyTimer, 1000);
        updatePenaltyTimer();
    }
    
    function updatePenaltyTimer() {
        const now = Date.now();
        const remaining = Math.max(0, penaltyEndTime - now);
        
        if (remaining <= 0) {
            clearPenalty();
            return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        const adButtonText = document.getElementById('adButtonText');
        if (adButtonText) {
            adButtonText.innerHTML = `Wait ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    function clearPenalty() {
        penaltyActive = false;
        clearInterval(penaltyInterval);
        
        localStorage.removeItem('penaltyEndTime');
        
        const startEarningAd = document.getElementById('startEarningAd');
        const adButtonText = document.getElementById('adButtonText');
        if (startEarningAd && adButtonText) {
            startEarningAd.disabled = false;
            startEarningAd.classList.remove('btn-penalty');
            adButtonText.textContent = 'Start Ad Task';
        }
        
        const penaltyWarningCard = document.getElementById('penaltyWarningCard');
        if (penaltyWarningCard) {
            penaltyWarningCard.style.display = 'none';
        }
    }
    
    function checkExistingPenalty() {
        const savedPenaltyEndTime = localStorage.getItem('penaltyEndTime');
        if (savedPenaltyEndTime) {
            const remaining = parseInt(savedPenaltyEndTime) - Date.now();
            if (remaining > 0) {
                penaltyEndTime = parseInt(savedPenaltyEndTime);
                applyPenalty();
            } else {
                localStorage.removeItem('penaltyEndTime');
            }
        }
    }
    
    function startAdTimer() {
        adStartTime = Date.now();
        clearInterval(adTimerInterval);
        
        adTimerInterval = setInterval(() => {
            const elapsed = Date.now() - adStartTime;
            if (elapsed >= (adminSettings.adDuration || 15) * 1000) {
                clearInterval(adTimerInterval);
            }
        }, 1000);
    }
    
    function checkAdCompletion() {
        const elapsed = Date.now() - adStartTime;
        clearInterval(adTimerInterval);
        
        const requiredDuration = (adminSettings.adDuration || 15) * 1000;
        if (elapsed < requiredDuration) {
            applyPenalty();
            showTopNotification(`Warning: Please watch ads for full ${adminSettings.adDuration || 15} seconds to earn rewards`, 5000);
            return false;
        }
        return true;
    }

    function showInstructionsPopup() {
        const popup = document.getElementById('instructionsPopup');
        if (popup) {
            popup.style.display = 'flex';
        }
    }

    function hideInstructionsPopup() {
        const popup = document.getElementById('instructionsPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    // ===================== EVENT LISTENERS =====================
    function setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => showSection(item.dataset.target));
        });

        // Earn Now button
        const earnNowBtn = document.getElementById('earnNowBtn');
        if (earnNowBtn) {
            earnNowBtn.addEventListener('click', () => showSection('earn-section'));
        }

        // Start Ad Task button
        const startEarningAd = document.getElementById('startEarningAd');
        const adButtonText = document.getElementById('adButtonText');
        if (startEarningAd) {
            startEarningAd.addEventListener('click', async () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                
                if (penaltyActive) {
                    showTopNotification('Please wait until the penalty timer expires to continue');
                    return;
                }
                
                if (userData.completedTasks >= userData.totalTasks) {
                    showTopNotification('All tasks completed for today!');
                    return;
                }

                startEarningAd.disabled = true;
                adButtonText.innerHTML = '<div class="spinner"></div> Loading ad...';
                
                try {
                    await loadAdSDK();
                    startAdTimer();
                    await show_9661177();
                    
                    if (!checkAdCompletion()) {
                        return;
                    }
                    
                    const earnings = adminSettings.earningsPerAd || 0.05;
                    userData.balance += earnings;
                    userData.totalEarnings += earnings;
                    userData.adsWatched++;
                    userData.completedTasks++;
                    
                    await saveUserData();
                    updateUI();
                    showTopNotification(`Earned ${earnings.toFixed(2)} BDT!`);
                    
                } catch (error) {
                    console.error("Ad error:", error);
                    showTopNotification('Ad failed: ' + error.message);
                } finally {
                    if (!penaltyActive) {
                        startEarningAd.disabled = false;
                        adButtonText.textContent = 'Start Ad Task';
                    }
                }
            });
        }
        
        // NEW Withdraw form
        const newWithdrawForm = document.getElementById('new-withdrawForm');
        if (newWithdrawForm) {
            newWithdrawForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                
                const amount = parseFloat(document.getElementById('new-amountInput').value);
                const method = currentWithdrawMethod;
                
                // Validation
                if (!method) {
                    document.getElementById('new-methodError').classList.remove('hidden');
                    return;
                }
                if (!amount || amount < adminSettings.minWithdrawal || amount > userData.balance) {
                    document.getElementById('new-amountError').classList.remove('hidden');
                    showTopNotification(`Min withdraw: ${adminSettings.minWithdrawal}, Max: ${userData.balance}`);
                    return;
                }
                if (!userData.paymentInfo[method]) {
                    showTopNotification(`Please set ${method} details first`);
                    openNewPaymentEditModal();
                    return;
                }

                // Processing
                try {
                    const btn = e.target.querySelector('button[type="submit"]');
                    const oldText = btn.innerHTML;
                    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                    await db.collection(WITHDRAWALS_COLLECTION).add({
                        userId: userData.id || userData.username,
                        username: userData.username,
                        amount: amount,
                        method: method,
                        address: userData.paymentInfo[method],
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    });

                    userData.balance -= amount;
                    userData.totalWithdrawn += amount;
                    await saveUserData();
                    
                    updateUI();
                    btn.disabled = false; btn.innerHTML = oldText;
                    document.getElementById('new-amountInput').value = '';
                    updateNewFeeCalculation();
                    
                    document.getElementById('new-successModal').classList.add('active');
                } catch(err) {
                    console.error(err);
                    showTopNotification('Error processing request');
                    btn.disabled = false; btn.innerHTML = oldText;
                }
            });
        }

        // NEW Withdraw Amount Logic
        const amountInput = document.getElementById('new-amountInput');
        if (amountInput) {
            amountInput.addEventListener('input', updateNewFeeCalculation);
        }
        
        document.querySelectorAll('.new-amount-option').forEach(btn => {
            btn.addEventListener('click', () => {
                if(btn.id === 'new-maxAmountBtn') {
                    amountInput.value = userData.balance.toFixed(2);
                } else {
                    amountInput.value = btn.dataset.amt;
                }
                updateNewFeeCalculation();
            });
        });

        // Dynamic payment edit button
        const editDynamicPaymentBtn = document.getElementById('editDynamicPaymentBtn');
        const dynamicPaymentModal = document.getElementById('dynamicPaymentEditModal');
        const closeDynamicPaymentModal = document.getElementById('closeDynamicPaymentModal');
        const saveDynamicPaymentBtn = document.getElementById('saveDynamicPaymentBtn');
        
        if (editDynamicPaymentBtn && dynamicPaymentModal && saveDynamicPaymentBtn) {
            editDynamicPaymentBtn.addEventListener('click', () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                
                renderDynamicPaymentUI();
                dynamicPaymentModal.style.display = 'flex';
                setTimeout(() => {
                    dynamicPaymentModal.classList.add('show');
                }, 10);
            });

            saveDynamicPaymentBtn.addEventListener('click', async () => {
                await saveDynamicPaymentInfo();
            });
        }

        // Close dynamic payment modal
        if (closeDynamicPaymentModal) {
            closeDynamicPaymentModal.addEventListener('click', function() {
                const modal = document.getElementById('dynamicPaymentEditModal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                }
            });
        }
        
        // NEW Payment Modals
        document.getElementById('new-editPaymentFromWithdraw').addEventListener('click', openNewPaymentEditModal);
        document.getElementById('new-closeDynamicPaymentModal').addEventListener('click', () => document.getElementById('new-dynamicPaymentEditModal').classList.remove('active'));
        document.getElementById('new-saveDynamicPaymentBtn').addEventListener('click', async () => {
            await saveNewDynamicPaymentInfo();
        });

        // Invite friends
        const inviteFriendsBtn = document.getElementById('inviteFriendsBtn');
        if (inviteFriendsBtn) {
            inviteFriendsBtn.addEventListener('click', () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                showTopNotification('Invite feature coming soon!');
            });
        }
        
        // NEW History Toggles
        document.getElementById('new-toggleHistoryBtn').addEventListener('click', () => {
            document.getElementById('new-withdrawInputs').classList.add('hidden');
            document.getElementById('new-withdrawHistoryView').classList.remove('hidden');
            fetchNewHistory();
        });
        
        document.getElementById('new-backToWithdrawInput').addEventListener('click', () => {
            document.getElementById('new-withdrawHistoryView').classList.add('hidden');
            document.getElementById('new-withdrawInputs').classList.remove('hidden');
        });
        
        // View withdrawal history button
        const viewWithdrawalHistoryBtn = document.getElementById('viewWithdrawalHistoryBtn');
        if (viewWithdrawalHistoryBtn) {
            viewWithdrawalHistoryBtn.addEventListener('click', () => {
                if (maintenanceMode) {
                    showTopNotification('App is under maintenance. Please try again later.');
                    return;
                }
                showSection('withdrawal-history-section');
                fetchWithdrawalHistory();
            });
        }
        
        // Telegram warning popup buttons
        const telegramWarningOk = document.getElementById('telegramWarningOk');
        const telegramWarningGo = document.getElementById('telegramWarningGo');
        
        if (telegramWarningOk) {
            telegramWarningOk.addEventListener('click', () => {
                document.getElementById('telegramWarningPopup').style.display = 'none';
            });
        }
        
        if (telegramWarningGo) {
            telegramWarningGo.addEventListener('click', () => {
                window.open('https://t.me/AdVault_2bot', '_blank');
                document.getElementById('telegramWarningPopup').style.display = 'none';
            });
        }
        
        // Add this in your initApp function or in a script tag
function checkFontAwesomeLoaded() {
    const styleSheets = Array.from(document.styleSheets);
    const fontAwesomeLoaded = styleSheets.some(sheet => {
        try {
            return sheet.href && sheet.href.includes('font-awesome');
        } catch(e) {
            return false;
        }
    });
    
    if (!fontAwesomeLoaded) {
        console.warn('Font Awesome not loaded, loading now...');
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(link);
    }
}

// Call this function in your initApp
checkFontAwesomeLoaded();
        // Instructions popup buttons
        const showInstructions = document.getElementById('showInstructions');
        const closeInstructions = document.getElementById('closeInstructions');
        const instructionsCloseBtn = document.getElementById('instructionsCloseBtn');
        
        if (showInstructions) {
            showInstructions.addEventListener('click', showInstructionsPopup);
        }
        
        if (closeInstructions) {
            closeInstructions.addEventListener('click', hideInstructionsPopup);
        }
        
        if (instructionsCloseBtn) {
            instructionsCloseBtn.addEventListener('click', hideInstructionsPopup);
        }
        
        // Maintenance popup refresh button
        const refreshMaintenanceBtn = document.getElementById('refreshMaintenanceBtn');
        if (refreshMaintenanceBtn) {
            refreshMaintenanceBtn.addEventListener('click', () => {
                location.reload();
            });
        }
        
        // Refresh balance button
        const refreshBalance = document.getElementById('refreshBalance');
        if (refreshBalance) {
            refreshBalance.addEventListener('click', () => {
                updateUI();
                showTopNotification('Balance refreshed!');
            });
        }
    }

/* ================= Notification System Logic ================= */

let unsubscribeNotifications = null;

// 1. Real-time Listener (Efficient: Only downloads 1 doc to check status)
function setupNotificationListener() {
    // If we have a listener already, don't create another
    if (unsubscribeNotifications) return;

    const lastCheck = userData.lastNotificationCheck || new Date(0).toISOString();
    
    // Query: Get notifications newer than the user's last check
    // Limit(1) ensures we don't download everything, saving Firebase costs
    const q = db.collection("adv2_notifications") // Ensure this collection exists in Firebase
        .where("createdAt", ">", lastCheck)
        .orderBy("createdAt", "desc")
        .limit(1);

    unsubscribeNotifications = q.onSnapshot((snapshot) => {
        const dot = document.getElementById("notificationDot");
        if (dot) {
            // Show red dot if snapshot is not empty
            if (!snapshot.empty) {
                dot.classList.remove("hidden");
            } else {
                dot.classList.add("hidden");
            }
        }
    });
}

// 2. Open Modal & Load Full List
async function openNotificationsModal() {
    const modal = document.getElementById("notificationModal");
    const listEl = document.getElementById("notificationList");
    
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    
    listEl.innerHTML = '<div class="flex justify-center py-10"><div class="spinner border-gray-400"></div></div>';

    try {
        const snapshot = await db.collection("adv2_notifications")
            .orderBy("createdAt", "desc")
            .limit(20) // Load last 20 notifications
            .get();

        listEl.innerHTML = "";

        if (snapshot.empty) {
            listEl.innerHTML = `
                <div class="text-center py-10 text-gray-400">
                    <i class="far fa-bell-slash text-4xl mb-3"></i>
                    <p>No notifications yet</p>
                </div>`;
        } else {
            snapshot.forEach(doc => {
                const data = doc.data();
                // Improved Date Formatting
                let dateStr = "Recent";
                if (data.createdAt) {
                    const dateObj = new Date(data.createdAt); // Works with ISO strings
                    dateStr = dateObj.toLocaleString('en-US', { 
                        month: 'short', day: 'numeric', 
                        hour: 'numeric', minute: '2-digit', hour12: true 
                    });
                }

                const item = document.createElement("div");
                item.className = "bg-gray-50 p-4 rounded-xl border border-gray-100 hover:bg-white hover:shadow-sm transition-all";
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-bold text-gray-800 text-sm">${data.title || 'Notification'}</h4>
                        <span class="text-xs text-gray-400 whitespace-nowrap ml-2">${dateStr}</span>
                    </div>
                    <p class="text-sm text-gray-600 leading-relaxed">${data.message || ''}</p>
                `;
                listEl.appendChild(item);
            });
        }

        // 3. Mark as Read (Update user profile)
        const nowISO = new Date().toISOString();
        await db.collection(USERS_COLLECTION).doc(userData.id || userData.username).update({
            lastNotificationCheck: nowISO
        });
        
        userData.lastNotificationCheck = nowISO;
        
        // Hide the dot immediately
        document.getElementById("notificationDot").classList.add("hidden");

    } catch (error) {
        console.error("Error loading notifications:", error);
        listEl.innerHTML = '<p class="text-center text-red-500 py-4">Failed to load notifications.</p>';
    }
}

// Make it global using window
// EXPOSE TO WINDOW so the button click always works
window.closeNotificationsModal = function() {
    const modal = document.getElementById("notificationModal");
    if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }
};

// Add a direct click listener just in case HTML onclick fails
document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.getElementById("closeNotificationBtn");
    if (closeBtn) {
        closeBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            window.closeNotificationsModal();
        });
    }
});

// Ensure the Red Dot listener uses the correct default if data is missing
function setupNotificationListener() {
    if (unsubscribeNotifications) return;

    // Use 1970 (Date(0)) as fallback if user has no history
    const lastCheck = userData.lastNotificationCheck || new Date(0).toISOString();
    
    const q = db.collection("adv2_notifications")
        .where("createdAt", ">", lastCheck)
        .orderBy("createdAt", "desc")
        .limit(1);

    unsubscribeNotifications = q.onSnapshot((snapshot) => {
        const dot = document.getElementById("notificationDot");
        if (dot) {
            if (!snapshot.empty) {
                dot.classList.remove("hidden");
            } else {
                dot.classList.add("hidden");
            }
        }
    });
}

// OPTIONAL: Add this to close the modal when clicking the dark background
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById("notificationModal");
    if (modal) {
        modal.addEventListener('click', (e) => {
            // Close if clicking the dark overlay (not the white box)
            if (e.target === modal) {
                window.closeNotificationsModal();
            }
        });
    }
});
    // ===================== INITIALIZE APP =====================
    async function initApp() {
        document.getElementById('header-username').textContent = "Loading...";
        
        checkExistingPenalty();
        await loadAdminSettings();
        setupAdminSettingsListener();
        
        const isTelegram = await initTelegram();
        let telegramUserData = null;
        let telegramDetected = false;
        
        if (isTelegram) {
            telegramUserData = getTelegramUserData();
            telegramDetected = !!telegramUserData;
        }
        
        if (!telegramDetected) {
            document.getElementById('telegramWarningPopup').style.display = 'flex';
        }
        
        if (telegramUserData) {
            document.getElementById('telegramConnected').style.display = 'block';
            setTimeout(() => {
                document.getElementById('telegramConnected').style.display = 'none';
            }, 3000);
            
            userData.id = telegramUserData.id;
            userData.name = telegramUserData.name;
            userData.username = telegramUserData.username;
            userData.telegramDetected = true;
            userData.source = "telegram";
            
            if (telegramUserData.photoUrl) {
                userData.profilePhoto = telegramUserData.photoUrl;
            }
            
            showTopNotification(`Welcome ${telegramUserData.username}!`);
            await loadUserData(userData.id);
        }
        
        if (!userData.username) {
            userData.username = generateUsername();
            userData.source = "web";
            await loadUserData(userData.username);
        }
        
        updateUI();
        userCountry = await detectCountry();
        setCountryFlag(userCountry);
        checkDailyReset();
        setupEventListeners();
        // Add this inside setupEventListeners() or initApp()
const closeBtn = document.getElementById("closeNotificationBtn");
if (closeBtn) {
    closeBtn.addEventListener("click", window.closeNotificationsModal);
}
        if (userData.id || userData.username) {
        setupNotificationListener(); // <--- Add this line here
    }
        showSection('home-section');
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
